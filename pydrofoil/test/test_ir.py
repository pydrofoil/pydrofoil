import pytest

from pydrofoil import parse
from pydrofoil.types import *
from pydrofoil.ir import *

class FakeCodeGen:
    builtin_names = {"zz5izDzKz5i64": "int_to_int64", "zz5i64zDzKz5i": "int64_to_int"}
    inlinable_functions = {}
    specialization_functions = {}
    method_graphs_by_name = {}
    inline_dependencies = defaultdict(set)

    def print_debug_msg(*args):
        pass

    def get_effects(self, function_name):
        return None

fakecodegen = FakeCodeGen()

def check_optimize(graph, expected, fakecodegen=fakecodegen):
    res = optimize(graph, fakecodegen)
    assert res
    compare(graph, expected)

def compare(graph, expected):
    res = print_graph_construction(graph)
    expected = expected.strip()
    got = "\n".join(res)
    if got != expected:
        print "EXPECTED:"
        print "_" * 60
        print expected
        print "GOT:"
        print "_" * 60
        print got
    assert got == expected


def make_bits_to_bool():
    zb = Argument('zb', SmallFixedBitVector(1))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    i1 = block0.emit(Cast, '$cast', [zb], GenericBitVector(), '`1 14:2-14:5', 'zz43')
    i2 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b1, resolved_type=SmallFixedBitVector(1))], GenericBitVector(), '`1 14:2-14:5', 'zz44')
    i3 = block0.emit(Operation, 'zeq_bits', [i1, i2], Bool(), '`1 14:2-14:5', 'zz42')
    i4 = block0.emit(Operation, '@not', [i3], Bool(), '`1 13:27-16:1', None)
    block0.next = ConditionalGoto(i4, block4, block1, '`1 13:27-16:1')
    block1.next = Goto(block2, None)
    block2.next = Goto(block3, None)
    i5 = block3.emit_phi([block2, block5], [BooleanConstant.TRUE, BooleanConstant.FALSE], Bool())
    block3.next = Return(i5, None)
    block4.next = Goto(block5, None)
    block5.next = Goto(block3, None)
    return Graph('zbits1_to_bool', [zb], block0)

def test_swap_not():
    graph = make_bits_to_bool()

    swap_not(graph, fakecodegen)
    res = print_graph_construction(graph)
    assert "\n".join(res) == """\
zb = Argument('zb', SmallFixedBitVector(1))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
i1 = block0.emit(Cast, '$cast', [zb], GenericBitVector(), '`1 14:2-14:5', 'zz43')
i2 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], GenericBitVector(), '`1 14:2-14:5', 'zz44')
i3 = block0.emit(Operation, 'zeq_bits', [i1, i2], Bool(), '`1 14:2-14:5', 'zz42')
block0.next = ConditionalGoto(i3, block1, block4, '`1 13:27-16:1')
block1.next = Goto(block2, None)
block2.next = Goto(block3, None)
i4 = block3.emit_phi([block2, block5], [BooleanConstant.TRUE, BooleanConstant.FALSE], Bool())
block3.next = Return(i4, None)
block4.next = Goto(block5, None)
block5.next = Goto(block3, None)
graph = Graph('zbits1_to_bool', [zb], block0)"""

def test_remove_empty_blocks():
    graph = make_bits_to_bool()
    remove_empty_blocks(graph, fakecodegen)
    res = print_graph_construction(graph)
    assert "\n".join(res) == """\
zb = Argument('zb', SmallFixedBitVector(1))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
i1 = block0.emit(Cast, '$cast', [zb], GenericBitVector(), '`1 14:2-14:5', 'zz43')
i2 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], GenericBitVector(), '`1 14:2-14:5', 'zz44')
i3 = block0.emit(Operation, 'zeq_bits', [i1, i2], Bool(), '`1 14:2-14:5', 'zz42')
i4 = block0.emit(Operation, '@not', [i3], Bool(), '`1 13:27-16:1', None)
block0.next = ConditionalGoto(i4, block1, block3, '`1 13:27-16:1')
block1.next = Goto(block2, None)
i5 = block2.emit_phi([block3, block1], [BooleanConstant.TRUE, BooleanConstant.FALSE], Bool())
block2.next = Return(i5, None)
block3.next = Goto(block2, None)
graph = Graph('zbits1_to_bool', [zb], block0)"""


def test_remove_empty_blocks_2():
    zx = Argument('zx', Bool())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block0.next = ConditionalGoto(zx, block1, block3, '`1 204:26-204:48')
    block1.next = Goto(block2, None)
    i1 = block2.emit_phi([block3, block1], [SmallBitVectorConstant(0b0, resolved_type=SmallFixedBitVector(1)), SmallBitVectorConstant(0b1, resolved_type=SmallFixedBitVector(1))], SmallFixedBitVector(1))
    block2.next = Return(i1, None)
    block3.next = Goto(block2, None)
    graph = Graph('zbool_to_bits', [zx], block0)
    assert not remove_empty_blocks(graph, fakecodegen)

def test_if_true_false():
    zargz3 = Argument('zargz3', SmallFixedBitVector(32))
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block1.next = ConditionalGoto(BooleanConstant.FALSE, block2, block3, '')
    block2.next = Goto(block4)
    block3.next = Goto(block4)
    v0 = block4.emit_phi([block2, block3], [MachineIntConstant(12), MachineIntConstant(13)], Int())
    v1 = block4.emit(Operation, 'foo', [MachineIntConstant(-12), v0], Int(), '', None)
    block4.next = Return(v0, '')

    g = Graph("execute", [zargz3], block1)
    res = remove_if_true_false(g, fakecodegen)
    res = print_graph_construction(g)
    assert "\n".join(res) == """\
zargz3 = Argument('zargz3', SmallFixedBitVector(32))
block0 = Block()
block1 = Block()
block2 = Block()
block0.next = Goto(block1, None)
block1.next = Goto(block2, None)
i1 = block2.emit(Operation, 'foo', [MachineIntConstant(-12), MachineIntConstant(13)], Int(), '', None)
block2.next = Return(MachineIntConstant(13), '')
graph = Graph('execute', [zargz3], block0)"""

def test_cast():
    zb = Argument('zb', SmallFixedBitVector(1))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [zb], GenericBitVector(), '`1 14:2-14:5', 'zz43')
    i2 = block0.emit(Cast, '$cast', [i1], SmallFixedBitVector(1), '`1 14:2-14:5', 'zz43')
    block0.next = Return(i2, '')
    graph = Graph('f', [zb], block0)
    check_optimize(graph, """\
zb = Argument('zb', SmallFixedBitVector(1))
block0 = Block()
block0.next = Return(zb, '')
graph = Graph('f', [zb], block0)""")

def test_eq_bits():
    za = Argument('za', SmallFixedBitVector(2))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [za], GenericBitVector(), '`5 120:4-120:8', 'zz411')
    i2 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b01, SmallFixedBitVector(2))], GenericBitVector(), '`5 120:4-120:8', 'zz412')
    i3 = block0.emit(Operation, 'eq_bits', [i1, i2], Bool(), '`5 120:4-120:8', 'zz410')
    block0.next = Return(i3, None)
    graph = Graph("f", [za], block0)
    check_optimize(graph, """\
za = Argument('za', SmallFixedBitVector(2))
block0 = Block()
i1 = block0.emit(Operation, '@eq_bits_bv_bv', [za, SmallBitVectorConstant(0b1, SmallFixedBitVector(2))], Bool(), '`5 120:4-120:8', 'zz410')
block0.next = Return(i1, None)
graph = Graph('f', [za], block0)""")

def test_neq_bits():
    za = Argument('za', SmallFixedBitVector(2))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [za], GenericBitVector(), '`5 120:4-120:8', 'zz411')
    i2 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b01, SmallFixedBitVector(2))], GenericBitVector(), '`5 120:4-120:8', 'zz412')
    i3 = block0.emit(Operation, 'neq_bits', [i1, i2], Bool(), '`5 120:4-120:8', 'zz410')
    block0.next = Return(i3, None)
    graph = Graph("f", [za], block0)
    check_optimize(graph, """\
za = Argument('za', SmallFixedBitVector(2))
block0 = Block()
i1 = block0.emit(Operation, '@eq_bits_bv_bv', [za, SmallBitVectorConstant(0b1, SmallFixedBitVector(2))], Bool(), '`5 120:4-120:8', 'zz410')
i2 = block0.emit(Operation, '@not', [i1], Bool(), None, None)
block0.next = Return(i2, None)
graph = Graph('f', [za], block0)""")

def test_int_and_back():
    block0 = Block()
    i1 = block0.emit(Operation, 'int64_to_int', [MachineIntConstant(15)], Int(), '`5 295:30-295:32', 'zz42')
    i2 = block0.emit(Operation, 'int_to_int64', [i1], MachineInt(), '`5 295:30-295:32', 'zz40')
    block0.next = Return(i2)
    graph = Graph("f", [], block0)
    check_optimize(graph, """\
block0 = Block()
block0.next = Return(MachineIntConstant(15), None)
graph = Graph('f', [], block0)""")

def test_eq_int():
    zr = Argument('zr', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, 'int64_to_int', [MachineIntConstant(0)], Int(), '`80', 'zz4128')
    i2 = block0.emit(Operation, 'int64_to_int', [zr], Int(), '`82', 'zz4130')
    i3 = block0.emit(Operation, 'eq_int', [i2, i1], Bool(), '`83', 'zz4129')
    block0.next = Return(i3)
    graph = Graph("f", [zr], block0)
    check_optimize(graph, """\
zr = Argument('zr', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@eq', [zr, MachineIntConstant(0)], Bool(), '`83', 'zz4129')
block0.next = Return(i1, None)
graph = Graph('f', [zr], block0)""")

def test_vector_subrange():
    zargz3 = Argument('zargz3', SmallFixedBitVector(64))
    block0 = Block()
    i1 = block0.emit(Operation, 'int64_to_int', [MachineIntConstant(6)], Int(), '`36 84:17-84:31', 'zz412137')
    i2 = block0.emit(Operation, 'int64_to_int', [MachineIntConstant(0)], Int(), '`36 84:17-84:31', 'zz412138')
    i3 = block0.emit(Cast, '$cast', [zargz3], GenericBitVector(), '`36 84:17-84:31', 'zz412139')
    i4 = block0.emit(Operation, 'vector_subrange', [i3, i1, i2], GenericBitVector(), '`36 84:17-84:31', 'zz412140')
    i5 = block0.emit(Cast, '$cast', [i4], SmallFixedBitVector(7), '`36 84:17-84:31', 'zz412111')
    block0.next = Return(i5)
    graph = Graph("f", [zargz3], block0)
    check_optimize(graph, """\
zargz3 = Argument('zargz3', SmallFixedBitVector(64))
block0 = Block()
i1 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zargz3, MachineIntConstant(6), MachineIntConstant(0)], SmallFixedBitVector(7), '`36 84:17-84:31', 'zz412140')
block0.next = Return(i1, None)
graph = Graph('f', [zargz3], block0)""")

def test_vector_subrange_optimizations_confluence():
    target = Argument('target', SmallFixedBitVector(64))
    block0 = Block()
    i3 = block0.emit(Cast, '$cast', [target], GenericBitVector(), None, None)
    i9 = block0.emit(Operation, '@vector_subrange_o_i_i_unwrapped_res', [i3, MachineIntConstant(63), MachineIntConstant(0)], SmallFixedBitVector(64), '`7 2268:60-2268:75', 'zz423')
    block0.next = Return(i9, None)
    graph = Graph('subrange', [target], block0)
    check_optimize(graph, '''
target = Argument('target', SmallFixedBitVector(64))
block0 = Block()
i1 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [target, MachineIntConstant(63), MachineIntConstant(0)], SmallFixedBitVector(64), '`7 2268:60-2268:75', 'zz423')
block0.next = Return(i1, None)
graph = Graph('subrange', [target], block0)
''')

def test_vector_slice_confluence():
    a = Argument('a', SmallFixedBitVector(64))
    i = Argument('i', MachineInt())
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [a], GenericBitVector(), None, None)
    i2 = block0.emit(Operation, '@vector_slice_o_i_i_unwrapped_res', [i1, i, MachineIntConstant(8)], SmallFixedBitVector(8), '`5554', 'zz4174')
    block0.next = Return(i2, None)
    graph = Graph('slice', [a, i], block0)
    check_optimize(graph, '''
a = Argument('a', SmallFixedBitVector(64))
i = Argument('i', MachineInt())
block0 = Block()
i2 = block0.emit(Operation, '@slice_fixed_bv_i_i', [a, i, MachineIntConstant(8)], SmallFixedBitVector(8), '`5554', 'zz4174')
block0.next = Return(i2, None)
graph = Graph('slice', [a, i], block0)
''')

def test_int_slice_confluence():
    mi = Argument('mi', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, 'zz5i64zDzKz5i', [mi], Int(), None, None)
    i2 = block0.emit(Operation, '@get_slice_int_i_o_i_unwrapped_res', [MachineIntConstant(12), i1, MachineIntConstant(0)], SmallFixedBitVector(12), '`5 176:39-176:72', 'return')
    block0.next = Return(i2, None)
    graph = Graph('slice', [mi], block0)
    check_optimize(graph, '''
mi = Argument('mi', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@get_slice_int_i_i_i', [MachineIntConstant(12), mi, MachineIntConstant(0)], SmallFixedBitVector(12), '`5 176:39-176:72', 'return')
block0.next = Return(i1, None)
graph = Graph('slice', [mi], block0)
''')

def test_vector_update_subrange():
    zv = Argument('zv', SmallFixedBitVector(64))
    zx = Argument('zx', SmallFixedBitVector(1))
    block0 = Block()
    i3 = block0.emit(Cast, '$cast', [zv], GenericBitVector(), '`509', 'zz45')
    i4 = block0.emit(Cast, '$cast', [zx], GenericBitVector(), '`511', 'zz46')
    i5 = block0.emit(Operation, '@vector_update_subrange_o_i_i_o', [i3, MachineIntConstant(0), MachineIntConstant(0), i4], GenericBitVector(), '`513', 'zz47')
    i6 = block0.emit(Cast, '$cast', [i5], SmallFixedBitVector(64), '`514', 'zz40')
    block0.next = Return(i6, None)
    graph = Graph('update', [zv, zx], block0)
    check_optimize(graph, """\
zv = Argument('zv', SmallFixedBitVector(64))
zx = Argument('zx', SmallFixedBitVector(1))
block0 = Block()
i2 = block0.emit(Operation, '@vector_update_subrange_fixed_bv_i_i_bv', [zv, MachineIntConstant(0), MachineIntConstant(0), zx], SmallFixedBitVector(64), '`513', 'zz47')
block0.next = Return(i2, None)
graph = Graph('update', [zv, zx], block0)""")

def test_vector_access():
    zx = Argument('zx', SmallFixedBitVector(8))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [zx], GenericBitVector(), '`35 86:29-86:33', 'zz48')
    i2 = block0.emit(Operation, '@vector_access_o_i', [i1, MachineIntConstant(7)], Bit(), '`35 86:29-86:33', 'zz46')
    block0.next = Return(i2)
    graph = Graph('update', [zx], block0)
    check_optimize(graph, """\
zx = Argument('zx', SmallFixedBitVector(8))
block0 = Block()
i1 = block0.emit(Operation, '@vector_access_bv_i', [zx, MachineIntConstant(7)], SmallFixedBitVector(1), '`35 86:29-86:33', 'zz46')
block0.next = Return(i1, None)
graph = Graph('update', [zx], block0)""")

def test_and_not_bits():
    zx = Argument('zx', SmallFixedBitVector(64))
    zy = Argument('zy', SmallFixedBitVector(64))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [zx], GenericBitVector(), '`25 286:37-286:63', 'zz420')
    i2 = block0.emit(Operation, 'not_bits', [i1], GenericBitVector(), '`25 286:51-286:62', 'zz424')
    i3 = block0.emit(Cast, '$cast', [zy], GenericBitVector(), '`25 286:37-286:63', 'zz420')
    i4 = block0.emit(Operation, 'and_bits', [i3, i2], GenericBitVector(), '`25 286:37-286:63', 'zz422')
    i8 = block0.emit(Cast, '$cast', [i4], SmallFixedBitVector(64), '`25 286:37-286:63', 'zz420')
    block0.next = Return(i8)
    graph = Graph('update', [zx, zy], block0)
    check_optimize(graph, """\
zx = Argument('zx', SmallFixedBitVector(64))
zy = Argument('zy', SmallFixedBitVector(64))
block0 = Block()
i2 = block0.emit(Operation, '@not_vec_bv', [zx, MachineIntConstant(64)], SmallFixedBitVector(64), '`25 286:51-286:62', None)
i3 = block0.emit(Operation, '@and_vec_bv_bv', [zy, i2], SmallFixedBitVector(64), '`25 286:37-286:63', 'zz422')
block0.next = Return(i3, None)
graph = Graph('update', [zx, zy], block0)""")

def test_add_bits():
    zx = Argument('zx', SmallFixedBitVector(64))
    zy = Argument('zy', SmallFixedBitVector(64))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [zx], GenericBitVector(), '`25 286:37-286:63', 'zz420')
    i3 = block0.emit(Cast, '$cast', [zy], GenericBitVector(), '`25 286:37-286:63', 'zz420')
    i4 = block0.emit(Operation, 'add_bits', [i1, i3], GenericBitVector(), '`25 286:37-286:63', 'zz422')
    i8 = block0.emit(Cast, '$cast', [i4], SmallFixedBitVector(64), '`25 286:37-286:63', 'zz420')
    block0.next = Return(i8)
    graph = Graph('update', [zx, zy], block0)
    check_optimize(graph, """\
zx = Argument('zx', SmallFixedBitVector(64))
zy = Argument('zy', SmallFixedBitVector(64))
block0 = Block()
i2 = block0.emit(Operation, '@add_bits_bv_bv', [zx, zy, MachineIntConstant(64)], SmallFixedBitVector(64), '`25 286:37-286:63', 'zz422')
block0.next = Return(i2, None)
graph = Graph('update', [zx, zy], block0)""")

def test_append():
    zcreg = Argument('zcreg', SmallFixedBitVector(3))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b01, SmallFixedBitVector(2))], GenericBitVector(), '`5 100:30-100:41', 'zz40')
    i2 = block0.emit(Cast, '$cast', [zcreg], GenericBitVector(), '`5 100:30-100:41', 'zz41')
    i3 = block0.emit(Operation, 'append', [i1, i2], GenericBitVector(), '`5 100:30-100:41', 'zz42')
    i4 = block0.emit(Cast, '$cast', [i3], SmallFixedBitVector(5), '`5 100:30-100:41', 'return')
    block0.next = Return(i4, None)
    graph = Graph('zcreg2reg_idx', [zcreg], block0)
    check_optimize(graph, """\
zcreg = Argument('zcreg', SmallFixedBitVector(3))
block0 = Block()
i1 = block0.emit(Operation, '@bitvector_concat_bv_bv', [SmallBitVectorConstant(0b1, SmallFixedBitVector(2)), MachineIntConstant(3), zcreg], SmallFixedBitVector(5), '`5 100:30-100:41', 'zz42')
block0.next = Return(i1, None)
graph = Graph('zcreg2reg_idx', [zcreg], block0)""")

def test_shiftr():
    for kind in "@shiftr_o_i", "@arith_shiftr_o_i":
        arg = Argument('arg', SmallFixedBitVector(64))
        block0 = Block()
        i1 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [arg, MachineIntConstant(47), MachineIntConstant(0)], SmallFixedBitVector(48), '`3484', 'zz44')
        i2 = block0.emit(Operation, '@zero_extend_bv_i_i', [i1, MachineIntConstant(48), MachineIntConstant(64)], SmallFixedBitVector(64), '`26 426:31-426:66', 'zz449')
        i2 = block0.emit(Cast, '$cast', [i2], GenericBitVector(), None, None)
        i3 = block0.emit(Operation, kind, [i2, MachineIntConstant(1)], GenericBitVector(), '`26 426:31-426:71', 'zz445')
        i4 = block0.emit(Cast, '$cast', [i3], SmallFixedBitVector(64), '`26 426:31-426:71', 'zhtif_exit_code')
        block0.next = Return(i4, None)
        graph = Graph('zcreg2reg_idx', [arg], block0)
        check_optimize(graph, """\
arg = Argument('arg', SmallFixedBitVector(64))
block0 = Block()
i1 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [arg, MachineIntConstant(47), MachineIntConstant(0)], SmallFixedBitVector(48), '`3484', 'zz44')
i2 = block0.emit(Operation, '@zero_extend_bv_i_i', [i1, MachineIntConstant(48), MachineIntConstant(64)], SmallFixedBitVector(64), '`26 426:31-426:66', 'zz449')
i3 = block0.emit(Operation, '%s_bv_i', [i2, MachineIntConstant(64), MachineIntConstant(1)], SmallFixedBitVector(64), '`26 426:31-426:71', 'zz445')
block0.next = Return(i3, None)
graph = Graph('zcreg2reg_idx', [arg], block0)""" % (kind[:-4], ))

def test_int_cmp():
    a1 = Argument('i', SmallFixedBitVector(52))
    a2 = Argument('i', SmallFixedBitVector(52))
    block0 = Block()
    i1 = block0.emit(Operation, '@unsigned_bv', [a1, MachineIntConstant(52)], MachineInt(), '`41 263:11-263:24', 'zz429')
    i2 = block0.emit(Operation, '@unsigned_bv', [a2, MachineIntConstant(52)], MachineInt(), '`41 263:29-263:42', 'zz427')
    i3 = block0.emit(Operation, 'zz5i64zDzKz5i', [i1], Int(), '`41 263:11-263:42', 'zz424')
    i4 = block0.emit(Operation, 'zz5i64zDzKz5i', [i2], Int(), '`41 263:11-263:42', 'zz425')
    i5 = block0.emit(Operation, 'lt', [i3, i4], Bool(), '`41 263:11-263:42', 'zz412')
    block0.next = Return(i5, None)
    graph = Graph('f', [a1, a2], block0)
    check_optimize(graph, """\
i = Argument('i', SmallFixedBitVector(52))
i = Argument('i', SmallFixedBitVector(52))
block0 = Block()
i2 = block0.emit(Operation, '@unsigned_bv', [i, MachineIntConstant(52)], MachineInt(), '`41 263:11-263:24', 'zz429')
i3 = block0.emit(Operation, '@unsigned_bv', [i, MachineIntConstant(52)], MachineInt(), '`41 263:29-263:42', 'zz427')
i4 = block0.emit(Operation, '@lt', [i2, i3], Bool(), '`41 263:11-263:42', 'zz412')
block0.next = Return(i4, None)
graph = Graph('f', [i, i], block0)""")


def test_set_slice():
    zval_name = Argument('zval_name', SmallFixedBitVector(64))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [zval_name], GenericBitVector(), '`7 47:10-47:38', 'zz419')
    i2 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b00000, SmallFixedBitVector(5))], GenericBitVector(), '`7 47:10-47:38', 'zz420')
    i3 = block0.emit(Operation, '@set_slice_i_i_o_i_o', [MachineIntConstant(64), MachineIntConstant(5), i1, MachineIntConstant(3), i2], GenericBitVector(), '`7 47:10-47:38', 'zz421')
    i4 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], GenericBitVector(), '`7 48:10-48:35', 'zz413')
    i5 = block0.emit(Operation, '@set_slice_i_i_o_i_o', [MachineIntConstant(64), MachineIntConstant(1), i3, MachineIntConstant(14), i4], GenericBitVector(), '`7 48:10-48:35', 'zz414')
    i6 = block0.emit(Cast, '$cast', [SmallBitVectorConstant(0b0000000000000000000000000000000000000, SmallFixedBitVector(37))], GenericBitVector(), '`7 49:10-49:72', 'zz46')
    i7 = block0.emit(Operation, '@set_slice_i_i_o_i_o', [MachineIntConstant(64), MachineIntConstant(37), i5, MachineIntConstant(27), i6], GenericBitVector(), '`7 49:10-49:72', 'zz47')
    i8 = block0.emit(Cast, '$cast', [i7], SmallFixedBitVector(64), '`7 49:10-49:72', 'zz40')
    block0.next = Return(i8, None)
    graph = Graph('z__get_FPCR', [zval_name], block0)
    check_optimize(graph, """\
zval_name = Argument('zval_name', SmallFixedBitVector(64))
block0 = Block()
i1 = block0.emit(Operation, '@vector_update_subrange_fixed_bv_i_i_bv', [zval_name, MachineIntConstant(7), MachineIntConstant(3), SmallBitVectorConstant(0b0, SmallFixedBitVector(5))], SmallFixedBitVector(64), '`7 47:10-47:38', 'zz421')
i2 = block0.emit(Operation, '@vector_update_subrange_fixed_bv_i_i_bv', [i1, MachineIntConstant(14), MachineIntConstant(14), SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], SmallFixedBitVector(64), '`7 48:10-48:35', 'zz414')
i3 = block0.emit(Operation, '@vector_update_subrange_fixed_bv_i_i_bv', [i2, MachineIntConstant(63), MachineIntConstant(27), SmallBitVectorConstant(0b0, SmallFixedBitVector(37))], SmallFixedBitVector(64), '`7 49:10-49:72', 'zz47')
block0.next = Return(i3, None)
graph = Graph('z__get_FPCR', [zval_name], block0)""")

def test_zero_extend_unwrapped_res():
    value = Argument('value', GenericBitVector())
    block0 = Block()
    i0 = block0.emit(Operation, '@zero_extend_o_i', [value, MachineIntConstant(64)], GenericBitVector(), '`5 234:29-234:46', 'return')
    i1 = block0.emit(Cast, '$cast', [i0], SmallFixedBitVector(64), '`7 3419:16-3419:38', 'zz42')
    block0.next = Return(i1, None)
    graph = Graph('f', [value], block0)
    check_optimize(graph, """\
value = Argument('value', GenericBitVector())
block0 = Block()
i1 = block0.emit(Operation, '@zero_extend_o_i_unwrapped_res', [value, MachineIntConstant(64)], SmallFixedBitVector(64), '`5 234:29-234:46', 'return')
block0.next = Return(i1, None)
graph = Graph('f', [value], block0)""")

def test_sign_extend_unwrapped_res():
    value = Argument('value', GenericBitVector())
    block0 = Block()
    i0 = block0.emit(Operation, '@sign_extend_o_i', [value, MachineIntConstant(64)], GenericBitVector(), '`5 234:29-234:46', 'return')
    i1 = block0.emit(Cast, '$cast', [i0], SmallFixedBitVector(64), '`7 3419:16-3419:38', 'zz42')
    block0.next = Return(i1, None)
    graph = Graph('f', [value], block0)
    check_optimize(graph, """\
value = Argument('value', GenericBitVector())
block0 = Block()
i1 = block0.emit(Operation, '@sign_extend_o_i_unwrapped_res', [value, MachineIntConstant(64)], SmallFixedBitVector(64), '`5 234:29-234:46', 'return')
block0.next = Return(i1, None)
graph = Graph('f', [value], block0)""")

def test_vector_update_list():
    index = Argument('index', MachineInt())
    block0 = Block()
    i6 = block0.emit(GlobalRead, 'z_R', [], FVec(31, SmallFixedBitVector(64)), None, None)
    i7 = block0.emit(Cast, '$cast', [i6], Vec(SmallFixedBitVector(64)), '`7 1087:12-1087:17', 'zz416')
    i8 = block0.emit(Operation, '@vector_update_o_i_o', [i7, index, SmallBitVectorConstant(0b1, SmallFixedBitVector(2))], Vec(SmallFixedBitVector(64)), '`7 1087:12-1087:17', 'zz418')
    i9 = block0.emit(Cast, '$cast', [i8], FVec(31, SmallFixedBitVector(64)), '`7 1087:12-1087:17', 'z_R')
    block0.emit(GlobalWrite, 'z_R', [i9], FVec(31, SmallFixedBitVector(64)), None, None)
    block0.next = Return(None, None)
    graph = Graph('f', [index], block0)
    check_optimize(graph, """\
index = Argument('index', MachineInt())
block0 = Block()
i1 = block0.emit(GlobalRead, 'z_R', [], FVec(31, SmallFixedBitVector(64)), None, None)
i2 = block0.emit(Cast, '$cast', [i1], Vec(SmallFixedBitVector(64)), '`7 1087:12-1087:17', 'zz416')
i3 = block0.emit(Operation, '@helper_vector_update_inplace_o_i_o', [i2, index, SmallBitVectorConstant(0b1, SmallFixedBitVector(2))], Unit(), '`7 1087:12-1087:17', 'zz418')
block0.next = Return(None, None)
graph = Graph('f', [index], block0)""")

def test_fill_fresh_vector():
    block0 = Block()
    i1 = block0.emit(VectorInit, '$zinternal_vector_init', [MachineIntConstant(3)], Vec(MachineInt()), '`41 765:95-765:126', None)
    i2 = block0.emit(VectorUpdate, '$zinternal_vector_update', [i1, MachineIntConstant(0), MachineIntConstant(5)], Vec(MachineInt()), None, None)
    i3 = block0.emit(VectorUpdate, '$zinternal_vector_update', [i2, MachineIntConstant(1), MachineIntConstant(7)], Vec(MachineInt()), None, None)
    i4 = block0.emit(VectorUpdate, '$zinternal_vector_update', [i3, MachineIntConstant(2), MachineIntConstant(9)], Vec(MachineInt()), None, None)
    i5 = block0.emit(Operation, 'zvalidDoubleRegs', [IntConstant(3), i4], Bool(), '`41 765:95-765:126', 'zz46820')
    block0.next = Return(i5, None)
    graph = Graph('f', [], block0)
    check_optimize(graph, """\
block0 = Block()
i0 = block0.emit(VectorInit, '$zinternal_vector_init', [MachineIntConstant(3)], Vec(MachineInt()), '`41 765:95-765:126', None)
i1 = block0.emit(Operation, '@helper_vector_update_inplace_o_i_o', [i0, MachineIntConstant(0), MachineIntConstant(5)], Unit(), None, None)
i2 = block0.emit(Operation, '@helper_vector_update_inplace_o_i_o', [i0, MachineIntConstant(1), MachineIntConstant(7)], Unit(), None, None)
i3 = block0.emit(Operation, '@helper_vector_update_inplace_o_i_o', [i0, MachineIntConstant(2), MachineIntConstant(9)], Unit(), None, None)
i4 = block0.emit(Operation, 'zvalidDoubleRegs', [IntConstant(3), i0], Bool(), '`41 765:95-765:126', 'zz46820')
block0.next = Return(i4, None)
graph = Graph('f', [], block0)""")

def test_mult_1():
    index = Argument('index', Int())
    block0 = Block()
    i1 = block0.emit(Operation, 'mult_int', [index, IntConstant(1)], Int(), '`7 14894:55-14894:60', 'zz422')
    block0.next = Return(i1, None)
    graph = Graph('f', [index], block0)
    check_optimize(graph, """\
index = Argument('index', Int())
block0 = Block()
block0.next = Return(index, None)
graph = Graph('f', [index], block0)""")

def test_mult_to_shift():
    index = Argument('index', Int())
    block0 = Block()
    i1 = block0.emit(Operation, 'mult_int', [IntConstant(8), index], Int(), '`7 14894:55-14894:60', 'zz422')
    block0.next = Return(i1, None)
    graph = Graph('f', [index], block0)
    check_optimize(graph, """\
index = Argument('index', Int())
block0 = Block()
i1 = block0.emit(Operation, '@shl_int_o_i', [index, MachineIntConstant(3)], Int(), '`7 14894:55-14894:60', 'zz422')
block0.next = Return(i1, None)
graph = Graph('f', [index], block0)""")

def test_mult_constfold():
    index = Argument('index', Int())
    block0 = Block()
    i1 = block0.emit(Operation, 'mult_int', [IntConstant(12), IntConstant(2)], Int(), '`7 14894:55-14894:60', 'zz422')
    i2 = block0.emit(Operation, 'mult_int', [i1, IntConstant(16)], Int(), '`7 14894:55-14894:60', 'zz422')
    block0.next = Return(i2, None)
    graph = Graph('f', [index], block0)
    check_optimize(graph, """\
index = Argument('index', Int())
block0 = Block()
block0.next = Return(IntConstant(384), None)
graph = Graph('f', [index], block0)""")

def test_pass_cast_through_mult():
    a = Argument('a', Int())
    block0 = Block()
    i1 = block0.emit(Operation, '@mult_o_i_wrapped_res', [a, MachineIntConstant(9)], Int(), '`33 76:63-76:86', 'zz4131')
    i2 = block0.emit(Operation, 'zz5izDzKz5i64', [i1], MachineInt(), None, None)
    block0.next = Return(i2)
    graph = Graph('f', [a], block0)
    check_optimize(graph, """\
a = Argument('a', Int())
block0 = Block()
i1 = block0.emit(Operation, 'zz5izDzKz5i64', [a], MachineInt(), None, None)
i2 = block0.emit(Operation, '@mult_i_i_must_fit', [i1, MachineIntConstant(9)], MachineInt(), '`33 76:63-76:86', 'zz4131')
block0.next = Return(i2, None)
graph = Graph('f', [a], block0)
""")


def test_neg_constfold():
    index = Argument('index', Int())
    block0 = Block()
    i1 = block0.emit(Operation, 'neg_int', [IntConstant(12)], Int(), '`7 14894:55-14894:60', 'zz422')
    block0.next = Return(i1, None)
    graph = Graph('f', [index], block0)
    check_optimize(graph, """\
index = Argument('index', Int())
block0 = Block()
block0.next = Return(IntConstant(-12), None)
graph = Graph('f', [index], block0)""")

def test_ediv_constfold():
    block0 = Block()
    i1 = block0.emit(Operation, 'ediv_int', [IntConstant(128), IntConstant(2)], Int(), '`7 11526:20-11526:32', 'zz4179')
    block0.next = Return(i1, None)
    graph = Graph('f', [], block0)
    check_optimize(graph, """\
block0 = Block()
block0.next = Return(IntConstant(64), None)
graph = Graph('f', [], block0)""")

def test_pow_i():
    block0 = Block()
    i1 = block0.emit(Operation, '@pow2_i', [MachineIntConstant(32)], Int(), '`7 150231:75-150231:81', 'zz492')
    block0.next = Return(i1, None)
    graph = Graph('f', [], block0)
    check_optimize(graph, """\
block0 = Block()
block0.next = Return(IntConstant(4294967296), None)
graph = Graph('f', [], block0)""")

def test_optimize_loop_phi():
    zxs = Argument('zxs', SmallFixedBitVector(8))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block0.next = Goto(block1, None)
    i1 = block1.emit_phi([block0, block3], [zxs, None], SmallFixedBitVector(8))
    i1.prevvalues[1] = i1
    i2 = block1.emit_phi([block0, block3], [SmallBitVectorConstant(0x00, SmallFixedBitVector(8)), None], SmallFixedBitVector(8))
    i4 = block1.emit_phi([block0, block3], [MachineIntConstant(7), None], MachineInt())
    i4.prevvalues[1] = i4
    i5 = block1.emit_phi([block0, block3], [MachineIntConstant(1), None], MachineInt())
    i5.prevvalues[1] = i5
    i6 = block1.emit_phi([block0, block3], [MachineIntConstant(0), None], MachineInt())
    i8 = block1.emit(Operation, '@gt', [i6, i4], Bool(), '`1 279:2-280:19', None)
    block1.next = ConditionalGoto(i8, block2, block3, '`1 279:2-280:19')
    block2.next = Return(i2, None)
    i9 = block3.emit(Operation, '@sub_i_i_wrapped_res', [MachineIntConstant(7), i6], Int(), '`1 280:15-280:18', 'zz416')
    i10 = block3.emit(Operation, 'zz5izDzKz5i64', [i9], MachineInt(), None, None)
    i11 = block3.emit(Operation, '@vector_access_bv_i', [i1, i10], Bit(), '`1 280:12-280:19', 'zz47')
    i12 = block3.emit(Cast, '$cast', [i2], GenericBitVector(), '`1 280:4-280:9', 'zz48')
    i13 = block3.emit(Operation, '@vector_update_o_i_o', [i12, i6, i11], GenericBitVector(), '`1 280:4-280:9', 'zz410')
    i3 = block3.emit(Cast, '$cast', [i13], SmallFixedBitVector(8), '`1 280:4-280:9', 'zz40')
    i2.prevvalues[1] = i3
    i7 = block3.emit(Operation, '@iadd', [i6, i5], MachineInt(), '`1 279:2-280:19', 'zz45')
    i6.prevvalues[1] = i7
    block3.next = Goto(block1, None)
    graph = Graph('zreverse_bits_in_byte', [zxs], block0, True)
    check_optimize(graph, """\
zxs = Argument('zxs', SmallFixedBitVector(8))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block0.next = Goto(block1, None)
i1 = block1.emit_phi([block0, block3], [SmallBitVectorConstant(0x0, SmallFixedBitVector(8)), None], SmallFixedBitVector(8))
i2 = block1.emit_phi([block0, block3], [MachineIntConstant(0), None], MachineInt())
i3 = block1.emit(Operation, '@gt', [i2, MachineIntConstant(7)], Bool(), '`1 279:2-280:19', None)
block1.next = ConditionalGoto(i3, block2, block3, '`1 279:2-280:19')
block2.next = Return(i1, None)
i4 = block3.emit(Operation, '@sub_i_i_must_fit', [MachineIntConstant(7), i2], MachineInt(), '`1 280:15-280:18', 'zz416')
i5 = block3.emit(Operation, '@vector_access_bv_i', [zxs, i4], SmallFixedBitVector(1), '`1 280:12-280:19', 'zz47')
i6 = block3.emit(Operation, '$zupdate_fbits', [i1, i2, i5], SmallFixedBitVector(8), '`1 280:4-280:9', 'zz410')
i1.prevvalues[1] = i6
i7 = block3.emit(Operation, '@iadd', [i2, MachineIntConstant(1)], MachineInt(), '`1 279:2-280:19', 'zz45')
i2.prevvalues[1] = i7
block3.next = Goto(block1, None)
graph = Graph('zreverse_bits_in_byte', [zxs], block0, True)
""")


def test_complicated_inlining():
    codegen = FakeCodeGen()
    zlen = Argument('zlen', Int())
    zv = Argument('zv', GenericBitVector())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i2 = block0.emit(Operation, '@length_unwrapped_res', [zv], MachineInt(), '`2 141:39-141:48', 'zz41')
    i3 = block0.emit(Operation, 'zz5i64zDzKz5i', [i2], Int(), '`2 141:39-141:48', None)
    i4 = block0.emit(Operation, 'zlteq_int', [zlen, i3], Bool(), '`2 141:32-141:48', 'zz40')
    block0.next = ConditionalGoto(i4, block1, block3, '`2 141:29-141:100')
    i5 = block1.emit(Operation, 'zz5izDzKz5i64', [zlen], MachineInt(), None, None)
    i6 = block1.emit(Operation, '@sail_truncate_o_i', [zv, i5], GenericBitVector(), '`2 141:54-141:70', 'return')
    block1.next = Goto(block2, None)
    i7 = block2.emit_phi([block3, block1], [None, i6], GenericBitVector())
    block2.next = Return(i7, None)
    i8 = block3.emit(Operation, 'zz5izDzKz5i64', [zlen], MachineInt(), None, None)
    i9 = block3.emit(Operation, '@zero_extend_o_i', [zv, i8], GenericBitVector(), '`2 141:76-141:100', 'return')
    i7.prevvalues[0] = i9
    block3.next = Goto(block2, None)
    graph1 = Graph('zsail_mask', [zlen, zv], block0)

    zn = Argument('zn', Int())
    zi = Argument('zi', Int())
    zl = Argument('zl', Int())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i3 = block0.emit(Operation, 'zgteq_int', [zl, zn], Bool(), '`2 336:5-336:11', 'zz40')
    block0.next = ConditionalGoto(i3, block1, block3, '`2 336:2-341:3')
    i4 = block1.emit(Comment, 'inlined zsail_ones', [], Unit(), None, None)
    i5 = block1.emit(Operation, 'zz5izDzKz5i64', [zn], MachineInt(), None, None)
    i6 = block1.emit(Operation, '@zeros_i', [i5], GenericBitVector(), '`2 320:32-320:45', 'zz40')
    i7 = block1.emit(Operation, 'znot_vec', [i6], GenericBitVector(), '`2 320:24-320:46', 'return')
    i8 = block1.emit(Operation, 'zz5izDzKz5i64', [zi], MachineInt(), None, None)
    i9 = block1.emit(Operation, '@shiftl_o_i', [i7, i8], GenericBitVector(), '`2 337:4-337:35', 'return')
    block1.next = Goto(block2, None)
    i10 = block2.emit_phi([block3, block1], [None, i9], GenericBitVector())
    block2.next = Return(i10, None)
    i11 = block3.emit(Cast, '$cast', [SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], GenericBitVector(), '`2 339:25-339:57', 'zz46')
    i12 = block3.emit(Operation, 'zsail_mask', [zn, i11], GenericBitVector(), '`2 339:25-339:57', 'zz42')
    i13 = block3.emit(Operation, 'zz5izDzKz5i64', [zl], MachineInt(), None, None)
    i14 = block3.emit(Operation, '@shiftl_o_i', [i12, i13], GenericBitVector(), '`2 340:28-340:50', 'zz44')
    i15 = block3.emit(Operation, 'zsub_bits', [i14, i12], GenericBitVector(), '`2 340:19-340:56', 'zz43')
    i16 = block3.emit(Operation, 'zz5izDzKz5i64', [zi], MachineInt(), None, None)
    i17 = block3.emit(Operation, '@shiftl_o_i', [i15, i16], GenericBitVector(), '`2 340:4-340:60', 'return')
    i10.prevvalues[0] = i17
    block3.next = Goto(block2, None)
    graph = Graph('zslice_mask', [zn, zi, zl], block0)
    codegen.inlinable_functions['zsail_mask'] = graph1
    inline(graph, codegen)
    res = print_graph_construction(graph)
    got = "\n".join(res)
    assert got == '''\
zn = Argument('zn', Int())
zi = Argument('zi', Int())
zl = Argument('zl', Int())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
i3 = block0.emit(Operation, 'zgteq_int', [zl, zn], Bool(), '`2 336:5-336:11', 'zz40')
block0.next = ConditionalGoto(i3, block1, block3, '`2 336:2-341:3')
i4 = block1.emit(Comment, 'inlined zsail_ones', [], Unit(), None, None)
i5 = block1.emit(Operation, 'zz5izDzKz5i64', [zn], MachineInt(), None, None)
i6 = block1.emit(Operation, '@zeros_i', [i5], GenericBitVector(), '`2 320:32-320:45', 'zz40')
i7 = block1.emit(Operation, 'znot_vec', [i6], GenericBitVector(), '`2 320:24-320:46', 'return')
i8 = block1.emit(Operation, 'zz5izDzKz5i64', [zi], MachineInt(), None, None)
i9 = block1.emit(Operation, '@shiftl_o_i', [i7, i8], GenericBitVector(), '`2 337:4-337:35', 'return')
block1.next = Goto(block2, None)
i10 = block2.emit_phi([block5, block1], [None, i9], GenericBitVector())
block2.next = Return(i10, None)
i11 = block3.emit(Cast, '$cast', [SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], GenericBitVector(), '`2 339:25-339:57', 'zz46')
i12 = block3.emit(Comment, 'inlined zsail_mask', [], Unit(), None, None)
i13 = block3.emit(Operation, '@length_unwrapped_res', [i11], MachineInt(), '`2 141:39-141:48', 'zz41')
i14 = block3.emit(Operation, 'zz5i64zDzKz5i', [i13], Int(), '`2 141:39-141:48', None)
i15 = block3.emit(Operation, 'zlteq_int', [zn, i14], Bool(), '`2 141:32-141:48', 'zz40')
block3.next = ConditionalGoto(i15, block4, block6, '`2 141:29-141:100')
i16 = block4.emit(Operation, 'zz5izDzKz5i64', [zn], MachineInt(), None, None)
i17 = block4.emit(Operation, '@sail_truncate_o_i', [i11, i16], GenericBitVector(), '`2 141:54-141:70', 'return')
block4.next = Goto(block5, None)
i18 = block5.emit_phi([block6, block4], [None, i17], GenericBitVector())
i19 = block5.emit(Operation, 'zz5izDzKz5i64', [zl], MachineInt(), None, None)
i20 = block5.emit(Operation, '@shiftl_o_i', [i18, i19], GenericBitVector(), '`2 340:28-340:50', 'zz44')
i21 = block5.emit(Operation, 'zsub_bits', [i20, i18], GenericBitVector(), '`2 340:19-340:56', 'zz43')
i22 = block5.emit(Operation, 'zz5izDzKz5i64', [zi], MachineInt(), None, None)
i23 = block5.emit(Operation, '@shiftl_o_i', [i21, i22], GenericBitVector(), '`2 340:4-340:60', 'return')
i10.prevvalues[0] = i23
block5.next = Goto(block2, None)
i24 = block6.emit(Operation, 'zz5izDzKz5i64', [zn], MachineInt(), None, None)
i25 = block6.emit(Operation, '@zero_extend_o_i', [i11, i24], GenericBitVector(), '`2 141:76-141:100', 'return')
i18.prevvalues[0] = i25
block6.next = Goto(block5, None)
graph = Graph('zslice_mask', [zn, zi, zl], block0)'''


def test_toposort():
    zp = Argument('zp', SmallFixedBitVector(2))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    i1 = block0.emit(Operation, '@eq_bits_bv_bv', [zp, SmallBitVectorConstant(0b00, SmallFixedBitVector(2))], Bool(), '`5 170:4-170:8', 'zz414')
    block0.next = ConditionalGoto(i1, block1, block3, '`5 169:2-174:3')
    i2 = block1.emit(GlobalRead, 'zUser', [], Int(), None, None)
    block1.next = Goto(block2, None)
    i4 = block2.emit_phi([block1, block4, block6, block7], [i2, None, None, None], Int())
    block2.next = Return(i4, None)
    i5 = block3.emit(Operation, '@eq_bits_bv_bv', [zp, SmallBitVectorConstant(0b01, SmallFixedBitVector(2))], Bool(), '`5 171:4-171:8', 'zz410')
    block3.next = ConditionalGoto(i5, block4, block5, '`5 169:2-174:3')
    i6 = block4.emit(GlobalRead, 'zSupervisor', [], Int(), None, None)
    i4.prevvalues[1] = i6
    block4.next = Goto(block2, None)
    i8 = block5.emit(Operation, '@eq_bits_bv_bv', [zp, SmallBitVectorConstant(0b11, SmallFixedBitVector(2))], Bool(), '`5 172:4-172:8', 'zz46')
    block5.next = ConditionalGoto(i8, block6, block7, '`5 169:2-174:3')
    i9 = block6.emit(GlobalRead, 'zMachine', [], Int(), None, None)
    i4.prevvalues[2] = i9
    block6.next = Goto(block2, None)
    i11 = block7.emit(Cast, '$cast', [zp], GenericBitVector(), '`5 173:77-173:86', 'zz44')
    i12 = block7.emit(Operation, 'zstring_of_bits', [i11], String(), '`5 173:77-173:86', 'zz43')
    i14 = block7.emit(Operation, 'zinternal_errorzIEPrivilegez5zK', [], Int(), '`5 173:12-173:87', 'zz40')
    i4.prevvalues[3] = i14
    block7.next = Goto(block2, None)
    graph = Graph('zprivLevel_of_bits', [zp], block0)

    assert set(topo_order(graph)) == set(graph.iterblocks())

def test_toposort_best_attempt():
    zn = Argument('zn', Int())
    zregs = Argument('zregs', Vec(SmallFixedBitVector(5)))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    block9 = Block()
    block10 = Block()
    block11 = Block()
    block12 = Block()
    i2 = block0.emit(Operation, 'zhaveZdinx', [], Bool(), '`40 295:5-295:16', 'zz417')
    block0.next = ConditionalGoto(i2, block1, block12, '`40 295:5-295:37')
    block1.next = Goto(block2, None)
    i3 = block2.emit_phi([block12, block1], [BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
    block2.next = ConditionalGoto(i3, block3, block11, '`40 295:2-297:49')
    i4 = block3.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(0)], Int(), '`40 296:20-296:21', 'zz416')
    i5 = block3.emit(Operation, 'zz5izDzKz5i64', [i4], MachineInt(), '`40 296:20-296:21', 'zz42')
    i6 = block3.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(1)], Int(), '`40 296:26-296:31', 'zz414')
    i7 = block3.emit(Operation, 'zsub_atom', [zn, i6], Int(), '`40 296:26-296:31', 'zz415')
    i8 = block3.emit(Operation, 'zz5izDzKz5i64', [i7], MachineInt(), '`40 296:26-296:31', 'zz43')
    i9 = block3.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(1)], Int(), '`40 296:4-297:49', 'zz413')
    i10 = block3.emit(Operation, 'zz5izDzKz5i64', [i9], MachineInt(), '`40 296:4-297:49', 'zz44')
    block3.next = Goto(block4, None)
    i11 = block4.emit_phi([block3, block10], [i5, None], MachineInt())
    i12 = block4.emit(Operation, '@gt', [i11, i8], Bool(), '`40 296:4-297:49', None)
    block4.next = ConditionalGoto(i12, block5, block8, '`40 296:4-297:49')
    block5.next = Goto(block6, None)
    block6.next = Goto(block7, None)
    i13 = block7.emit_phi([block9, block6], [BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
    block7.next = Return(i13, None)
    i14 = block8.emit(Operation, 'zz5i64zDzKz5i', [i11], Int(), '`40 297:10-297:17', 'zz412')
    i15 = block8.emit(Operation, 'zplain_vector_accesszIB5zK', [zregs, i14], SmallFixedBitVector(5), '`40 297:10-297:17', 'zz49')
    i16 = block8.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(0)], Int(), '`40 297:10-297:20', 'zz410')
    i17 = block8.emit(Cast, '$cast', [i15], GenericBitVector(), '`40 297:10-297:20', 'zz411')
    i18 = block8.emit(Operation, 'zbitvector_access', [i17, i16], SmallFixedBitVector(1), '`40 297:10-297:20', 'zz48')
    i19 = block8.emit(GlobalRead, 'bitone', [], SmallFixedBitVector(1), None, None)
    i20 = block8.emit(Operation, 'zeq_bit', [i18, i19], Bool(), '`40 297:10-297:30', 'zz47')
    block8.next = ConditionalGoto(i20, block9, block10, '`40 297:6-297:49')
    block9.next = Goto(block7, None)
    i21 = block10.emit(Operation, '@iadd', [i11, i10], MachineInt(), '`40 296:4-297:49', 'zz45')
    i11.prevvalues[1] = i21
    block10.next = Goto(block4, None)
    block11.next = Goto(block6, None)
    block12.next = Goto(block2, None)
    graph = Graph('zvalidDoubleRegs', [zn, zregs], block0, True)
    topo_order_best_attempt(graph)

def test_constfold_lteq():
    block0 = Block()
    i1 = block0.emit(Operation, '@lteq', [MachineIntConstant(64), MachineIntConstant(1)], Bool(), '`2 141:32-141:48', 'zz40')
    block0.next = Return(i1, None)
    graph = Graph('f', [], block0)
    check_optimize(graph, """\
block0 = Block()
block0.next = Return(BooleanConstant.FALSE, None)
graph = Graph('f', [], block0)""")


def test_cast_of_phi():
    arg2 = Argument('arg2', SmallFixedBitVector(5))
    arg4 = Argument('arg4', SmallFixedBitVector(5))
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    i5 = block1.emit(Operation, 'zrX_bits', [arg2], SmallFixedBitVector(64), '`43 266:16-266:22', 'zz43006')
    i6 = block1.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(0)], Int(), '`43 268:18-268:19', 'zz43055')
    i7 = block1.emit(Operation, 'zz5izDzKz5i64', [i6], MachineInt(), '`43 268:18-268:19', 'zz43009')
    i8 = block1.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(56)], Int(), '`14475', 'zz43054')
    i9 = block1.emit(Operation, 'zz5izDzKz5i64', [i8], MachineInt(), '`14476', 'zz43010')
    i10 = block1.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(8)], Int(), '`43 268:45-268:46', 'zz43053')
    i11 = block1.emit(Operation, 'zz5izDzKz5i64', [i10], MachineInt(), '`43 268:45-268:46', 'zz43011')
    block1.next = Goto(block2, None)
    i17 = block2.emit_phi([block1, block7], [SmallBitVectorConstant(0x0000000000000000, SmallFixedBitVector(64)), None], SmallFixedBitVector(64))
    i24 = block2.emit_phi([block1, block7], [i7, None], MachineInt())
    i26 = block2.emit(Operation, '@gt', [i24, i9], Bool(), '`43 268:2-271:36', None)
    block2.next = ConditionalGoto(i26, block3, block5, '`43 268:2-271:36')
    i27 = block3.emit(Operation, 'zwX_bits', [arg4, i17], Unit(), '`43 272:2-272:7', 'zz43008')
    block3.next = Goto(block4, None)
    block4.next = Return(MachineIntConstant(23), None)
    i29 = block5.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(7)], Int(), '`43 269:12-269:17', 'zz43050')
    i30 = block5.emit(Operation, 'zz5i64zDzKz5i', [i24], Int(), '`43 269:12-269:17', 'zz43051')
    i31 = block5.emit(Operation, 'add_int', [i30, i29], Int(), '`43 269:12-269:17', 'zz43052')
    i32 = block5.emit(Operation, 'zz5izDzKz5i64', [i31], MachineInt(), '`43 269:12-269:17', 'zz43015')
    i33 = block5.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(7)], Int(), '`43 269:39-269:44', 'zz43047')
    i34 = block5.emit(Operation, 'zz5i64zDzKz5i', [i24], Int(), '`43 269:39-269:44', 'zz43048')
    i35 = block5.emit(Operation, 'add_int', [i34, i33], Int(), '`43 269:39-269:44', 'zz43049')
    i36 = block5.emit(Operation, 'zz5izDzKz5i64', [i35], MachineInt(), '`43 269:39-269:44', 'zz43043')
    i37 = block5.emit(Cast, '$cast', [i5], GenericBitVector(), '`43 269:30-269:51', 'zz43044')
    i38 = block5.emit(Operation, 'zz5i64zDzKz5i', [i36], Int(), '`43 269:30-269:51', 'zz43045')
    i39 = block5.emit(Operation, 'zz5i64zDzKz5i', [i24], Int(), '`43 269:30-269:51', 'zz43046')
    i40 = block5.emit(Operation, 'vector_subrange', [i37, i38, i39], GenericBitVector(), '`43 269:30-269:51', 'zz43022')
    i41 = block5.emit(Operation, 'zz5i64zDzKz5i', [i24], Int(), '`14481', 'zz43041')
    i43 = block5.emit(Operation, 'zz5izDzKz5i64', [i41], MachineInt(), '`14484', 'zz43037')
    i44 = block5.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(7)], Int(), '`14486', 'zz43038')
    i45 = block5.emit(Operation, 'zz5i64zDzKz5i', [i43], Int(), '`14488', 'zz43039')
    i46 = block5.emit(Operation, 'add_int', [i45, i44], Int(), '`14490', 'zz43040')
    i47 = block5.emit(Operation, 'zz5izDzKz5i64', [i46], MachineInt(), '`14491', 'zz43030')
    i48 = block5.emit(Operation, 'zz5i64zDzKz5i', [i24], Int(), '`14494', 'zz43035')
    i50 = block5.emit(Operation, 'zz5izDzKz5i64', [i48], MachineInt(), '`14497', 'zz43031')
    i51 = block5.emit(Operation, 'zz5i64zDzKz5i', [i47], Int(), '`14499', 'zz43032')
    i52 = block5.emit(Operation, 'zz5i64zDzKz5i', [i50], Int(), '`14501', 'zz43033')
    i53 = block5.emit(Operation, 'sub_int', [i51, i52], Int(), '`14503', 'zz43034')
    i54 = block5.emit(Operation, 'zz5izDzKz5i64', [i53], MachineInt(), '`14504', 'zz43026')
    i55 = block5.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(1)], Int(), '`14506', 'zz43027')
    i56 = block5.emit(Operation, 'zz5i64zDzKz5i', [i54], Int(), '`14508', 'zz43028')
    i57 = block5.emit(Operation, 'add_int', [i56, i55], Int(), '`14510', 'zz43029')
    i58 = block5.emit(Operation, 'zz5izDzKz5i64', [i57], MachineInt(), '`14511', 'zz43024')
    i59 = block5.emit(Operation, 'zz5i64zDzKz5i', [i58], Int(), '`43 269:55-269:62', 'zz43025')
    i60 = block5.emit(Operation, 'zeros', [i59], GenericBitVector(), '`43 269:55-269:62', 'zz43023')
    i61 = block5.emit(Operation, 'eq_bits', [i40, i60], Bool(), '`43 269:30-269:62', 'zz43021')
    block5.next = ConditionalGoto(i61, block6, block8, '`43 269:27-271:36')
    i62 = block6.emit(Cast, '$cast', [SmallBitVectorConstant(0x00, SmallFixedBitVector(8))], GenericBitVector(), '`43 270:32-270:36', 'zz43016')
    block6.next = Goto(block7, None)
    i63 = block7.emit_phi([block8, block6], [None, i62], GenericBitVector())
    i64 = block7.emit(Cast, '$cast', [i17], GenericBitVector(), '`43 269:4-269:24', 'zz43017')
    i65 = block7.emit(Operation, 'zz5i64zDzKz5i', [i32], Int(), '`43 269:4-269:24', 'zz43018')
    i66 = block7.emit(Operation, 'zz5i64zDzKz5i', [i24], Int(), '`43 269:4-269:24', 'zz43019')
    i67 = block7.emit(Operation, 'vector_update_subrange', [i64, i65, i66, i63], GenericBitVector(), '`43 269:4-269:24', 'zz43020')
    i68 = block7.emit(Cast, '$cast', [i67], SmallFixedBitVector(64), '`43 269:4-269:24', 'zz43007')
    i17.prevvalues[1] = i68
    i69 = block7.emit(Operation, '@iadd', [i24, i11], MachineInt(), '`43 268:2-271:36', 'zz43013')
    i24.prevvalues[1] = i69
    block7.next = Goto(block2, None)
    i70 = block8.emit(Cast, '$cast', [SmallBitVectorConstant(0xFF, SmallFixedBitVector(8))], GenericBitVector(), '`43 271:32-271:36', 'zz43016')
    i63.prevvalues[0] = i70
    block8.next = Goto(block7, None)
    graph = Graph('zexecute', [arg2, arg4], block1)
    graph.has_loop = True
    graph.check()
    check_optimize(graph, """\
arg2 = Argument('arg2', SmallFixedBitVector(5))
arg4 = Argument('arg4', SmallFixedBitVector(5))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
i2 = block0.emit(Operation, 'zrX_bits', [arg2], SmallFixedBitVector(64), '`43 266:16-266:22', 'zz43006')
block0.next = Goto(block1, None)
i3 = block1.emit_phi([block0, block5], [SmallBitVectorConstant(0x0, SmallFixedBitVector(64)), None], SmallFixedBitVector(64))
i4 = block1.emit_phi([block0, block5], [MachineIntConstant(0), None], MachineInt())
i5 = block1.emit(Operation, '@gt', [i4, MachineIntConstant(56)], Bool(), '`43 268:2-271:36', None)
block1.next = ConditionalGoto(i5, block2, block3, '`43 268:2-271:36')
i6 = block2.emit(Operation, 'zwX_bits', [arg4, i3], Unit(), '`43 272:2-272:7', 'zz43008')
block2.next = Return(MachineIntConstant(23), None)
i7 = block3.emit(Operation, '@add_i_i_must_fit', [i4, MachineIntConstant(7)], MachineInt(), '`43 269:12-269:17', 'zz43052')
i8 = block3.emit(Operation, '@slice_fixed_bv_i_i', [i2, i4, MachineIntConstant(8)], SmallFixedBitVector(8), '`43 269:30-269:51', 'zz43022')
i9 = block3.emit(Operation, '@eq_bits_bv_bv', [SmallBitVectorConstant(0x0, SmallFixedBitVector(8)), i8], Bool(), '`43 269:30-269:62', 'zz43021')
block3.next = ConditionalGoto(i9, block4, block6, '`43 269:27-271:36')
block4.next = Goto(block5, None)
i10 = block5.emit_phi([block6, block4], [SmallBitVectorConstant(0xff, SmallFixedBitVector(8)), SmallBitVectorConstant(0x0, SmallFixedBitVector(8))], SmallFixedBitVector(8))
i11 = block5.emit(Operation, '@vector_update_subrange_fixed_bv_i_i_bv', [i3, i7, i4, i10], SmallFixedBitVector(64), '`43 269:4-269:24', 'zz43020')
i3.prevvalues[1] = i11
i12 = block5.emit(Operation, '@iadd', [i4, MachineIntConstant(8)], MachineInt(), '`43 268:2-271:36', 'zz43013')
i4.prevvalues[1] = i12
block5.next = Goto(block1, None)
block6.next = Goto(block5, None)
graph = Graph('zexecute', [arg2, arg4], block0, True)
""")


def test_shift_0():
    arg = Argument('arg', GenericBitVector())
    block0 = Block()
    i1 = block0.emit(Operation, '@shiftl_o_i', [arg, MachineIntConstant(0)], GenericBitVector(), '`2 337:4-337:35', 'return')
    block0.next = Return(i1, None)
    graph = Graph('f', [arg], block0)
    check_optimize(graph, """\
arg = Argument('arg', GenericBitVector())
block0 = Block()
block0.next = Return(arg, None)
graph = Graph('f', [arg], block0)""")

def test_constfold_MachineInt():
    block0 = Block()
    i1 = block0.emit(Operation, '@unsigned_bv', [SmallBitVectorConstant(0xC03, SmallFixedBitVector(12)), MachineIntConstant(12)], MachineInt(), '`1 231:32-231:43', 'zz40')
    i2 = block0.emit(Operation, '@add_i_i_wrapped_res', [i1, MachineIntConstant(-75)], Int(), None, None)
    block0.next = Return(i2, None)
    graph = Graph('f', [], block0)
    check_optimize(graph, """\
block0 = Block()
block0.next = Return(IntConstant(3000), None)
graph = Graph('f', [], block0)""")

def test_constfold_SmallFixedBitVector():
    block0 = Block()
    i1 = block0.emit(Operation, '@zero_extend_bv_i_i', [SmallBitVectorConstant(0b1, SmallFixedBitVector(1)), MachineIntConstant(1), MachineIntConstant(39)], SmallFixedBitVector(39), None, None)
    block0.next = Return(i1, None)
    graph = Graph('f', [], block0)
    check_optimize(graph, """\
block0 = Block()
block0.next = Return(SmallBitVectorConstant(0b1, SmallFixedBitVector(39)), None)
graph = Graph('f', [], block0)""")

def test_truncate():
    arg = Argument('arg', SmallFixedBitVector(64))
    block0 = Block()
    i1 = block0.emit(Cast, '$cast', [arg], GenericBitVector(), None, None)
    i2 = block0.emit(Operation, '@sail_truncate_o_i', [i1, MachineIntConstant(64)], GenericBitVector(), '`4 80:17-80:31', 'return')
    i3 = block0.emit(Operation, '@sail_truncate_o_i', [i2, MachineIntConstant(52)], GenericBitVector(), '`4 80:17-80:31', 'return')
    i4 = block0.emit(Cast, '$cast', [i3], SmallFixedBitVector(52), None, None)
    block0.next = Return(i4, None)
    graph = Graph('f', [arg], block0)
    check_optimize(graph, """\
arg = Argument('arg', SmallFixedBitVector(64))
block0 = Block()
i1 = block0.emit(Operation, '@truncate_bv_i', [arg, MachineIntConstant(52)], SmallFixedBitVector(52), '`4 80:17-80:31', 'return')
block0.next = Return(i1, None)
graph = Graph('f', [arg], block0)""")

def test_remove_double_exception():
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block23 = Block()
    i2 = block0.emit(Operation, 'z__IMPDEF_integer_map', [], Int(), '`6 70:11-70:34', 'zz40')
    i3 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
    block0.next = ConditionalGoto(i3, block1, block23, '`6 70:11-70:34')
    block1.next = Goto(block2, None)
    i4 = block2.emit_phi([block23, block1], [i2, DefaultValue(Int())], Int())
    i5 = block2.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
    block2.next = ConditionalGoto(i5, block3, block4, '`7 1261:17-1261:66')
    block3.next = Return(DefaultValue(MachineInt()), None)
    i6 = block4.emit(Operation, '@eq_int_o_i', [i4, MachineIntConstant(32)], Bool(), '`7 1262:11-1262:22', 'zz46')
    block4.next = Goto(block5, None)
    block5.next = Goto(block6, None)
    i8 = block6.emit(Operation, 'zsail_assert', [i6, StringConstant('')], Unit(), '`7 1262:4-1263:17', 'zz45')
    i9 = block6.emit(Operation, 'zz5izDzKz5i64', [i4], MachineInt(), '`7 1263:4-1263:17', 'zz43')
    block6.next = Return(i9, None)
    block23.next = Goto(block2, None)
    graph = Graph('zAArch64_PAMax', [], block0)
    remove_double_exception_check(graph, fakecodegen)
    res = print_graph_construction(graph)
    got = "\n".join(res)
    assert got == '''\
block0 = Block()
block1 = Block()
block2 = Block()
i0 = block0.emit(Operation, 'z__IMPDEF_integer_map', [], Int(), '`6 70:11-70:34', 'zz40')
i1 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
block0.next = ConditionalGoto(i1, block1, block2, '`6 70:11-70:34')
block1.next = Return(DefaultValue(MachineInt()), None)
i2 = block2.emit(Operation, '@eq_int_o_i', [i0, MachineIntConstant(32)], Bool(), '`7 1262:11-1262:22', 'zz46')
i3 = block2.emit(Operation, 'zsail_assert', [i2, StringConstant('')], Unit(), '`7 1262:4-1263:17', 'zz45')
i4 = block2.emit(Operation, 'zz5izDzKz5i64', [i0], MachineInt(), '`7 1263:4-1263:17', 'zz43')
block2.next = Return(i4, None)
graph = Graph('zAArch64_PAMax', [], block0)'''

def test_anticipated_cast():
    arg = Argument('arg', GenericBitVector())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    block9 = Block()
    block10 = Block()
    block11 = Block()
    block12 = Block()
    block13 = Block()
    block14 = Block()
    block15 = Block()
    block16 = Block()
    block17 = Block()
    i0 = block0.emit(Operation, 'z__IMPDEF_integer_map', [], Int(), '`6 70:11-70:34', 'zz40')
    i1 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
    block0.next = ConditionalGoto(i1, block1, block2, '`6 70:11-70:34')
    block1.next = Return(DefaultValue(MachineInt()), None)
    i2 = block2.emit(Operation, '@eq_int_o_i', [i0, MachineIntConstant(32)], Bool(), '`7 1262:11-1262:22', 'zz46')
    block2.next = ConditionalGoto(i2, block3, block5, '`7 1262:11-1262:106')
    block3.next = Goto(block4, None)
    i3 = block4.emit_phi([block7, block3], [None, BooleanConstant.TRUE], Bool())
    i4 = block4.emit(Operation, 'zsail_assert', [i3, StringConstant('')], Unit(), '`7 1262:4-1263:17', 'zz45')
    i5 = block4.emit(Operation, 'zz5izDzKz5i64', [i0], MachineInt(), '`7 1263:4-1263:17', 'zz43')
    block4.next = Return(i5, None)
    i6 = block5.emit(Operation, '@eq_int_o_i', [i0, MachineIntConstant(36)], Bool(), '`7 1262:25-1262:36', 'zz48')
    block5.next = ConditionalGoto(i6, block6, block8, '`7 1262:25-1262:106')
    block6.next = Goto(block7, None)
    i7 = block7.emit_phi([block10, block6], [None, BooleanConstant.TRUE], Bool())
    i3.prevvalues[0] = i7
    block7.next = Goto(block4, None)
    i8 = block8.emit(Operation, '@eq_int_o_i', [i0, MachineIntConstant(40)], Bool(), '`7 1262:39-1262:50', 'zz410')
    block8.next = ConditionalGoto(i8, block9, block11, '`7 1262:39-1262:106')
    block9.next = Goto(block10, None)
    i9 = block10.emit_phi([block13, block9], [None, BooleanConstant.TRUE], Bool())
    i7.prevvalues[0] = i9
    block10.next = Goto(block7, None)
    i10 = block11.emit(Operation, '@eq_int_o_i', [i0, MachineIntConstant(42)], Bool(), '`7 1262:53-1262:64', 'zz412')
    block11.next = ConditionalGoto(i10, block12, block14, '`7 1262:53-1262:106')
    block12.next = Goto(block13, None)
    i11 = block13.emit_phi([block16, block12], [None, BooleanConstant.TRUE], Bool())
    i9.prevvalues[0] = i11
    i100 = block13.emit(Cast, '$cast', [arg], SmallFixedBitVector(64), None, None)
    block13.next = Goto(block10, None)
    i12 = block14.emit(Operation, '@eq_int_o_i', [i0, MachineIntConstant(44)], Bool(), '`7 1262:67-1262:78', 'zz414')
    block14.next = ConditionalGoto(i12, block15, block17, '`7 1262:67-1262:106')
    block15.next = Goto(block16, None)
    i13 = block16.emit_phi([block17, block15], [None, BooleanConstant.TRUE], Bool())
    i11.prevvalues[0] = i13
    block16.next = Goto(block13, None)
    i14 = block17.emit(Operation, '@eq_int_o_i', [i0, MachineIntConstant(48)], Bool(), '`7 1262:81-1262:92', 'zz416')
    block17.next = Goto(block16, None)
    i13.prevvalues[0] = i14
    graph = Graph('zAArch64_PAMax', [arg], block0)
    casts = find_anticipated_casts(graph)
    for block in graph.iterblocks():
        s = casts[block]
        if block in (block0, block1):
            assert s == set()
        elif block in (block11, block12, block13, block14, block15, block16, block17):
            assert s == {(arg, SmallFixedBitVector(64)), (i0, MachineInt())}
        else:
            assert s == {(i0, MachineInt())}
    check_optimize(graph, '''
arg = Argument('arg', GenericBitVector())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
block8 = Block()
block9 = Block()
block10 = Block()
block11 = Block()
block12 = Block()
block13 = Block()
i1 = block0.emit(Operation, 'z__IMPDEF_integer_map', [], Int(), '`6 70:11-70:34', 'zz40')
i2 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
block0.next = ConditionalGoto(i2, block1, block2, '`6 70:11-70:34')
block1.next = Return(DefaultValue(MachineInt()), None)
i3 = block2.emit(Operation, 'zz5izDzKz5i64', [i1], MachineInt(), None, None)
i4 = block2.emit(Operation, '@eq', [i3, MachineIntConstant(32)], Bool(), '`7 1262:11-1262:22', 'zz46')
block2.next = ConditionalGoto(i4, block3, block5, '`7 1262:11-1262:106')
block3.next = Goto(block4, None)
i5 = block4.emit_phi([block13, block12, block10, block8, block6, block3], [None, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE], Bool())
i6 = block4.emit(Operation, 'zsail_assert', [i5, StringConstant('')], Unit(), '`7 1262:4-1263:17', 'zz45')
block4.next = Return(i3, None)
i7 = block5.emit(Operation, '@eq', [i3, MachineIntConstant(36)], Bool(), '`7 1262:25-1262:36', 'zz48')
block5.next = ConditionalGoto(i7, block6, block7, '`7 1262:25-1262:106')
block6.next = Goto(block4, None)
i8 = block7.emit(Operation, '@eq', [i3, MachineIntConstant(40)], Bool(), '`7 1262:39-1262:50', 'zz410')
block7.next = ConditionalGoto(i8, block8, block9, '`7 1262:39-1262:106')
block8.next = Goto(block4, None)
i9 = block9.emit(Operation, '@eq', [i3, MachineIntConstant(42)], Bool(), '`7 1262:53-1262:64', 'zz412')
block9.next = ConditionalGoto(i9, block10, block11, '`7 1262:53-1262:106')
block10.next = Goto(block4, None)
i10 = block11.emit(Operation, '@eq', [i3, MachineIntConstant(44)], Bool(), '`7 1262:67-1262:78', 'zz414')
block11.next = ConditionalGoto(i10, block12, block13, '`7 1262:67-1262:106')
block12.next = Goto(block4, None)
i11 = block13.emit(Operation, '@eq', [i3, MachineIntConstant(48)], Bool(), '`7 1262:81-1262:92', 'zz416')
i5.prevvalues[0] = i11
block13.next = Goto(block4, None)
graph = Graph('zAArch64_PAMax', [arg], block0)
''')

def test_anticipated_cast_bv():
    zv = Argument('zv', SmallFixedBitVector(32))
    zshift = Argument('zshift', SmallFixedBitVector(5))
    block0 = Block()
    i2 = block0.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(64)], Int(), '`1 252:25-252:39', 'zz49')
    i3 = block0.emit(Cast, '$cast', [zv], GenericBitVector(), '`1 252:25-252:39', 'zz410')
    i4 = block0.emit(Comment, 'inlined zsign_extend', [], Unit(), None, None)
    i5 = block0.emit(Operation, 'zz5izDzKz5i64', [i2], MachineInt(), None, None)
    i6 = block0.emit(Operation, '@sign_extend_o_i', [i3, i5], GenericBitVector(), '`1 193:29-193:51', 'return')
    i7 = block0.emit(Cast, '$cast', [i6], SmallFixedBitVector(64), '`1 252:25-252:39', 'zz40')
    i8 = block0.emit(Cast, '$cast', [i7], GenericBitVector(), '`1 253:5-253:17', 'zz46')
    i9 = block0.emit(Cast, '$cast', [zshift], GenericBitVector(), '`1 253:5-253:17', 'zz47')
    i10 = block0.emit(Operation, 'shift_bits_right', [i8, i9], GenericBitVector(), '`1 253:5-253:17', 'zz48')
    i11 = block0.emit(Cast, '$cast', [i10], SmallFixedBitVector(64), '`1 253:5-253:17', 'zz41')
    i12 = block0.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(31)], Int(), '`1 253:4-253:25', 'zz42')
    i13 = block0.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(0)], Int(), '`1 253:4-253:25', 'zz43')
    i14 = block0.emit(Cast, '$cast', [i11], GenericBitVector(), '`1 253:4-253:25', 'zz44')
    i15 = block0.emit(Operation, 'vector_subrange', [i14, i12, i13], GenericBitVector(), '`1 253:4-253:25', 'zz45')
    i16 = block0.emit(Cast, '$cast', [i15], SmallFixedBitVector(32), '`1 253:4-253:25', 'return')
    block0.next = Return(i16, None)
    graph = Graph('zshift_right_arith32', [zv, zshift], block0)
    check_optimize(graph, '''
zv = Argument('zv', SmallFixedBitVector(32))
zshift = Argument('zshift', SmallFixedBitVector(5))
block0 = Block()
i2 = block0.emit(Comment, 'inlined zsign_extend', [], Unit(), None, None)
i3 = block0.emit(Operation, '@sign_extend_bv_i_i', [zv, MachineIntConstant(32), MachineIntConstant(64)], SmallFixedBitVector(64), '`1 193:29-193:51', 'return')
i4 = block0.emit(Operation, '@unsigned_bv', [zshift, MachineIntConstant(5)], MachineInt(), None, None)
i5 = block0.emit(Operation, '@shiftr_bv_i', [i3, MachineIntConstant(64), i4], SmallFixedBitVector(64), '`1 253:5-253:17', 'zz48')
i6 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [i5, MachineIntConstant(31), MachineIntConstant(0)], SmallFixedBitVector(32), '`1 253:4-253:25', 'zz45')
block0.next = Return(i6, None)
graph = Graph('zshift_right_arith32', [zv, zshift], block0)
''')

def test_cse():
    zaddr = Argument('zaddr', SmallFixedBitVector(64))
    zwidth = Argument('zwidth', SmallFixedBitVector(64))
    bv1 = Argument('bv1', GenericBitVector())
    bv2 = Argument('bv2', GenericBitVector())
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    block9 = Block()
    block10 = Block()
    block11 = Block()
    block12 = Block()
    block13 = Block()
    block14 = Block()
    block15 = Block()
    block16 = Block()
    block17 = Block()
    block18 = Block()
    block19 = Block()
    block20 = Block()
    i10 = block3.emit(Operation, 'sail_unsigned', [bv2], Int(), '`1 231:32-231:43', 'zz40')
    i11 = block3.emit(Operation, 'sail_unsigned', [bv1], Int(), '`1 231:47-231:58', 'zz41')
    i12 = block3.emit(Operation, 'lteq', [i10, i11], Bool(), '`1 231:32-231:58', 'return')
    block3.next = ConditionalGoto(i12, block4, block7, '`14 127:22-135:23')
    i13 = block4.emit(GlobalRead, 'zPMP_NoMatch', [], Int(), None, None)
    block4.next = Goto(block5, None)
    i14 = block5.emit_phi([block11, block4], [None, i13], Int())
    block5.next = Goto(block6, None)
    block6.next = Return(i14, None)
    i16 = block7.emit(Operation, '@add_bits_bv_bv', [zaddr, zwidth, MachineIntConstant(64)], SmallFixedBitVector(64), '`14 130:33-130:45', 'zz425')
    i18 = block7.emit(Operation, '@unsigned_bv_wrapped_res', [i16, MachineIntConstant(64)], Int(), '`1 231:32-231:43', 'zz40')
    i19 = block7.emit(Operation, 'sail_unsigned', [bv1], Int(), '`1 231:47-231:58', 'zz41')
    i20 = block7.emit(Operation, 'lteq', [i18, i19], Bool(), '`1 231:32-231:58', 'return')
    block7.next = ConditionalGoto(i20, block8, block19, '`14 130:32-130:71')
    block8.next = Goto(block9, None)
    i21 = block9.emit_phi([block19, block8], [None, BooleanConstant.TRUE], Bool())
    block9.next = ConditionalGoto(i21, block10, block12, '`14 130:24-134:48')
    i22 = block10.emit(GlobalRead, 'zPMP_NoMatch', [], Int(), None, None)
    block10.next = Goto(block11, None)
    i23 = block11.emit_phi([block16, block10], [None, i22], Int())
    i14.prevvalues[0] = i23
    block11.next = Goto(block5, None)
    i25 = block12.emit(Operation, 'sail_unsigned', [bv1], Int(), '`1 231:32-231:43', 'zz40')
    i26 = block12.emit(Operation, '@unsigned_bv_wrapped_res', [zaddr, MachineIntConstant(64)], Int(), '`1 231:47-231:58', 'zz41')
    i27 = block12.emit(Operation, 'lteq', [i25, i26], Bool(), '`1 231:32-231:58', 'return')
    block12.next = ConditionalGoto(i27, block13, block18, '`14 132:32-132:71')
    i28 = block13.emit(Operation, '@add_bits_bv_bv', [zaddr, zwidth, MachineIntConstant(64)], SmallFixedBitVector(64), '`14 132:50-132:62', 'zz413')
    i30 = block13.emit(Operation, '@unsigned_bv_wrapped_res', [i28, MachineIntConstant(64)], Int(), '`1 231:32-231:43', 'zz40')
    i31 = block13.emit(Operation, 'sail_unsigned', [bv2], Int(), '`1 231:47-231:58', 'zz41')
    i32 = block13.emit(Operation, 'lteq', [i30, i31], Bool(), '`1 231:32-231:58', 'return')
    block13.next = Goto(block14, None)
    i33 = block14.emit_phi([block18, block13], [BooleanConstant.FALSE, i32], Bool())
    block14.next = ConditionalGoto(i33, block15, block17, '`14 132:29-134:48')
    i34 = block15.emit(GlobalRead, 'zPMP_Match', [], Int(), None, None)
    block15.next = Goto(block16, None)
    i35 = block16.emit_phi([block17, block15], [None, i34], Int())
    i23.prevvalues[0] = i35
    block16.next = Goto(block11, None)
    i36 = block17.emit(GlobalRead, 'zPMP_PartialMatch', [], Int(), None, None)
    i35.prevvalues[0] = i36
    block17.next = Goto(block16, None)
    block18.next = Goto(block14, None)
    i38 = block19.emit(Operation, 'sail_unsigned', [bv2], Int(), '`1 231:32-231:43', 'zz40')
    i39 = block19.emit(Operation, '@unsigned_bv_wrapped_res', [zaddr, MachineIntConstant(64)], Int(), '`1 231:47-231:58', 'zz41')
    i40 = block19.emit(Operation, 'lteq', [i38, i39], Bool(), '`1 231:32-231:58', 'return')
    i21.prevvalues[0] = i40
    block19.next = Goto(block9, None)
    block20.next = Goto(block6, None)
    graph = Graph('match', [zaddr, zwidth, bv1, bv2], block3)
    BaseOptimizer(graph, fakecodegen).optimize()
    res = print_graph_construction(graph)
    got = "\n".join(res)
    assert got == '''\
zaddr = Argument('zaddr', SmallFixedBitVector(64))
zwidth = Argument('zwidth', SmallFixedBitVector(64))
bv1 = Argument('bv1', GenericBitVector())
bv2 = Argument('bv2', GenericBitVector())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
block8 = Block()
block9 = Block()
block10 = Block()
block11 = Block()
block12 = Block()
block13 = Block()
block14 = Block()
block15 = Block()
block16 = Block()
i4 = block0.emit(Operation, 'sail_unsigned', [bv2], Int(), '`1 231:32-231:43', 'zz40')
i5 = block0.emit(Operation, 'sail_unsigned', [bv1], Int(), '`1 231:47-231:58', 'zz41')
i6 = block0.emit(Operation, 'lteq', [i4, i5], Bool(), '`1 231:32-231:58', 'return')
block0.next = ConditionalGoto(i6, block1, block4, '`14 127:22-135:23')
i7 = block1.emit(GlobalRead, 'zPMP_NoMatch', [], Int(), None, None)
block1.next = Goto(block2, None)
i8 = block2.emit_phi([block8, block1], [None, i7], Int())
block2.next = Goto(block3, None)
block3.next = Return(i8, None)
i9 = block4.emit(Operation, '@add_bits_bv_bv', [zaddr, zwidth, MachineIntConstant(64)], SmallFixedBitVector(64), '`14 130:33-130:45', 'zz425')
i10 = block4.emit(Operation, '@unsigned_bv_wrapped_res', [i9, MachineIntConstant(64)], Int(), '`1 231:32-231:43', 'zz40')
i11 = block4.emit(Operation, 'lteq', [i10, i5], Bool(), '`1 231:32-231:58', 'return')
block4.next = ConditionalGoto(i11, block5, block16, '`14 130:32-130:71')
block5.next = Goto(block6, None)
i12 = block6.emit_phi([block16, block5], [None, BooleanConstant.TRUE], Bool())
block6.next = ConditionalGoto(i12, block7, block9, '`14 130:24-134:48')
i13 = block7.emit(GlobalRead, 'zPMP_NoMatch', [], Int(), None, None)
block7.next = Goto(block8, None)
i14 = block8.emit_phi([block13, block7], [None, i13], Int())
i8.prevvalues[0] = i14
block8.next = Goto(block2, None)
i15 = block9.emit(Operation, '@unsigned_bv_wrapped_res', [zaddr, MachineIntConstant(64)], Int(), '`1 231:47-231:58', 'zz41')
i16 = block9.emit(Operation, 'lteq', [i5, i15], Bool(), '`1 231:32-231:58', 'return')
block9.next = ConditionalGoto(i16, block10, block15, '`14 132:32-132:71')
i17 = block10.emit(Operation, 'lteq', [i10, i4], Bool(), '`1 231:32-231:58', 'return')
block10.next = Goto(block11, None)
i18 = block11.emit_phi([block15, block10], [BooleanConstant.FALSE, i17], Bool())
block11.next = ConditionalGoto(i18, block12, block14, '`14 132:29-134:48')
i19 = block12.emit(GlobalRead, 'zPMP_Match', [], Int(), None, None)
block12.next = Goto(block13, None)
i20 = block13.emit_phi([block14, block12], [None, i19], Int())
i14.prevvalues[0] = i20
block13.next = Goto(block8, None)
i21 = block14.emit(GlobalRead, 'zPMP_PartialMatch', [], Int(), None, None)
i20.prevvalues[0] = i21
block14.next = Goto(block13, None)
block15.next = Goto(block11, None)
i22 = block16.emit(Operation, '@unsigned_bv_wrapped_res', [zaddr, MachineIntConstant(64)], Int(), '`1 231:47-231:58', 'zz41')
i23 = block16.emit(Operation, 'lteq', [i4, i22], Bool(), '`1 231:32-231:58', 'return')
i12.prevvalues[0] = i23
block16.next = Goto(block6, None)
graph = Graph('match', [zaddr, zwidth, bv1, bv2], block0)'''

def test_cse_phi():
    zb = Argument('zb', Bool())
    zi = Argument('zi', MachineInt())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block0.next = ConditionalGoto(zb, block1, block4, '`1 13:27-16:1')
    block1.next = Goto(block2, None)
    block2.next = Goto(block3, None)
    i4 = block3.emit_phi([block2, block5], [MachineIntConstant(1), MachineIntConstant(2)], MachineInt())
    i5 = block3.emit_phi([block2, block5], [MachineIntConstant(1), MachineIntConstant(2)], MachineInt())
    i6 = block3.emit_phi([block2, block5], [zi, MachineIntConstant(2)], MachineInt())
    i7 = block3.emit_phi([block2, block5], [zi, MachineIntConstant(2)], MachineInt())
    i8 = block3.emit(Operation, "@add_i_i_wrapped_res", [i4, i6], Int())
    i9 = block3.emit(Operation, "@add_i_i_wrapped_res", [i5, i7], Int())
    i10 = block3.emit(Operation, "add_int", [i8, i9], Int())
    block3.next = Return(i10, None)
    block4.next = Goto(block5, None)
    block5.next = Goto(block3, None)
    graph = Graph('zbits1_to_bool', [zb, zi], block0)
    check_optimize(graph, '''
zb = Argument('zb', Bool())
zi = Argument('zi', MachineInt())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block0.next = ConditionalGoto(zb, block1, block3, '`1 13:27-16:1')
block1.next = Goto(block2, None)
i2 = block2.emit_phi([block1, block3], [MachineIntConstant(1), MachineIntConstant(2)], MachineInt())
i3 = block2.emit_phi([block1, block3], [zi, MachineIntConstant(2)], MachineInt())
i4 = block2.emit(Operation, '@add_i_i_wrapped_res', [i2, i3], Int(), None, None)
i5 = block2.emit(Operation, 'add_int', [i4, i4], Int(), None, None)
block2.next = Return(i5, None)
block3.next = Goto(block2, None)
graph = Graph('zbits1_to_bool', [zb, zi], block0)
''')

def test_rotater():
    zv = Argument('zv', GenericBitVector())
    zn = Argument('zn', Int())
    block0 = Block()
    i2 = block0.emit(Operation, 'zz5izDzKz5i64', [zn], MachineInt(), None, None)
    i3 = block0.emit(Operation, '@shiftr_o_i', [zv, i2], GenericBitVector(), '`1 268:5-268:11', 'zz40')
    i4 = block0.emit(Operation, '@length_unwrapped_res', [zv], MachineInt(), '`1 268:22-268:31', 'zz43')
    i5 = block0.emit(Operation, 'zz5i64zDzKz5i', [i4], Int(), '`1 268:22-268:31', None)
    i6 = block0.emit(Operation, 'sub_int', [i5, zn], Int(), '`1 268:22-268:35', 'zz42')
    i7 = block0.emit(Operation, 'zz5izDzKz5i64', [i6], MachineInt(), None, None)
    i8 = block0.emit(Operation, '@shiftl_o_i', [zv, i7], GenericBitVector(), '`1 268:16-268:36', 'zz41')
    i9 = block0.emit(Operation, 'or_bits', [i3, i8], GenericBitVector(), '`1 268:4-268:37', 'return')
    block0.next = Return(i9, None)
    graph = Graph('zrotater', [zv, zn], block0)
    check_optimize(graph, '''
zv = Argument('zv', GenericBitVector())
zn = Argument('zn', Int())
block0 = Block()
i2 = block0.emit(Operation, 'zz5izDzKz5i64', [zn], MachineInt(), None, None)
i3 = block0.emit(Operation, '@shiftr_o_i', [zv, i2], GenericBitVector(), '`1 268:5-268:11', 'zz40')
i4 = block0.emit(Operation, '@length_unwrapped_res', [zv], MachineInt(), '`1 268:22-268:31', 'zz43')
i5 = block0.emit(Operation, '@sub_i_i_must_fit', [i4, i2], MachineInt(), '`1 268:22-268:35', 'zz42')
i6 = block0.emit(Operation, '@shiftl_o_i', [zv, i5], GenericBitVector(), '`1 268:16-268:36', 'zz41')
i7 = block0.emit(Operation, 'or_bits', [i3, i6], GenericBitVector(), '`1 268:4-268:37', 'return')
block0.next = Return(i7, None)
graph = Graph('zrotater', [zv, zn], block0)
''')

def test_lshift_must_fit():
    bv = Argument('bv', SmallFixedBitVector(3))
    block0 = Block()
    i73 = block0.emit(Operation, '@unsigned_bv', [bv, MachineIntConstant(3)], MachineInt(), '`7 9787:34-9787:48', 'zz433')
    i76 = block0.emit(Operation, '@shl_int_i_i_wrapped_res', [i73, MachineIntConstant(3)], Int(), '`7 9573:21-9573:30', 'zz40')
    i78 = block0.emit(Operation, 'zz5izDzKz5i64', [i76], MachineInt(), None, None)
    block0.next = Return(i78, None)
    graph = Graph('g', [bv], block0)
    check_optimize(graph, '''
bv = Argument('bv', SmallFixedBitVector(3))
block0 = Block()
i1 = block0.emit(Operation, '@unsigned_bv', [bv, MachineIntConstant(3)], MachineInt(), '`7 9787:34-9787:48', 'zz433')
i2 = block0.emit(Operation, '@shl_int_i_i_must_fit', [i1, MachineIntConstant(3)], MachineInt(), '`7 9573:21-9573:30', 'zz40')
block0.next = Return(i2, None)
graph = Graph('g', [bv], block0)
''')

def test_is_ones_subrange():
    zxs = Argument('zxs', GenericBitVector())
    zi = Argument('zi', Int())
    zj = Argument('zj', Int())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    i3 = block0.emit(Operation, '@length_unwrapped_res', [zxs], MachineInt(), '`3', 'zz42')
    i4 = block0.emit(Operation, 'zz5i64zDzKz5i', [i3], Int(), '`3', None)
    i5 = block0.emit(Operation, 'sub_int', [zi, zj], Int(), '`4 116:34-116:37', 'zz44')
    i6 = block0.emit(Operation, '@add_o_i_wrapped_res', [i5, MachineIntConstant(1)], Int(), '`4 116:34-116:39', 'zz43')
    i8 = block0.emit(Operation, 'gteq_int', [i6, i4], Bool(), '`2 336:5-336:11', 'zz40')
    block0.next = ConditionalGoto(i8, block1, block3, '`2 336:2-341:3')
    i10 = block1.emit(Operation, '@zeros_i', [i3], GenericBitVector(), '`2 320:32-320:45', 'zz40')
    i11 = block1.emit(Operation, 'not_bits', [i10], GenericBitVector(), '`2 320:24-320:46', 'return')
    i12 = block1.emit(Operation, 'zz5izDzKz5i64', [zj], MachineInt(), None, None)
    i13 = block1.emit(Operation, '@shiftl_o_i', [i11, i12], GenericBitVector(), '`2 337:4-337:35', 'return')
    block1.next = Goto(block2, None)
    i14 = block2.emit_phi([block5, block1], [None, i13], GenericBitVector())
    i15 = block2.emit(Operation, 'and_bits', [zxs, i14], GenericBitVector(), '`4 117:3-117:9', 'zz41')
    i16 = block2.emit(Operation, 'eq_bits', [i15, i14], Bool(), '`4 117:2-117:15', 'return')
    block2.next = Return(i16, None)
    i17 = block3.emit(Operation, 'zz5izDzKz5i64', [i6], MachineInt(), None, None)
    i18 = block3.emit(Cast, '$cast', [SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], GenericBitVector(), '`2 339:25-339:57', 'zz46')
    i20 = block3.emit(Operation, '@lteq', [i3, MachineIntConstant(1)], Bool(), '`2 141:32-141:48', 'zz40')
    block3.next = ConditionalGoto(i20, block4, block6, '`2 141:29-141:100')
    i21 = block4.emit(Operation, '@sail_truncate_o_i', [i18, i3], GenericBitVector(), '`2 141:54-141:70', 'return')
    block4.next = Goto(block5, None)
    i22 = block5.emit_phi([block6, block4], [None, i21], GenericBitVector())
    i23 = block5.emit(Operation, '@shiftl_o_i', [i22, i17], GenericBitVector(), '`2 340:28-340:50', 'zz44')
    i24 = block5.emit(Operation, 'sub_int', [i23, i22], GenericBitVector(), '`2 340:19-340:56', 'zz43')
    i25 = block5.emit(Operation, 'zz5izDzKz5i64', [zj], MachineInt(), None, None)
    i26 = block5.emit(Operation, '@shiftl_o_i', [i24, i25], GenericBitVector(), '`2 340:4-340:60', 'return')
    i14.prevvalues[0] = i26
    block5.next = Goto(block2, None)
    i27 = block6.emit(Operation, '@zero_extend_o_i', [i18, i3], GenericBitVector(), '`2 141:76-141:100', 'return')
    i22.prevvalues[0] = i27
    block6.next = Goto(block5, None)
    graph = Graph('zis_ones_subrange', [zxs, zi, zj], block0)
    check_optimize(graph, '''
zxs = Argument('zxs', GenericBitVector())
zi = Argument('zi', Int())
zj = Argument('zj', Int())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
i3 = block0.emit(Operation, '@length_unwrapped_res', [zxs], MachineInt(), '`3', 'zz42')
i4 = block0.emit(Operation, 'zz5i64zDzKz5i', [i3], Int(), '`3', None)
i5 = block0.emit(Operation, 'zz5izDzKz5i64', [zj], MachineInt(), None, None)
i6 = block0.emit(Operation, '@sub_o_i_wrapped_res', [zi, i5], Int(), '`4 116:34-116:37', 'zz44')
i7 = block0.emit(Operation, '@add_o_i_wrapped_res', [i6, MachineIntConstant(1)], Int(), '`4 116:34-116:39', 'zz43')
i8 = block0.emit(Operation, 'gteq_int', [i7, i4], Bool(), '`2 336:5-336:11', 'zz40')
block0.next = ConditionalGoto(i8, block1, block3, '`2 336:2-341:3')
i9 = block1.emit(Operation, '@ones_i', [i3], GenericBitVector(), '`2 320:32-320:45', None)
i10 = block1.emit(Operation, '@shiftl_o_i', [i9, i5], GenericBitVector(), '`2 337:4-337:35', 'return')
block1.next = Goto(block2, None)
i11 = block2.emit_phi([block5, block1], [None, i10], GenericBitVector())
i12 = block2.emit(Operation, 'and_bits', [zxs, i11], GenericBitVector(), '`4 117:3-117:9', 'zz41')
i13 = block2.emit(Operation, 'eq_bits', [i12, i11], Bool(), '`4 117:2-117:15', 'return')
block2.next = Return(i13, None)
i14 = block3.emit(Operation, 'zz5izDzKz5i64', [i7], MachineInt(), None, None)
i15 = block3.emit(Cast, '$cast', [SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], GenericBitVector(), '`2 339:25-339:57', 'zz46')
i16 = block3.emit(Operation, '@lteq', [i3, MachineIntConstant(1)], Bool(), '`2 141:32-141:48', 'zz40')
block3.next = ConditionalGoto(i16, block4, block6, '`2 141:29-141:100')
i17 = block4.emit(Operation, '@sail_truncate_o_i', [i15, i3], GenericBitVector(), '`2 141:54-141:70', 'return')
block4.next = Goto(block5, None)
i18 = block5.emit_phi([block6, block4], [None, i17], GenericBitVector())
i19 = block5.emit(Operation, '@shiftl_o_i', [i18, i14], GenericBitVector(), '`2 340:28-340:50', 'zz44')
i20 = block5.emit(Operation, 'sub_int', [i19, i18], GenericBitVector(), '`2 340:19-340:56', 'zz43')
i21 = block5.emit(Operation, '@shiftl_o_i', [i20, i5], GenericBitVector(), '`2 340:4-340:60', 'return')
i11.prevvalues[0] = i21
block5.next = Goto(block2, None)
i22 = block6.emit(Operation, '@zero_extend_o_i', [i15, i3], GenericBitVector(), '`2 141:76-141:100', 'return')
i18.prevvalues[0] = i22
block6.next = Goto(block5, None)
graph = Graph('zis_ones_subrange', [zxs, zi, zj], block0)
''')

def test_read_kind_of_flags():
    zaq = Argument('zaq', Bool())
    zrl = Argument('zrl', Bool())
    zres = Argument('zres', Bool())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    block9 = Block()
    block10 = Block()
    block11 = Block()
    block12 = Block()
    block13 = Block()
    block14 = Block()
    block15 = Block()
    block16 = Block()
    block17 = Block()
    block18 = Block()
    block19 = Block()
    block20 = Block()
    block21 = Block()
    block22 = Block()
    block23 = Block()
    block24 = Block()
    block25 = Block()
    block26 = Block()
    block27 = Block()
    block28 = Block()
    block29 = Block()
    block30 = Block()
    block31 = Block()
    block32 = Block()
    block33 = Block()
    block34 = Block()
    block35 = Block()
    block36 = Block()
    block37 = Block()
    block38 = Block()
    block39 = Block()
    block40 = Block()
    block41 = Block()
    block42 = Block()
    block43 = Block()
    block44 = Block()
    block45 = Block()
    block46 = Block()
    block47 = Block()
    block48 = Block()
    block49 = Block()
    block50 = Block()
    block51 = Block()
    block52 = Block()
    block53 = Block()
    block54 = Block()
    block55 = Block()
    block56 = Block()
    block57 = Block()
    block58 = Block()
    block59 = Block()
    block60 = Block()
    block61 = Block()
    block62 = Block()
    block63 = Block()
    block64 = Block()
    block65 = Block()
    i3 = block0.emit(Operation, 'eq_bool', [zres, BooleanConstant.FALSE], Bool(), '`3490', 'zz463')
    block0.next = ConditionalGoto(i3, block1, block65, '`27 105:4-105:45')
    i4 = block1.emit(Operation, 'eq_bool', [zrl, BooleanConstant.FALSE], Bool(), '`3491', 'zz464')
    block1.next = Goto(block2, None)
    i5 = block2.emit_phi([block65, block1], [BooleanConstant.FALSE, i4], Bool())
    block2.next = ConditionalGoto(i5, block3, block64, '`27 105:4-105:45')
    i6 = block3.emit(Operation, 'eq_bool', [zaq, BooleanConstant.FALSE], Bool(), '`3492', 'zz461')
    block3.next = Goto(block4, None)
    i7 = block4.emit_phi([block64, block3], [BooleanConstant.FALSE, i6], Bool())
    block4.next = ConditionalGoto(i7, block5, block7, '`27 104:2-113:3')
    i8 = block5.emit(GlobalRead, 'zRead_plain', [], Int(), None, None)
    i9 = block5.emit(Operation, 'zSomezIEread_kindz5zK', [i8], Int(), '`27 105:29-105:45', 'zz40')
    block5.next = Goto(block6, None)
    i10 = block6.emit_phi([block5, block12, block18, block24, block30, block36, block42, block48], [i9, None, None, None, None, None, None, None], Int())
    block6.next = Return(i10, None)
    i11 = block7.emit(Operation, 'eq_bool', [zres, BooleanConstant.FALSE], Bool(), '`3493', 'zz455')
    block7.next = ConditionalGoto(i11, block8, block63, '`27 106:4-106:53')
    i12 = block8.emit(Operation, 'eq_bool', [zrl, BooleanConstant.FALSE], Bool(), '`3494', 'zz456')
    block8.next = Goto(block9, None)
    i13 = block9.emit_phi([block63, block8], [BooleanConstant.FALSE, i12], Bool())
    block9.next = ConditionalGoto(i13, block10, block62, '`27 106:4-106:53')
    i14 = block10.emit(Operation, 'eq_bool', [zaq, BooleanConstant.TRUE], Bool(), '`3495', 'zz453')
    block10.next = Goto(block11, None)
    i15 = block11.emit_phi([block62, block10], [BooleanConstant.FALSE, i14], Bool())
    block11.next = ConditionalGoto(i15, block12, block13, '`27 104:2-113:3')
    i16 = block12.emit(GlobalRead, 'zRead_RISCV_acquire', [], Int(), None, None)
    i17 = block12.emit(Operation, 'zSomezIEread_kindz5zK', [i16], Int(), '`27 106:29-106:53', 'zz40')
    i10.prevvalues[1] = i17
    block12.next = Goto(block6, None)
    i18 = block13.emit(Operation, 'eq_bool', [zres, BooleanConstant.FALSE], Bool(), '`3496', 'zz447')
    block13.next = ConditionalGoto(i18, block14, block61, '`27 107:4-107:60')
    i19 = block14.emit(Operation, 'eq_bool', [zrl, BooleanConstant.TRUE], Bool(), '`3497', 'zz448')
    block14.next = Goto(block15, None)
    i20 = block15.emit_phi([block61, block14], [BooleanConstant.FALSE, i19], Bool())
    block15.next = ConditionalGoto(i20, block16, block60, '`27 107:4-107:60')
    i21 = block16.emit(Operation, 'eq_bool', [zaq, BooleanConstant.TRUE], Bool(), '`3498', 'zz445')
    block16.next = Goto(block17, None)
    i22 = block17.emit_phi([block60, block16], [BooleanConstant.FALSE, i21], Bool())
    block17.next = ConditionalGoto(i22, block18, block19, '`27 104:2-113:3')
    i23 = block18.emit(GlobalRead, 'zRead_RISCV_strong_acquire', [], Int(), None, None)
    i24 = block18.emit(Operation, 'zSomezIEread_kindz5zK', [i23], Int(), '`27 107:29-107:60', 'zz40')
    i10.prevvalues[2] = i24
    block18.next = Goto(block6, None)
    i25 = block19.emit(Operation, 'eq_bool', [zres, BooleanConstant.TRUE], Bool(), '`3499', 'zz439')
    block19.next = ConditionalGoto(i25, block20, block59, '`27 108:4-108:54')
    i26 = block20.emit(Operation, 'eq_bool', [zrl, BooleanConstant.FALSE], Bool(), '`3500', 'zz440')
    block20.next = Goto(block21, None)
    i27 = block21.emit_phi([block59, block20], [BooleanConstant.FALSE, i26], Bool())
    block21.next = ConditionalGoto(i27, block22, block58, '`27 108:4-108:54')
    i28 = block22.emit(Operation, 'eq_bool', [zaq, BooleanConstant.FALSE], Bool(), '`3501', 'zz437')
    block22.next = Goto(block23, None)
    i29 = block23.emit_phi([block58, block22], [BooleanConstant.FALSE, i28], Bool())
    block23.next = ConditionalGoto(i29, block24, block25, '`27 104:2-113:3')
    i30 = block24.emit(GlobalRead, 'zRead_RISCV_reserved', [], Int(), None, None)
    i31 = block24.emit(Operation, 'zSomezIEread_kindz5zK', [i30], Int(), '`27 108:29-108:54', 'zz40')
    i10.prevvalues[3] = i31
    block24.next = Goto(block6, None)
    i32 = block25.emit(Operation, 'eq_bool', [zres, BooleanConstant.TRUE], Bool(), '`3502', 'zz431')
    block25.next = ConditionalGoto(i32, block26, block57, '`27 109:4-109:62')
    i33 = block26.emit(Operation, 'eq_bool', [zrl, BooleanConstant.FALSE], Bool(), '`3503', 'zz432')
    block26.next = Goto(block27, None)
    i34 = block27.emit_phi([block57, block26], [BooleanConstant.FALSE, i33], Bool())
    block27.next = ConditionalGoto(i34, block28, block56, '`27 109:4-109:62')
    i35 = block28.emit(Operation, 'eq_bool', [zaq, BooleanConstant.TRUE], Bool(), '`3504', 'zz429')
    block28.next = Goto(block29, None)
    i36 = block29.emit_phi([block56, block28], [BooleanConstant.FALSE, i35], Bool())
    block29.next = ConditionalGoto(i36, block30, block31, '`27 104:2-113:3')
    i37 = block30.emit(GlobalRead, 'zRead_RISCV_reserved_acquire', [], Int(), None, None)
    i38 = block30.emit(Operation, 'zSomezIEread_kindz5zK', [i37], Int(), '`27 109:29-109:62', 'zz40')
    i10.prevvalues[4] = i38
    block30.next = Goto(block6, None)
    i39 = block31.emit(Operation, 'eq_bool', [zres, BooleanConstant.TRUE], Bool(), '`3505', 'zz423')
    block31.next = ConditionalGoto(i39, block32, block55, '`27 110:4-110:69')
    i40 = block32.emit(Operation, 'eq_bool', [zrl, BooleanConstant.TRUE], Bool(), '`3506', 'zz424')
    block32.next = Goto(block33, None)
    i41 = block33.emit_phi([block55, block32], [BooleanConstant.FALSE, i40], Bool())
    block33.next = ConditionalGoto(i41, block34, block54, '`27 110:4-110:69')
    i42 = block34.emit(Operation, 'eq_bool', [zaq, BooleanConstant.TRUE], Bool(), '`3507', 'zz421')
    block34.next = Goto(block35, None)
    i43 = block35.emit_phi([block54, block34], [BooleanConstant.FALSE, i42], Bool())
    block35.next = ConditionalGoto(i43, block36, block37, '`27 104:2-113:3')
    i44 = block36.emit(GlobalRead, 'zRead_RISCV_reserved_strong_acquire', [], Int(), None, None)
    i45 = block36.emit(Operation, 'zSomezIEread_kindz5zK', [i44], Int(), '`27 110:29-110:69', 'zz40')
    i10.prevvalues[5] = i45
    block36.next = Goto(block6, None)
    i46 = block37.emit(Operation, 'eq_bool', [zres, BooleanConstant.FALSE], Bool(), '`3508', 'zz415')
    block37.next = ConditionalGoto(i46, block38, block53, '`27 111:4-111:35')
    i47 = block38.emit(Operation, 'eq_bool', [zrl, BooleanConstant.TRUE], Bool(), '`3509', 'zz416')
    block38.next = Goto(block39, None)
    i48 = block39.emit_phi([block53, block38], [BooleanConstant.FALSE, i47], Bool())
    block39.next = ConditionalGoto(i48, block40, block52, '`27 111:4-111:35')
    i49 = block40.emit(Operation, 'eq_bool', [zaq, BooleanConstant.FALSE], Bool(), '`3510', 'zz413')
    block40.next = Goto(block41, None)
    i50 = block41.emit_phi([block52, block40], [BooleanConstant.FALSE, i49], Bool())
    block41.next = ConditionalGoto(i50, block42, block43, '`27 104:2-113:3')
    i51 = block42.emit(Operation, 'zNonezIEread_kindz5zK', [], Int(), '`27 111:29-111:35', 'zz40')
    i10.prevvalues[6] = i51
    block42.next = Goto(block6, None)
    i52 = block43.emit(Operation, 'eq_bool', [zres, BooleanConstant.TRUE], Bool(), '`3511', 'zz47')
    block43.next = ConditionalGoto(i52, block44, block51, '`27 112:4-112:35')
    i53 = block44.emit(Operation, 'eq_bool', [zrl, BooleanConstant.TRUE], Bool(), '`3512', 'zz48')
    block44.next = Goto(block45, None)
    i54 = block45.emit_phi([block51, block44], [BooleanConstant.FALSE, i53], Bool())
    block45.next = ConditionalGoto(i54, block46, block50, '`27 112:4-112:35')
    i55 = block46.emit(Operation, 'eq_bool', [zaq, BooleanConstant.FALSE], Bool(), '`3513', 'zz45')
    block46.next = Goto(block47, None)
    i56 = block47.emit_phi([block50, block46], [BooleanConstant.FALSE, i55], Bool())
    block47.next = ConditionalGoto(i56, block48, block49, '`27 104:2-113:3')
    i57 = block48.emit(Operation, 'zNonezIEread_kindz5zK', [], Int(), '`27 112:29-112:35', 'zz40')
    i10.prevvalues[7] = i57
    block48.next = Goto(block6, None)
    block49.next = Raise(StringConstant("'match'"), '`27 104:2-113:3')
    block50.next = Goto(block47, None)
    block51.next = Goto(block45, None)
    block52.next = Goto(block41, None)
    block53.next = Goto(block39, None)
    block54.next = Goto(block35, None)
    block55.next = Goto(block33, None)
    block56.next = Goto(block29, None)
    block57.next = Goto(block27, None)
    block58.next = Goto(block23, None)
    block59.next = Goto(block21, None)
    block60.next = Goto(block17, None)
    block61.next = Goto(block15, None)
    block62.next = Goto(block11, None)
    block63.next = Goto(block9, None)
    block64.next = Goto(block4, None)
    block65.next = Goto(block2, None)
    graph = Graph('zread_kind_of_flags', [zaq, zrl, zres], block0)
    check_optimize(graph, '''
zaq = Argument('zaq', Bool())
zrl = Argument('zrl', Bool())
zres = Argument('zres', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
block8 = Block()
block9 = Block()
block10 = Block()
block11 = Block()
block12 = Block()
block13 = Block()
block14 = Block()
block15 = Block()
block16 = Block()
block17 = Block()
block18 = Block()
block19 = Block()
block20 = Block()
block21 = Block()
block22 = Block()
block23 = Block()
block24 = Block()
block25 = Block()
block26 = Block()
block27 = Block()
block28 = Block()
block29 = Block()
block30 = Block()
block31 = Block()
block32 = Block()
block33 = Block()
block0.next = ConditionalGoto(zres, block1, block31, '`27 105:4-105:45')
block1.next = ConditionalGoto(zres, block2, block28, '`27 106:4-106:53')
block2.next = ConditionalGoto(zres, block3, block25, '`27 107:4-107:60')
block3.next = ConditionalGoto(zres, block4, block5, '`27 108:4-108:54')
block4.next = ConditionalGoto(zrl, block5, block23, '`27 108:4-108:54')
block5.next = ConditionalGoto(zres, block6, block7, '`27 109:4-109:62')
block6.next = ConditionalGoto(zrl, block7, block21, '`27 109:4-109:62')
block7.next = ConditionalGoto(zres, block8, block12, '`27 110:4-110:69')
block8.next = ConditionalGoto(zrl, block9, block12, '`27 110:4-110:69')
block9.next = ConditionalGoto(zaq, block10, block12, '`27 104:2-113:3')
i3 = block10.emit(GlobalRead, 'zRead_RISCV_reserved_strong_acquire', [], Int(), None, None)
i4 = block10.emit(Operation, 'zSomezIEread_kindz5zK', [i3], Int(), '`27 110:29-110:69', 'zz40')
block10.next = Goto(block11, None)
i5 = block11.emit_phi([block33, block30, block27, block24, block22, block10, block20, block17], [None, None, None, None, None, i4, None, None], Int())
block11.next = Return(i5, None)
block12.next = ConditionalGoto(zres, block13, block18, '`27 111:4-111:35')
block13.next = ConditionalGoto(zres, block14, block16, '`27 112:4-112:35')
block14.next = ConditionalGoto(zrl, block15, block16, '`27 112:4-112:35')
block15.next = ConditionalGoto(zaq, block16, block17, '`27 104:2-113:3')
block16.next = Raise(StringConstant("'match'"), '`27 104:2-113:3')
i6 = block17.emit(Operation, 'zNonezIEread_kindz5zK', [], Int(), '`27 112:29-112:35', 'zz40')
i5.prevvalues[7] = i6
block17.next = Goto(block11, None)
block18.next = ConditionalGoto(zrl, block19, block13, '`27 111:4-111:35')
block19.next = ConditionalGoto(zaq, block13, block20, '`27 104:2-113:3')
i7 = block20.emit(Operation, 'zNonezIEread_kindz5zK', [], Int(), '`27 111:29-111:35', 'zz40')
i5.prevvalues[6] = i7
block20.next = Goto(block11, None)
block21.next = ConditionalGoto(zaq, block22, block7, '`27 104:2-113:3')
i8 = block22.emit(GlobalRead, 'zRead_RISCV_reserved_acquire', [], Int(), None, None)
i9 = block22.emit(Operation, 'zSomezIEread_kindz5zK', [i8], Int(), '`27 109:29-109:62', 'zz40')
i5.prevvalues[4] = i9
block22.next = Goto(block11, None)
block23.next = ConditionalGoto(zaq, block5, block24, '`27 104:2-113:3')
i10 = block24.emit(GlobalRead, 'zRead_RISCV_reserved', [], Int(), None, None)
i11 = block24.emit(Operation, 'zSomezIEread_kindz5zK', [i10], Int(), '`27 108:29-108:54', 'zz40')
i5.prevvalues[3] = i11
block24.next = Goto(block11, None)
block25.next = ConditionalGoto(zrl, block26, block3, '`27 107:4-107:60')
block26.next = ConditionalGoto(zaq, block27, block3, '`27 104:2-113:3')
i12 = block27.emit(GlobalRead, 'zRead_RISCV_strong_acquire', [], Int(), None, None)
i13 = block27.emit(Operation, 'zSomezIEread_kindz5zK', [i12], Int(), '`27 107:29-107:60', 'zz40')
i5.prevvalues[2] = i13
block27.next = Goto(block11, None)
block28.next = ConditionalGoto(zrl, block2, block29, '`27 106:4-106:53')
block29.next = ConditionalGoto(zaq, block30, block2, '`27 104:2-113:3')
i14 = block30.emit(GlobalRead, 'zRead_RISCV_acquire', [], Int(), None, None)
i15 = block30.emit(Operation, 'zSomezIEread_kindz5zK', [i14], Int(), '`27 106:29-106:53', 'zz40')
i5.prevvalues[1] = i15
block30.next = Goto(block11, None)
block31.next = ConditionalGoto(zrl, block1, block32, '`27 105:4-105:45')
block32.next = ConditionalGoto(zaq, block1, block33, '`27 104:2-113:3')
i16 = block33.emit(GlobalRead, 'zRead_plain', [], Int(), None, None)
i17 = block33.emit(Operation, 'zSomezIEread_kindz5zK', [i16], Int(), '`27 105:29-105:45', 'zz40')
i5.prevvalues[0] = i17
block33.next = Goto(block11, None)
graph = Graph('zread_kind_of_flags', [zaq, zrl, zres], block0)
''')

def test_eq_constfold():
    block0 = Block()
    i0 = block0.emit(Operation, '@eq', [MachineIntConstant(2), MachineIntConstant(0)], Bool(), '`7 433:7-433:17', 'zz40')
    block0.next = Return(i0, None)
    g = Graph("nope", [], block0)
    check_optimize(g, '''
block0 = Block()
block0.next = Return(BooleanConstant.FALSE, None)
graph = Graph('nope', [], block0)
''')

def test_inline_loop():
    from pydrofoil.ir import _inline
    zn = Argument('zn', Int())
    zregs = Argument('zregs', Vec(SmallFixedBitVector(5)))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    block9 = Block()
    block10 = Block()
    block11 = Block()
    block12 = Block()
    i2 = block0.emit(Operation, 'zhaveZdinx', [], Bool(), '`40 295:5-295:16', 'zz417')
    block0.next = ConditionalGoto(i2, block1, block12, '`40 295:5-295:37')
    block1.next = Goto(block2, None)
    i4 = block2.emit_phi([block12, block1], [BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
    block2.next = ConditionalGoto(i4, block3, block11, '`40 295:2-297:49')
    i5 = block3.emit(Operation, '@sub_o_i_wrapped_res', [zn, MachineIntConstant(1)], Int(), '`40 296:26-296:31', 'zz415')
    i6 = block3.emit(Operation, 'zz5izDzKz5i64', [i5], MachineInt(), '`40 296:26-296:31', 'zz43')
    block3.next = Goto(block4, None)
    i8 = block4.emit_phi([block3, block10], [MachineIntConstant(0), None], MachineInt())
    i9 = block4.emit(Operation, '@gt', [i8, i6], Bool(), '`40 296:4-297:49', None)
    block4.next = ConditionalGoto(i9, block5, block8, '`40 296:4-297:49')
    block5.next = Goto(block6, None)
    block6.next = Goto(block7, None)
    i11 = block7.emit_phi([block9, block6], [BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
    block7.next = Return(i11, None)
    i12 = block8.emit(Operation, '@vector_access_o_i', [zregs, i8], SmallFixedBitVector(5), '`40 297:10-297:17', 'zz49')
    i13 = block8.emit(Operation, '@vector_access_bv_i', [i12, MachineIntConstant(0)], SmallFixedBitVector(1), '`40 297:10-297:20', 'zz48')
    i14 = block8.emit(GlobalRead, 'bitone', [], SmallFixedBitVector(1), None, None)
    i15 = block8.emit(Operation, 'zeq_bit', [i13, i14], Bool(), '`40 297:10-297:30', 'zz47')
    block8.next = ConditionalGoto(i15, block9, block10, '`40 297:6-297:49')
    block9.next = Goto(block7, None)
    i17 = block10.emit(Operation, '@iadd', [i8, MachineIntConstant(1)], MachineInt(), '`40 296:4-297:49', 'zz45')
    i8.prevvalues[1] = i17
    block10.next = Goto(block4, None)
    block11.next = Goto(block6, None)
    block12.next = Goto(block2, None)
    subgraph = Graph('zvalidDoubleRegs', [zn, zregs], block0, True)

    zn = Argument('zn', MachineInt())
    zregs = Argument('zregs', Vec(SmallFixedBitVector(5)))
    block0 = Block()
    i2 = block0.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(4)], Int(), None, None)
    i3 = block0.emit(Operation, 'zvalidDoubleRegs', [i2, zregs], Unit(), None, None)
    block0.next = Return(i3, None)
    graph = Graph('zvalidDoubleRegs_specialized_4_o', [zn, zregs], block0)
    graph.check()

    _inline(graph, fakecodegen, block0, 1, subgraph)


def test_sail_assert_true():
    block0 = Block()
    i1 = block0.emit(Operation, 'zsail_assert', [BooleanConstant.TRUE, StringConstant('src/v8_base.sail:2440.22-2440.23')], Unit(), '`7 2440:8-2440:23', 'zz4192')
    block0.next = Return(BooleanConstant.TRUE, None)
    graph = Graph('happy_assert', [], block0)
    convert_sail_assert_to_exception(graph, fakecodegen)
    check_optimize(graph, '''
block0 = Block()
i0 = block0.emit(Comment, 'sail_assert src/v8_base.sail:2440.22-2440.23', [], Unit(), None, None)
block0.next = Return(BooleanConstant.TRUE, None)
graph = Graph('happy_assert', [], block0)
''')

def test_sail_assert_to_control_flow():
    a = Argument('a', Bool())
    block0 = Block()
    i1 = block0.emit(Operation, 'zsail_assert', [a, StringConstant('bad')], Unit(), None, None)
    block0.next = Return(a, None)
    graph = Graph('f', [a], block0)
    convert_sail_assert_to_exception(graph, fakecodegen)
    res = "\n".join(print_graph_construction(graph))
    assert res == """\
a = Argument('a', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
i1 = block0.emit(Comment, 'sail_assert bad', [], Unit(), None, None)
block0.next = ConditionalGoto(a, block1, block2, None)
block1.next = Return(a, None)
block2.next = Raise(StringConstant('bad'), None)
graph = Graph('f', [a], block0)"""


def test_not_bool():
    zp = Argument('zp', Bool())
    zq = Argument('zq', Bool())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i2 = block0.emit(Operation, 'not', [zp], Bool(), '`5 56:24-56:35', 'zz40')
    block0.next = ConditionalGoto(i2, block1, block3, '`5 56:24-56:39')
    block1.next = Goto(block2, None)
    i3 = block2.emit_phi([block3, block1], [zq, BooleanConstant.TRUE], Bool())
    block2.next = Return(i3, None)
    block3.next = Goto(block2, None)
    graph = Graph('zimplies', [zp, zq], block0)
    check_optimize(graph, '''
zp = Argument('zp', Bool())
zq = Argument('zq', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block0.next = ConditionalGoto(zp, block1, block3, '`5 56:24-56:39')
block1.next = Goto(block2, None)
i2 = block2.emit_phi([block1, block3], [zq, BooleanConstant.TRUE], Bool())
block2.next = Return(i2, None)
block3.next = Goto(block2, None)
graph = Graph('zimplies', [zp, zq], block0)
    ''')

def test_replicate():
    block0 = Block()
    arg = Argument('arg', SmallFixedBitVector(6))

    i47 = block0.emit(Operation, '@vector_access_bv_i', [arg, MachineIntConstant(0)], SmallFixedBitVector(1), '`7 154392:52-154392:64', 'zz4634')
    i48 = block0.emit(Operation, '$zupdate_fbits', [SmallBitVectorConstant(0b0, SmallFixedBitVector(1)), MachineIntConstant(0), i47], SmallFixedBitVector(1), '`7 154392:51-154392:65', 'zz4635')
    i49 = block0.emit(Cast, '$cast', [i48], GenericBitVector(), '`7 154392:41-154392:69', 'zz4632')
    i50 = block0.emit(Operation, '@replicate_bits_o_i', [i49, MachineIntConstant(1)], GenericBitVector(), '`7 154392:41-154392:69', 'zz4633')
    i51 = block0.emit(Cast, '$cast', [i50], SmallFixedBitVector(1), '`7 154392:41-154392:69', 'zz4623')
    i54 = block0.emit(Operation, '@bitvector_concat_bv_bv', [i51, MachineIntConstant(1), SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], SmallFixedBitVector(2), '`7 154392:41-154392:79', 'zz4627')
    i55 = block0.emit(Cast, '$cast', [i54], GenericBitVector(), '`7 154392:31-154392:84', 'zz4621')
    i56 = block0.emit(Operation, '@replicate_bits_o_i', [i55, MachineIntConstant(32)], GenericBitVector(), '`7 154392:31-154392:84', 'zz4622')
    i57 = block0.emit(Cast, '$cast', [i56], SmallFixedBitVector(64), None, None)
    block0.next = Return(i57, None)
    graph = Graph('repl', [arg], block0)
    check_optimize(graph, '''
arg = Argument('arg', SmallFixedBitVector(6))
block0 = Block()
i1 = block0.emit(Operation, '@vector_access_bv_i', [arg, MachineIntConstant(0)], SmallFixedBitVector(1), '`7 154392:52-154392:64', 'zz4634')
i2 = block0.emit(Operation, '@bitvector_concat_bv_bv', [i1, MachineIntConstant(1), SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], SmallFixedBitVector(2), '`7 154392:41-154392:79', 'zz4627')
i3 = block0.emit(Operation, '@replicate_bv_i_i', [i2, MachineIntConstant(2), MachineIntConstant(32)], SmallFixedBitVector(64), '`7 154392:31-154392:84', 'zz4622')
block0.next = Return(i3, None)
graph = Graph('repl', [arg], block0)
''')

def test_update_fbits():
    block0 = Block()
    arg = Argument('arg', SmallFixedBitVector(64))
    i19 = block0.emit(Operation, '@vector_access_bv_i', [arg, MachineIntConstant(0)], SmallFixedBitVector(1), '`10 108666:25-108666:33', 'zz4151')
    i20 = block0.emit(Operation, '$zupdate_fbits', [SmallBitVectorConstant(0b0, SmallFixedBitVector(1)), MachineIntConstant(0), i19], SmallFixedBitVector(1), '`10 108666:24-108666:34', 'zz4152')
    block0.next = Return(i20, None)
    graph = Graph('upd', [arg], block0)
    check_optimize(graph, '''
arg = Argument('arg', SmallFixedBitVector(64))
block0 = Block()
i1 = block0.emit(Operation, '@vector_access_bv_i', [arg, MachineIntConstant(0)], SmallFixedBitVector(1), '`10 108666:25-108666:33', 'zz4151')
block0.next = Return(i1, None)
graph = Graph('upd', [arg], block0)
''')

def test_phi_of_intconst():
    arg = Argument('arg', Bool())
    i = Argument('i', Bool())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block0.next = ConditionalGoto(arg, block1, block2, '')
    block1.next = Goto(block3)
    block2.next = Goto(block3)
    i0 = block3.emit_phi([block1, block2], [IntConstant(1), IntConstant(2)], Int())
    i1 = block3.emit(Operation, 'shl_int', [i, i0], Int(), None, None)
    block3.next = Return(i1, None)
    graph = Graph('f', [arg, i], block0)
    check_optimize(graph, '''
arg = Argument('arg', Bool())
i = Argument('i', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block0.next = ConditionalGoto(arg, block1, block3, '')
block1.next = Goto(block2, None)
i2 = block2.emit_phi([block1, block3], [MachineIntConstant(1), MachineIntConstant(2)], MachineInt())
i3 = block2.emit(Operation, '@shl_int_o_i', [i, i2], Int(), None, None)
block2.next = Return(i3, None)
block3.next = Goto(block2, None)
graph = Graph('f', [arg, i], block0)
''')

def test_defaultvalue_bv():
    zN = Argument('zN', MachineInt())
    zfpcr = Argument('zfpcr', SmallFixedBitVector(64))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    i6 = block0.emit(Operation, 'zUsingAArch32', [UnitConstant.UNIT], Bool(), '`7 148480:51-148480:65', 'zz427')
    i7 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
    block0.next = ConditionalGoto(i7, block1, block3, '`7 148480:51-148480:65')
    block1.next = Goto(block2, None)
    i8 = block2.emit_phi([block5, block1], [None, DefaultValue(GenericBitVector())], GenericBitVector())
    block2.next = Return(i8, None)
    i9 = block3.emit(Operation, '@not', [i6], Bool(), '`7 148480:42-148480:66', 'zz426')
    block3.next = ConditionalGoto(i9, block4, block6, '`7 148480:25-148483:9')
    i10 = block4.emit(Operation, '@vector_access_bv_i', [zfpcr, MachineIntConstant(1)], SmallFixedBitVector(1), '`7 148481:7-148481:14', 'zz421')
    block4.next = Goto(block5, None)
    i11 = block5.emit_phi([block6, block4], [SmallBitVectorConstant(0b0, SmallFixedBitVector(1)), i10], SmallFixedBitVector(1))
    i15 = block5.emit(Operation, '@bitvector_concat_bv_bv', [i11, MachineIntConstant(5), SmallBitVectorConstant(0b11111, SmallFixedBitVector(5))], SmallFixedBitVector(6), '`7 148486:12-148486:22', 'zz410')
    i16 = block5.emit(Operation, '@bitvector_concat_bv_bv', [i15, MachineIntConstant(10), SmallBitVectorConstant(0b1000000000, SmallFixedBitVector(10))], SmallFixedBitVector(16), '`7 148486:11-148486:30', 'zz49')
    i17 = block5.emit(Cast, '$cast', [i16], GenericBitVector(), None, None)
    i8.prevvalues[0] = i17
    block5.next = Goto(block2, None)
    block6.next = Goto(block5, None)
    graph = Graph('zFPDefaultNaN__1_specialized_16_o', [zN, zfpcr], block0)
    check_optimize(graph, '''
zN = Argument('zN', MachineInt())
zfpcr = Argument('zfpcr', SmallFixedBitVector(64))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
i2 = block0.emit(Operation, 'zUsingAArch32', [UnitConstant.UNIT], Bool(), '`7 148480:51-148480:65', 'zz427')
i3 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
block0.next = ConditionalGoto(i3, block1, block3, '`7 148480:51-148480:65')
block1.next = Goto(block2, None)
i4 = block2.emit_phi([block5, block1], [None, DefaultValue(SmallFixedBitVector(16))], SmallFixedBitVector(16))
i5 = block2.emit(Cast, '$cast', [i4], GenericBitVector(), None, None)
block2.next = Return(i5, None)
block3.next = ConditionalGoto(i2, block4, block6, '`7 148480:25-148483:9')
block4.next = Goto(block5, None)
i6 = block5.emit_phi([block4, block6], [SmallBitVectorConstant(0b0, SmallFixedBitVector(1)), None], SmallFixedBitVector(1))
i7 = block5.emit(Operation, '@bitvector_concat_bv_bv', [i6, MachineIntConstant(5), SmallBitVectorConstant(0b11111, SmallFixedBitVector(5))], SmallFixedBitVector(6), '`7 148486:12-148486:22', 'zz410')
i8 = block5.emit(Operation, '@bitvector_concat_bv_bv', [i7, MachineIntConstant(10), SmallBitVectorConstant(0b1000000000, SmallFixedBitVector(10))], SmallFixedBitVector(16), '`7 148486:11-148486:30', 'zz49')
i4.prevvalues[0] = i8
block5.next = Goto(block2, None)
i9 = block6.emit(Operation, '@vector_access_bv_i', [zfpcr, MachineIntConstant(1)], SmallFixedBitVector(1), '`7 148481:7-148481:14', 'zz421')
i6.prevvalues[1] = i9
block6.next = Goto(block5, None)
graph = Graph('zFPDefaultNaN__1_specialized_16_o', [zN, zfpcr], block0)
''')

def test_div_1():
    a = Argument('a', Int())
    block0 = Block()
    i1 = block0.emit(Operation, 'tdiv_int', [a, IntConstant(1)], Int(), '`1 186:4-186:22', 'zz41')
    i2 = block0.emit(Operation, 'ediv_int', [i1, IntConstant(1)], Int(), '`1 186:4-186:22', 'zz41')
    block0.next = Return(i2, None)
    graph = Graph('f', [a], block0)
    check_optimize(graph, '''
a = Argument('a', Int())
block0 = Block()
block0.next = Return(a, None)
graph = Graph('f', [a], block0)
''')

def test_neq():
    zr = Argument('zr', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@neq', [zr, MachineIntConstant(0)], Bool(), '`83', 'zz4129')
    i2 = block0.emit(Operation, '@not', [i1], Bool(), '`83', 'zz4129')
    block0.next = Return(i2, None)
    graph = Graph('f', [zr], block0)
    check_optimize(graph, """
zr = Argument('zr', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@eq', [zr, MachineIntConstant(0)], Bool(), '`83', 'zz4129')
block0.next = Return(i1, None)
graph = Graph('f', [zr], block0)
""")

def test_must_fit():
    zv = Argument('zv', GenericBitVector())
    zn = Argument('zn', Int())
    block0 = Block()
    i2 = block0.emit(Operation, 'zz5izDzKz5i64', [zn], MachineInt(), None, None)
    i3 = block0.emit(Operation, '@shiftr_o_i', [zv, i2], GenericBitVector(), '`1 268:5-268:11', 'zz40')
    i4 = block0.emit(Operation, '@length_unwrapped_res', [zv], MachineInt(), '`1 268:22-268:31', 'zz43')
    i5 = block0.emit(Operation, '@sub_i_i_wrapped_res', [i4, i2], Int(), '`1 268:22-268:35', 'zz42')
    i6 = block0.emit(Operation, 'zz5izDzKz5i64', [i5], MachineInt(), None, None)
    i7 = block0.emit(Operation, '@shiftl_o_i', [zv, i6], GenericBitVector(), '`1 268:16-268:36', 'zz41')
    i8 = block0.emit(Operation, 'or_bits', [i3, i7], GenericBitVector(), '`1 268:4-268:37', 'return')
    block0.next = Return(i8, None)
    graph = Graph('zrotater', [zv, zn], block0)
    check_optimize(graph, '''
zv = Argument('zv', GenericBitVector())
zn = Argument('zn', Int())
block0 = Block()
i2 = block0.emit(Operation, 'zz5izDzKz5i64', [zn], MachineInt(), None, None)
i3 = block0.emit(Operation, '@shiftr_o_i', [zv, i2], GenericBitVector(), '`1 268:5-268:11', 'zz40')
i4 = block0.emit(Operation, '@length_unwrapped_res', [zv], MachineInt(), '`1 268:22-268:31', 'zz43')
i5 = block0.emit(Operation, '@sub_i_i_must_fit', [i4, i2], MachineInt(), '`1 268:22-268:35', 'zz42')
i6 = block0.emit(Operation, '@shiftl_o_i', [zv, i5], GenericBitVector(), '`1 268:16-268:36', 'zz41')
i7 = block0.emit(Operation, 'or_bits', [i3, i6], GenericBitVector(), '`1 268:4-268:37', 'return')
block0.next = Return(i7, None)
graph = Graph('zrotater', [zv, zn], block0)
''')

def test_add_i_i_wrapped_res_0():
    a = Argument('a', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@add_i_i_wrapped_res', [MachineIntConstant(0), a], Int(), '`7 154655:32-154655:57', 'zz410')
    block0.next = Return(i1, None)
    graph = Graph('f', [a], block0)
    check_optimize(graph, '''
a = Argument('a', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, 'zz5i64zDzKz5i', [a], Int(), '`7 154655:32-154655:57', None)
block0.next = Return(i1, None)
graph = Graph('f', [a], block0)
''')


def test_narrow_vector_o_i_o():
    a = Argument('a', SmallFixedBitVector(64))
    block0 = Block()
    i18 = block0.emit(Cast, '$cast', [a], GenericBitVector(), '`59 88:19-88:42', 'zz425')
    i20 = block0.emit(Operation, '@vector_update_o_i_o', [i18, MachineIntConstant(0), SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], GenericBitVector(), '`59 88:19-88:42', 'zz426')
    i21 = block0.emit(Cast, '$cast', [i20], SmallFixedBitVector(64), '`59 88:19-88:42', 'zz412')
    block0.next = Return(i21, None)
    graph = Graph('f', [a], block0)
    check_optimize(graph, '''
a = Argument('a', SmallFixedBitVector(64))
block0 = Block()
i1 = block0.emit(Operation, '$zupdate_fbits', [a, MachineIntConstant(0), SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], SmallFixedBitVector(64), '`59 88:19-88:42', 'zz426')
block0.next = Return(i1, None)
graph = Graph('f', [a], block0)
''')

def test_constfold_update_fbits():
    block0 = Block()
    i1 = block0.emit(Operation, '$zupdate_fbits', [SmallBitVectorConstant(0b01, SmallFixedBitVector(2)), MachineIntConstant(0), SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], SmallFixedBitVector(2), '`59 88:19-88:42', 'zz426')
    block0.next = Return(i1, None)
    graph = Graph('f', [], block0)
    check_optimize(graph, '''
block0 = Block()
block0.next = Return(SmallBitVectorConstant(0b0, SmallFixedBitVector(2)), None)
graph = Graph('f', [], block0)
''')

def test_ediv_i_i():
    a = Argument('a', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, 'zz5i64zDzKz5i', [a], Int(), '`7 11525:11-11525:20', 'zz4199')
    i2 = block0.emit(Operation, 'ediv_int', [i1, IntConstant(2)], Int(), '`7 11526:20-11526:32', 'zz4179')
    i3 = block0.emit(Operation, 'zz5izDzKz5i64', [i2], MachineInt(), '`7 11526:20-11526:32', 'zz43')
    block0.next = Return(i3, None)
    graph = Graph('f', [a], block0)
    check_optimize(graph, '''
a = Argument('a', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@ediv_int_i_ipos', [a, MachineIntConstant(2)], MachineInt(), '`7 11526:20-11526:32', 'zz4179')
block0.next = Return(i1, None)
graph = Graph('f', [a], block0)
''')

def test_tdiv_i_i():
    a = Argument('a', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, 'zz5i64zDzKz5i', [a], Int(), '`7 11525:11-11525:20', 'zz4199')
    i2 = block0.emit(Operation, 'tdiv_int', [i1, IntConstant(2)], Int(), '`7 11526:20-11526:32', 'zz4179')
    i3 = block0.emit(Operation, 'zz5izDzKz5i64', [i2], MachineInt(), '`7 11526:20-11526:32', 'zz43')
    block0.next = Return(i3, None)
    graph = Graph('f', [a], block0)
    check_optimize(graph, '''
a = Argument('a', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@tdiv_int_i_i', [a, MachineIntConstant(2)], MachineInt(), '`7 11526:20-11526:32', 'zz4179')
block0.next = Return(i1, None)
graph = Graph('f', [a], block0)
''')

def test_exceptional_paths_and_anticipated_casts():
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    block9 = Block()
    block10 = Block()
    block11 = Block()
    block12 = Block()
    block13 = Block()
    block14 = Block()
    block15 = Block()
    block16 = Block()
    i0 = block0.emit(Comment, 'inlined z__IMPDEF_integer', [], Unit(), None, None)
    i1 = block0.emit(Comment, 'inlined z__IMPDEF_integer_map', [], Unit(), None, None)
    i2 = block0.emit(GlobalRead, 'z__supported_pa_sizze', [], Int(), None, None)
    i3 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
    block0.next = ConditionalGoto(i3, block1, block2, '`6 70:11-70:34')
    block1.next = Return(DefaultValue(MachineInt()), None)
    i4 = block2.emit(Operation, '@eq_int_o_i', [i2, MachineIntConstant(32)], Bool(), '`7 1262:11-1262:22', 'zz46')
    block2.next = ConditionalGoto(i4, block3, block5, '`7 1262:11-1262:106')
    block3.next = Goto(block4, None)
    i5 = block4.emit(Operation, 'zz5izDzKz5i64', [i2], MachineInt(), '`7 1263:4-1263:17', 'zz43')
    block4.next = Return(i5, None)
    i6 = block5.emit(Operation, '@eq_int_o_i', [i2, MachineIntConstant(36)], Bool(), '`7 1262:25-1262:36', 'zz48')
    block5.next = ConditionalGoto(i6, block6, block7, '`7 1262:25-1262:106')
    block6.next = Goto(block4, None)
    i7 = block7.emit(Operation, '@eq_int_o_i', [i2, MachineIntConstant(40)], Bool(), '`7 1262:39-1262:50', 'zz410')
    block7.next = ConditionalGoto(i7, block8, block9, '`7 1262:39-1262:106')
    block8.next = Goto(block4, None)
    i8 = block9.emit(Operation, '@eq_int_o_i', [i2, MachineIntConstant(42)], Bool(), '`7 1262:53-1262:64', 'zz412')
    block9.next = ConditionalGoto(i8, block10, block11, '`7 1262:53-1262:106')
    block10.next = Goto(block4, None)
    i9 = block11.emit(Operation, '@eq_int_o_i', [i2, MachineIntConstant(44)], Bool(), '`7 1262:67-1262:78', 'zz414')
    block11.next = ConditionalGoto(i9, block12, block13, '`7 1262:67-1262:106')
    block12.next = Goto(block4, None)
    i10 = block13.emit(Operation, '@eq_int_o_i', [i2, MachineIntConstant(48)], Bool(), '`7 1262:81-1262:92', 'zz416')
    block13.next = ConditionalGoto(i10, block14, block15, '`7 1262:81-1262:106')
    block14.next = Goto(block4, None)
    i11 = block15.emit(Operation, '@eq_int_o_i', [i2, MachineIntConstant(52)], Bool(), '`7 1262:95-1262:106', 'zz417')
    block15.next = ConditionalGoto(i11, block4, block16, '`7 1262:4-1263:17')
    block16.next = Raise(StringConstant('"src/v8_base.sail:1262.106-1262.107"'), None)
    graph = Graph('zAArch64_PAMax', [], block0)
    casts = find_anticipated_casts(graph)
    for block in block2, block3, block5, block6, block7, block8, block9, block10, block11, block12, block13, block14, block15:
        assert (i2, MachineInt()) in casts[block]

    check_optimize(graph, '''
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
block8 = Block()
block9 = Block()
block10 = Block()
i0 = block0.emit(Comment, 'inlined z__IMPDEF_integer', [], Unit(), None, None)
i1 = block0.emit(Comment, 'inlined z__IMPDEF_integer_map', [], Unit(), None, None)
i2 = block0.emit(GlobalRead, 'z__supported_pa_sizze', [], Int(), None, None)
i3 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
block0.next = ConditionalGoto(i3, block1, block2, '`6 70:11-70:34')
block1.next = Return(DefaultValue(MachineInt()), None)
i4 = block2.emit(Operation, 'zz5izDzKz5i64', [i2], MachineInt(), None, None)
i5 = block2.emit(Operation, '@eq', [i4, MachineIntConstant(32)], Bool(), '`7 1262:11-1262:22', 'zz46')
block2.next = ConditionalGoto(i5, block3, block4, '`7 1262:11-1262:106')
block3.next = Return(i4, None)
i6 = block4.emit(Operation, '@eq', [i4, MachineIntConstant(36)], Bool(), '`7 1262:25-1262:36', 'zz48')
block4.next = ConditionalGoto(i6, block3, block5, '`7 1262:25-1262:106')
i7 = block5.emit(Operation, '@eq', [i4, MachineIntConstant(40)], Bool(), '`7 1262:39-1262:50', 'zz410')
block5.next = ConditionalGoto(i7, block3, block6, '`7 1262:39-1262:106')
i8 = block6.emit(Operation, '@eq', [i4, MachineIntConstant(42)], Bool(), '`7 1262:53-1262:64', 'zz412')
block6.next = ConditionalGoto(i8, block3, block7, '`7 1262:53-1262:106')
i9 = block7.emit(Operation, '@eq', [i4, MachineIntConstant(44)], Bool(), '`7 1262:67-1262:78', 'zz414')
block7.next = ConditionalGoto(i9, block3, block8, '`7 1262:67-1262:106')
i10 = block8.emit(Operation, '@eq', [i4, MachineIntConstant(48)], Bool(), '`7 1262:81-1262:92', 'zz416')
block8.next = ConditionalGoto(i10, block3, block9, '`7 1262:81-1262:106')
i11 = block9.emit(Operation, '@eq', [i4, MachineIntConstant(52)], Bool(), '`7 1262:95-1262:106', 'zz417')
block9.next = ConditionalGoto(i11, block3, block10, '`7 1262:4-1263:17')
block10.next = Raise(StringConstant('"src/v8_base.sail:1262.106-1262.107"'), None)
graph = Graph('zAArch64_PAMax', [], block0)
''')

def test_remove_superfluous_enum_case():
    ztgx = Argument('ztgx', Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB')))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    i1 = block0.emit(Operation, '@eq', [EnumConstant('zTGx_4KB', Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB'))), ztgx], Bool(), '`7 9061:6-9061:13', None)
    block0.next = ConditionalGoto(i1, block1, block3, '`7 9061:6-9061:13')
    block1.next = Goto(block2, None)
    i2 = block2.emit_phi([block1, block4, block6, block7], [IntConstant(12), IntConstant(14), IntConstant(16), None], Int())
    block2.next = Return(i2, None)
    i3 = block3.emit(Operation, '@eq', [EnumConstant('zTGx_16KB', Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB'))), ztgx], Bool(), '`7 9064:6-9064:14', None)
    block3.next = ConditionalGoto(i3, block4, block5, '`7 9064:6-9064:14')
    block4.next = Goto(block2, None)
    i4 = block5.emit(Operation, '@eq', [EnumConstant('zTGx_64KB', Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB'))), ztgx], Bool(), '`7 9067:6-9067:14', None)
    block5.next = ConditionalGoto(i4, block6, block7, '`7 9067:6-9067:14')
    block6.next = Goto(block2, None)
    i5 = block7.emit(Operation, 'zundefined_int', [UnitConstant.UNIT], Int(), '`7 9071:17-9071:26', 'zz41')
    i2.prevvalues[3] = i5
    block7.next = Goto(block2, None)
    graph = Graph('zTGxGranuleBits', [ztgx], block0)
    remove_superfluous_enum_cases(graph, fakecodegen)
    res = print_graph_construction(graph)
    assert "\n".join(res) == '''\
zTGx = Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB'))
ztgx = Argument('ztgx', zTGx)
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
i1 = block0.emit(Operation, '@eq', [EnumConstant('zTGx_4KB', Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB'))), ztgx], Bool(), '`7 9061:6-9061:13', None)
block0.next = ConditionalGoto(i1, block1, block3, '`7 9061:6-9061:13')
block1.next = Goto(block2, None)
i2 = block2.emit_phi([block1, block4, block6], [IntConstant(12), IntConstant(14), IntConstant(16)], Int())
block2.next = Return(i2, None)
i3 = block3.emit(Operation, '@eq', [EnumConstant('zTGx_16KB', Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB'))), ztgx], Bool(), '`7 9064:6-9064:14', None)
block3.next = ConditionalGoto(i3, block4, block5, '`7 9064:6-9064:14')
block4.next = Goto(block2, None)
block5.next = Goto(block6, None)
block6.next = Goto(block2, None)
graph = Graph('zTGxGranuleBits', [ztgx], block0)\
'''

def test_remove_useless_switches():
    zn = Argument('zn', Int())
    zm = Argument('zm', MachineInt())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    i2 = block0.emit(Comment, 'inlined zfdiv_int', [], Unit(), None, None)
    i3 = block0.emit(Operation, '@lt', [zn, IntConstant(0)], Bool(), '`1 185:5-185:10', 'zz414')
    block0.next = ConditionalGoto(i3, block1, block3, '`1 185:5-185:18')
    i4 = block1.emit(Operation, '@add_o_i_wrapped_res', [zn, MachineIntConstant(1)], Int(), '`1 186:13-186:18', 'zz43')
    i5 = block1.emit(Operation, 'ztdiv_int', [i4, IntConstant(16)], Int(), '`1 186:4-186:22', 'zz41')
    i6 = block1.emit(Operation, '@sub_o_i_wrapped_res', [i5, MachineIntConstant(1)], Int(), '`1 186:4-186:26', 'return')
    block1.next = Goto(block2, None)
    i7 = block2.emit_phi([block4, block1], [None, i6], Int())
    block2.next = Return(i7, None)
    i8 = block3.emit(Operation, '@gt', [zn, IntConstant(0)], Bool(), '`1 187:12-187:17', 'zz410')
    block3.next = ConditionalGoto(i8, block4, block4, '`1 187:12-187:25')
    i9 = block4.emit(Operation, 'ztdiv_int', [zn, IntConstant(16)], Int(), '`1 190:4-190:18', 'return')
    i7.prevvalues[0] = i9
    block4.next = Goto(block2, None)
    graph = Graph('zfdiv_int_specialized_o_16', [zn, zm], block0)
    check_optimize(graph, '''
zn = Argument('zn', Int())
zm = Argument('zm', MachineInt())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
i2 = block0.emit(Comment, 'inlined zfdiv_int', [], Unit(), None, None)
i3 = block0.emit(Operation, '@lt', [zn, IntConstant(0)], Bool(), '`1 185:5-185:10', 'zz414')
block0.next = ConditionalGoto(i3, block1, block3, '`1 185:5-185:18')
i4 = block1.emit(Operation, '@add_o_i_wrapped_res', [zn, MachineIntConstant(1)], Int(), '`1 186:13-186:18', 'zz43')
i5 = block1.emit(Operation, 'ztdiv_int', [i4, IntConstant(16)], Int(), '`1 186:4-186:22', 'zz41')
i6 = block1.emit(Operation, '@sub_o_i_wrapped_res', [i5, MachineIntConstant(1)], Int(), '`1 186:4-186:26', 'return')
block1.next = Goto(block2, None)
i7 = block2.emit_phi([block3, block1], [None, i6], Int())
block2.next = Return(i7, None)
i8 = block3.emit(Operation, 'ztdiv_int', [zn, IntConstant(16)], Int(), '`1 190:4-190:18', 'return')
i7.prevvalues[0] = i8
block3.next = Goto(block2, None)
graph = Graph('zfdiv_int_specialized_o_16', [zn, zm], block0)
''')

def test_cse_tuple_fields():
    a1 = Argument('a1', Int())
    a2 = Argument('a2', SmallFixedBitVector(32))
    block0 = Block()
    i2 = block0.emit(Allocate, '$allocate', [], Struct('ztuplez3z5i_z5bv32', ('ztuplez3z5i_z5bv320', 'ztuplez3z5i_z5bv321'), (Int(), SmallFixedBitVector(32)), True), '`10 139:0-148:1', None)
    i3 = block0.emit(FieldWrite, 'ztuplez3z5i_z5bv320', [i2, a1], Unit(), '`10 139:0-148:1', None)
    i4 = block0.emit(FieldWrite, 'ztuplez3z5i_z5bv321', [i2, a2], Unit(), '`10 139:0-148:1', None)
    i5 = block0.emit(FieldAccess, 'ztuplez3z5i_z5bv321', [i2], SmallFixedBitVector(32), None, None)
    block0.next = Return(i5)
    g = Graph('f', [a1, a2], block0)
    BaseOptimizer(g, fakecodegen).optimize()
    compare(g, '''
ztuplez3z5i_z5bv32 = Struct('ztuplez3z5i_z5bv32', ('ztuplez3z5i_z5bv320', 'ztuplez3z5i_z5bv321'), (Int(), SmallFixedBitVector(32)), True)
a1 = Argument('a1', Int())
a2 = Argument('a2', SmallFixedBitVector(32))
block0 = Block()
i2 = block0.emit(Allocate, '$allocate', [], ztuplez3z5i_z5bv32, '`10 139:0-148:1', None)
i3 = block0.emit(FieldWrite, 'ztuplez3z5i_z5bv320', [i2, a1], Unit(), '`10 139:0-148:1', None)
i4 = block0.emit(FieldWrite, 'ztuplez3z5i_z5bv321', [i2, a2], Unit(), '`10 139:0-148:1', None)
block0.next = Return(a2, None)
graph = Graph('f', [a1, a2], block0)
''')

def test_cse_tuple_fields_struct_construction():
    a1 = Argument('a1', Int())
    a2 = Argument('a2', GenericBitVector())
    block0 = Block()
    i1 = block0.emit(StructConstruction, 'ttyp', [a1, a2], Struct('ttyp', ('f0', 'f1'), (Int(), GenericBitVector()), True), None, None)
    i2 = block0.emit(FieldAccess, 'f0', [i1], Int(), None, None)
    i3 = block0.emit(FieldAccess, 'f1', [i1], GenericBitVector(), None, None)
    i4 = block0.emit(Cast, '$cast', [i3], SmallFixedBitVector(8), '`7 11482:58-11482:94', None)
    block0.next = Return(i4)
    g = Graph('f', [a1, a2], block0)
    check_optimize(g, '''
a1 = Argument('a1', Int())
a2 = Argument('a2', GenericBitVector())
block0 = Block()
i2 = block0.emit(Cast, '$cast', [a2], SmallFixedBitVector(8), '`7 11482:58-11482:94', None)
block0.next = Return(i2, None)
graph = Graph('f', [a1, a2], block0)
''')

def test_remove_if_phi_constant3():
    a = Argument('a', Bool())
    b = Argument('b', Bool())
    c = Argument('c', Bool())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block0.next = ConditionalGoto(a, block1, block3, None)
    block1.next = ConditionalGoto(b, block2, block3, None)
    block2.next = Goto(block3)
    i0 = block3.emit_phi([block0, block1, block2], [BooleanConstant.TRUE, c, BooleanConstant.FALSE], Bool())
    block3.next = ConditionalGoto(i0, block4, block5, None)
    block4.next = Goto(block6)
    block5.next = Goto(block6)
    i1 = block6.emit_phi([block4, block5], [MachineIntConstant(0), MachineIntConstant(1)], Int())
    block6.next = Return(i1, None)
    graph = Graph('f', [a, b, c], block0)
    check_optimize(graph, '''
a = Argument('a', Bool())
b = Argument('b', Bool())
c = Argument('c', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block0.next = ConditionalGoto(a, block1, block5, None)
block1.next = ConditionalGoto(b, block2, block4, None)
block2.next = Goto(block3, None)
i3 = block3.emit_phi([block5, block2], [MachineIntConstant(0), MachineIntConstant(1)], Int())
block3.next = Return(i3, None)
block4.next = ConditionalGoto(c, block5, block2, None)
block5.next = Goto(block3, None)
graph = Graph('f', [a, b, c], block0)
''')

def test_specialize_platform_read_mem():
    kind = Argument('kind', Enum('zread_kind', ('zRead_plain', 'zRead_reserve', 'zRead_acquire', 'zRead_exclusive', 'zRead_exclusive_acquire', 'zRead_stream', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire', 'zRead_X86_locked')))
    address = Argument('address', SmallFixedBitVector(52))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i5 = block0.emit(Operation, '@slice_fixed_bv_i_i', [address, MachineIntConstant(16), MachineIntConstant(36)], SmallFixedBitVector(36), '`104486', 'zz444')
    i6 = block0.emit(Comment, 'inlined zZeroExtend1', [], Unit(), None, None)
    i7 = block0.emit(Operation, '@eq_bits_bv_bv', [i5, SmallBitVectorConstant(0x00003c00, SmallFixedBitVector(36))], Bool(), '`17 88:13-88:76', 'zz411')
    block0.next = ConditionalGoto(i7, block1, block3, '`17 88:9-92:3')
    i8 = block1.emit(Operation, '@vector_subrange_fixed_bv_i_i', [address, MachineIntConstant(15), MachineIntConstant(0)], SmallFixedBitVector(16), '`17 89:15-89:32', 'zz416')
    i9 = block1.emit(Comment, 'inlined z__ReadUART', [], Unit(), None, None)
    i10 = block1.emit(Cast, '$cast', [i8], GenericBitVector(), '`13 205:6-205:56', 'zz44')
    i11 = block1.emit(Operation, 'zprerr_bits', [StringConstant('"[UART] Unknown read offset: "'), i10], Unit(), '`13 205:6-205:56', 'zz43')
    i12 = block1.emit(Comment, 'inlined zZeros', [], Unit(), None, None)
    i13 = block1.emit(Cast, '$cast', [SmallBitVectorConstant(0b00000000, SmallFixedBitVector(8))], GenericBitVector(), None, None)
    block1.next = Goto(block2, None)
    i14 = block2.emit_phi([block3, block1], [None, i13], GenericBitVector())
    block2.next = Return(i14, None)
    i17 = block3.emit(Operation, '@zero_extend_bv_i_i', [address, MachineIntConstant(52), MachineIntConstant(64)], SmallFixedBitVector(64), '`17 91:57-91:81', 'zz424')
    i18 = block3.emit(Cast, '$cast', [i17], GenericBitVector(), '`17 91:4-91:88', 'zz421')
    i19 = block3.emit(Operation, 'platform_read_mem', [kind, MachineIntConstant(64), i18, IntConstant(1)], GenericBitVector(), '`17 91:4-91:88', 'return')
    i14.prevvalues[0] = i19
    block3.next = Goto(block2, None)
    graph = Graph('z_Mem_read_specialized_o_1_o', [kind, address], block0)
    check_optimize(graph, '''
zread_kind = Enum('zread_kind', ('zRead_plain', 'zRead_reserve', 'zRead_acquire', 'zRead_exclusive', 'zRead_exclusive_acquire', 'zRead_stream', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire', 'zRead_X86_locked'))
kind = Argument('kind', zread_kind)
address = Argument('address', SmallFixedBitVector(52))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
i2 = block0.emit(Operation, '@slice_fixed_bv_i_i', [address, MachineIntConstant(16), MachineIntConstant(36)], SmallFixedBitVector(36), '`104486', 'zz444')
i3 = block0.emit(Comment, 'inlined zZeroExtend1', [], Unit(), None, None)
i4 = block0.emit(Operation, '@eq_bits_bv_bv', [i2, SmallBitVectorConstant(0x3c00, SmallFixedBitVector(36))], Bool(), '`17 88:13-88:76', 'zz411')
block0.next = ConditionalGoto(i4, block1, block3, '`17 88:9-92:3')
i5 = block1.emit(Operation, '@vector_subrange_fixed_bv_i_i', [address, MachineIntConstant(15), MachineIntConstant(0)], SmallFixedBitVector(16), '`17 89:15-89:32', 'zz416')
i6 = block1.emit(Comment, 'inlined z__ReadUART', [], Unit(), None, None)
i7 = block1.emit(Cast, '$cast', [i5], GenericBitVector(), '`13 205:6-205:56', 'zz44')
i8 = block1.emit(Operation, 'zprerr_bits', [StringConstant('"[UART] Unknown read offset: "'), i7], Unit(), '`13 205:6-205:56', 'zz43')
i9 = block1.emit(Comment, 'inlined zZeros', [], Unit(), None, None)
block1.next = Goto(block2, None)
i10 = block2.emit_phi([block3, block1], [None, SmallBitVectorConstant(0x0, SmallFixedBitVector(8))], SmallFixedBitVector(8))
i11 = block2.emit(Cast, '$cast', [i10], GenericBitVector(), None, None)
block2.next = Return(i11, None)
i12 = block3.emit(Operation, '@zero_extend_bv_i_i', [address, MachineIntConstant(52), MachineIntConstant(64)], SmallFixedBitVector(64), '`17 91:57-91:81', 'zz424')
i13 = block3.emit(Operation, '@fast_read_mem_i_bv_i_isfetch', [MachineIntConstant(64), i12, MachineIntConstant(1), BooleanConstant.FALSE], SmallFixedBitVector(8), '`17 91:4-91:88', 'return')
i10.prevvalues[0] = i13
block3.next = Goto(block2, None)
graph = Graph('z_Mem_read_specialized_o_1_o', [kind, address], block0)
''')


def test_operations_with_known_nonnegative_results():
    a = Argument('a', SmallFixedBitVector(64))
    block0 = Block()
    i1 = block0.emit(Operation, '@unsigned_bv_wrapped_res', [a, MachineIntConstant(64)], Int(), '`7 2890:20-2890:27', 'zz46')
    i2 = block0.emit(Operation, '@lt', [i1, IntConstant(0)], Bool(), '`1 185:5-185:10', 'zz414')
    block0.next = Return(i2)
    g = Graph('g', [a], block0)
    check_optimize(g, '''
a = Argument('a', SmallFixedBitVector(64))
block0 = Block()
block0.next = Return(BooleanConstant.FALSE, None)
graph = Graph('g', [a], block0)
''')
    a = Argument('a', SmallFixedBitVector(32))
    block0 = Block()
    i1 = block0.emit(Operation, '@unsigned_bv', [a, MachineIntConstant(32)], MachineInt(), '`7 2890:20-2890:27', 'zz46')
    i2 = block0.emit(Operation, '@lt', [i1, IntConstant(0)], Bool(), '`1 185:5-185:10', 'zz414')
    block0.next = Return(i2)
    g = Graph('g', [a], block0)
    check_optimize(g, '''
a = Argument('a', SmallFixedBitVector(32))
block0 = Block()
block0.next = Return(BooleanConstant.FALSE, None)
graph = Graph('g', [a], block0)
''')
    a = Argument('a', GenericBitVector())
    block0 = Block()
    i1 = block0.emit(Operation, '@length_unwrapped_res', [a], MachineInt(), '`7 153288:24-153288:26', 'zz425')
    i2 = block0.emit(Operation, '@lt', [i1, MachineIntConstant(0)], Bool(), '`1 185:5-185:10', 'zz414')
    block0.next = Return(i2)
    g = Graph('g', [a], block0)
    check_optimize(g, '''
a = Argument('a', GenericBitVector())
block0 = Block()
block0.next = Return(BooleanConstant.FALSE, None)
graph = Graph('g', [a], block0)

''')

def test_constfold_phi_of_consts():
    b = Argument('b', Bool())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block0.next = ConditionalGoto(b, block1, block2)
    block1.next = Goto(block3)
    block2.next = Goto(block3)
    i28 = block3.emit_phi([block1, block2], [MachineIntConstant(16), MachineIntConstant(32)], MachineInt())
    i30 = block3.emit(Operation, '@lt', [i28, MachineIntConstant(0)], Bool(), '`1 185:5-185:10', 'zz414')
    block3.next = ConditionalGoto(i30, block4, block5, '`1 185:5-185:18')
    i31 = block4.emit(Operation, '@add_i_i_wrapped_res', [i28, MachineIntConstant(1)], Int(), '`1 186:13-186:18', 'zz43')
    i32 = block4.emit(Operation, 'tdiv_int', [i31, IntConstant(8)], Int(), '`1 186:4-186:22', 'zz41')
    i33 = block4.emit(Operation, '@sub_o_i_wrapped_res', [i32, MachineIntConstant(1)], Int(), '`1 186:4-186:26', 'return')
    block4.next = Goto(block6, None)
    i43 = block5.emit(Operation, '@gt', [i28, MachineIntConstant(0)], Bool(), '`1 187:12-187:17', 'zz410')
    i44 = block5.emit(Operation, '@tdiv_int_i_i', [i28, MachineIntConstant(8)], MachineInt(), '`1 190:4-190:18', 'return')
    i45 = block5.emit(Operation, 'zz5i64zDzKz5i', [i44], Int(), None, None)
    block5.next = Goto(block6, None)
    i34 = block6.emit_phi([block5, block4], [i45, i33], Int())
    i46 = block6.emit(Operation, 'zz5izDzKz5i64', [i34], MachineInt())
    block6.next = Return(i46)
    g = Graph('g', [b], block0)
    check_optimize(g, '''
b = Argument('b', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block0.next = ConditionalGoto(b, block1, block3, None)
block1.next = Goto(block2, None)
i1 = block2.emit_phi([block1, block3], [MachineIntConstant(2), MachineIntConstant(4)], MachineInt())
block2.next = Return(i1, None)
block3.next = Goto(block2, None)
graph = Graph('g', [b], block0)
''')

def test_constfold_phi_of_consts_different_block():
    b = Argument('b', Bool())
    b2 = Argument('b2', Bool())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block0.next = ConditionalGoto(b, block1, block2)
    block1.next = Goto(block3)
    block2.next = Goto(block3)
    i28 = block3.emit_phi([block1, block2], [MachineIntConstant(16), MachineIntConstant(32)], MachineInt())
    block3.next = ConditionalGoto(b2, block4, block5, '`1 185:5-185:18')
    i30 = block4.emit(Operation, '@lt', [i28, MachineIntConstant(0)], Bool(), '`1 185:5-185:10', 'zz414')
    block4.next = Goto(block6, None)
    block5.next = Goto(block6, None)
    i34 = block6.emit_phi([block5, block4], [BooleanConstant.TRUE, i30], Int())
    block6.next = Return(i34)
    g = Graph('g', [b, b2], block0)
    check_optimize(g, '''
b = Argument('b', Bool())
b2 = Argument('b2', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block0.next = ConditionalGoto(b2, block1, block3, '`1 185:5-185:18')
block1.next = Goto(block2, None)
i2 = block2.emit_phi([block3, block1], [BooleanConstant.TRUE, BooleanConstant.FALSE], Int())
block2.next = Return(i2, None)
block3.next = Goto(block2, None)
graph = Graph('g', [b, b2], block0)
''')

def test_highest_set_bit():
    zx = Argument('zx', SmallFixedBitVector(32))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block0.next = Goto(block1, None)
    i1 = block1.emit_phi([block0, block6], [MachineIntConstant(31), None], MachineInt())
    i2 = block1.emit(Operation, '@lt', [i1, MachineIntConstant(0)], Bool(), '`7 146632:4-146637:5', None)
    block1.next = ConditionalGoto(i2, block2, block4, '`7 146632:4-146637:5')
    block2.next = Goto(block3, None)
    i3 = block3.emit_phi([block5, block2], [None, IntConstant(-1)], Int())
    block3.next = Return(i3, None)
    i4 = block4.emit(Operation, 'zz5i64zDzKz5i', [i1], Int(), '`7 146633:12-146633:16', 'zz418')
    i3.prevvalues[0] = i4
    i5 = block4.emit(Operation, '@vector_access_bv_i', [zx, i1], SmallFixedBitVector(1), '`7 146633:12-146633:16', 'zz416')
    i6 = block4.emit(Operation, '@eq_bits_bv_bv', [i5, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 146633:11-146633:24', 'zz410')
    block4.next = ConditionalGoto(i6, block5, block6, '`7 146633:8-146635:9')
    block5.next = Goto(block3, None)
    i7 = block6.emit(Operation, '@isub', [i1, MachineIntConstant(1)], MachineInt(), '`7 146632:4-146637:5', 'zz48')
    i1.prevvalues[1] = i7
    block6.next = Goto(block1, None)
    graph = Graph('zHighestSetBit_specialized_bv32', [zx], block0, True)
    opt = LocalOptimizer(graph, fakecodegen)
    res = opt._extract_machineint(i3)
    assert isinstance(res, Phi) and res.resolved_type is MachineInt()

def test_exception_check_bug():
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    i1 = block0.emit(Comment, 'inlined zHasArchVersion', [], Unit(), None, None)
    i2 = block0.emit(Comment, 'inlined z__IMPDEF_boolean', [], Unit(), None, None)
    i3 = block0.emit(Comment, 'inlined z__IMPDEF_boolean_map', [], Unit(), None, None)
    i4 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
    block0.next = ConditionalGoto(i4, block1, block2, '`6 66:11-66:34')
    block1.next = Return(DefaultValue(Bool()), None)
    i5 = block2.emit(Comment, 'inlined zHave52BitVAExt', [], Unit(), None, None)
    i6 = block2.emit(Comment, 'inlined zHasArchVersion', [], Unit(), None, None)
    i7 = block2.emit(Comment, 'inlined z__IMPDEF_boolean', [], Unit(), None, None)
    i8 = block2.emit(Comment, 'inlined z__IMPDEF_boolean_map', [], Unit(), None, None)
    i9 = block2.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
    block2.next = ConditionalGoto(i9, block1, block3, '`6 66:11-66:34')
    i10 = block3.emit(Comment, 'inlined zHave52BitPAExt', [], Unit(), None, None)
    i11 = block3.emit(Comment, 'inlined zHasArchVersion', [], Unit(), None, None)
    i12 = block3.emit(Comment, 'inlined z__IMPDEF_boolean', [], Unit(), None, None)
    i13 = block3.emit(Comment, 'inlined z__IMPDEF_boolean_map', [], Unit(), None, None)
    i14 = block3.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
    block3.next = ConditionalGoto(i14, block1, block4, '`6 66:11-66:34')
    block4.next = Return(BooleanConstant.TRUE, None)
    graph = Graph('zHave52BitIPAAndPASpaceExt', [], block0)
    remove_double_exception_check(graph, fakecodegen)
    res = print_graph_construction(graph)
    assert "\n".join(res) == '''\
block0 = Block()
block1 = Block()
block2 = Block()
i0 = block0.emit(Comment, 'inlined zHasArchVersion', [], Unit(), None, None)
i1 = block0.emit(Comment, 'inlined z__IMPDEF_boolean', [], Unit(), None, None)
i2 = block0.emit(Comment, 'inlined z__IMPDEF_boolean_map', [], Unit(), None, None)
i3 = block0.emit(GlobalRead, 'have_exception', [], Bool(), None, None)
block0.next = ConditionalGoto(i3, block1, block2, '`6 66:11-66:34')
block1.next = Return(DefaultValue(Bool()), None)
i4 = block2.emit(Comment, 'inlined zHave52BitVAExt', [], Unit(), None, None)
i5 = block2.emit(Comment, 'inlined zHasArchVersion', [], Unit(), None, None)
i6 = block2.emit(Comment, 'inlined z__IMPDEF_boolean', [], Unit(), None, None)
i7 = block2.emit(Comment, 'inlined z__IMPDEF_boolean_map', [], Unit(), None, None)
i8 = block2.emit(Comment, 'inlined zHave52BitPAExt', [], Unit(), None, None)
i9 = block2.emit(Comment, 'inlined zHasArchVersion', [], Unit(), None, None)
i10 = block2.emit(Comment, 'inlined z__IMPDEF_boolean', [], Unit(), None, None)
i11 = block2.emit(Comment, 'inlined z__IMPDEF_boolean_map', [], Unit(), None, None)
block2.next = Return(BooleanConstant.TRUE, None)
graph = Graph('zHave52BitIPAAndPASpaceExt', [], block0)'''

def test_all_in_aligned_quantity_inlined():
    addr = Argument('addr', SmallFixedBitVector(64))
    size = Argument('size', MachineInt())
    block2 = Block()
    i25 = block2.emit(Operation, '@add_bits_int_bv_i', [addr, MachineIntConstant(64), size], SmallFixedBitVector(64), '`7 11346:17-11346:31', 'zz415')
    i26 = block2.emit(Operation, '@sub_bits_int_bv_i', [i25, MachineIntConstant(64), MachineIntConstant(1)], SmallFixedBitVector(64), '`7 11346:17-11346:35', 'zz413')
    i29 = block2.emit(Operation, '@unsigned_bv_wrapped_res', [i26, MachineIntConstant(64)], Int(), '`7 2890:20-2890:27', 'zz46')
    i32 = block2.emit(Operation, 'tdiv_int', [i29, IntConstant(16)], Int(), '`1 190:4-190:18', 'return')
    i33 = block2.emit(Operation, '@shl_int_o_i', [i32, MachineIntConstant(4)], Int(), '`7 2885:11-2885:24', 'zz40')
    i35 = block2.emit(Operation, '@get_slice_int_i_o_i_unwrapped_res', [MachineIntConstant(64), i33, MachineIntConstant(0)], SmallFixedBitVector(64), '`5 176:39-176:72', 'return')
    i38 = block2.emit(Operation, '@unsigned_bv_wrapped_res', [addr, MachineIntConstant(64)], Int(), '`7 2890:20-2890:27', 'zz46')
    i41 = block2.emit(Operation, 'tdiv_int', [i38, IntConstant(16)], Int(), '`1 190:4-190:18', 'return')
    i42 = block2.emit(Operation, '@shl_int_o_i', [i41, MachineIntConstant(4)], Int(), '`7 2885:11-2885:24', 'zz40')
    i44 = block2.emit(Operation, '@get_slice_int_i_o_i_unwrapped_res', [MachineIntConstant(64), i42, MachineIntConstant(0)], SmallFixedBitVector(64), '`5 176:39-176:72', 'return')
    i45 = block2.emit(Operation, '@eq_bits_bv_bv', [i35, i44], Bool(), '`7 11346:11-11346:76', 'zz40')
    block2.next = Return(i45)
    g = Graph('g', [addr, size], block2)
    check_optimize(g, '''
addr = Argument('addr', SmallFixedBitVector(64))
size = Argument('size', MachineInt())
block0 = Block()
i2 = block0.emit(Operation, '@add_bits_int_bv_i', [addr, MachineIntConstant(64), size], SmallFixedBitVector(64), '`7 11346:17-11346:31', 'zz415')
i3 = block0.emit(Operation, '@sub_bits_int_bv_i', [i2, MachineIntConstant(64), MachineIntConstant(1)], SmallFixedBitVector(64), '`7 11346:17-11346:35', 'zz413')
i4 = block0.emit(Operation, '@and_vec_bv_bv', [i3, SmallBitVectorConstant(0xfffffffffffffff0L, SmallFixedBitVector(64))], SmallFixedBitVector(64), '`5 176:39-176:72', 'return')
i5 = block0.emit(Operation, '@and_vec_bv_bv', [addr, SmallBitVectorConstant(0xfffffffffffffff0L, SmallFixedBitVector(64))], SmallFixedBitVector(64), '`5 176:39-176:72', 'return')
i6 = block0.emit(Operation, '@eq_bits_bv_bv', [i4, i5], Bool(), '`7 11346:11-11346:76', 'zz40')
block0.next = Return(i6, None)
graph = Graph('g', [addr, size], block0)
''')

def test_partial_allocation_removal():
    a1 = Argument('a1', Int())
    a2 = Argument('a2', SmallFixedBitVector(32))
    block0 = Block()
    i2 = block0.emit(Allocate, '$allocate', [], Struct('s', ('f1', 'f2'), (Int(), SmallFixedBitVector(32))), None, None)
    i3 = block0.emit(FieldWrite, 'f1', [i2, MachineIntConstant(12)], Unit(), None, None)
    i3 = block0.emit(FieldWrite, 'f1', [i2, a1], Unit(), None, None)
    i4 = block0.emit(FieldWrite, 'f2', [i2, a2], Unit(), None, None)
    block0.next = Return(i2)
    g = Graph('f', [a1, a2], block0)
    partial_allocation_removal(g, fakecodegen)
    compare(g, '''
s = Struct('s', ('f1', 'f2'), (Int(), SmallFixedBitVector(32)))
a1 = Argument('a1', Int())
a2 = Argument('a2', SmallFixedBitVector(32))
block0 = Block()
i2 = block0.emit(StructConstruction, 's', [a1, a2], s, None, None)
block0.next = Return(i2, None)
graph = Graph('f', [a1, a2], block0)
''')

def test_partial_allocation_removal_escape():
    a1 = Argument('a1', Int())
    a2 = Argument('a2', SmallFixedBitVector(32))
    block0 = Block()
    i2 = block0.emit(Allocate, '$allocate', [], Struct('s', ('f1', 'f2'), (Int(), SmallFixedBitVector(32))), None, None)
    i3 = block0.emit(FieldWrite, 'f1', [i2, MachineIntConstant(12)], Unit(), None, None)
    i3 = block0.emit(FieldWrite, 'f1', [i2, a1], Unit(), None, None)
    i4 = block0.emit(FieldWrite, 'f2', [i2, a2], Unit(), None, None)
    i5 = block0.emit(Operation, "escape", [i2], Int())
    block0.next = Return(i5)
    g = Graph('f', [a1, a2], block0)
    partial_allocation_removal(g, fakecodegen)
    compare(g, '''
s = Struct('s', ('f1', 'f2'), (Int(), SmallFixedBitVector(32)))
a1 = Argument('a1', Int())
a2 = Argument('a2', SmallFixedBitVector(32))
block0 = Block()
i2 = block0.emit(StructConstruction, 's', [a1, a2], s, None, None)
i3 = block0.emit(Operation, 'escape', [i2], Int(), None, None)
block0.next = Return(i3, None)
graph = Graph('f', [a1, a2], block0)
''')

def test_partial_allocation_removal_escape_recursive():
    a1 = Argument('a1', Int())
    a2 = Argument('a2', SmallFixedBitVector(32))
    block0 = Block()
    i2 = block0.emit(Allocate, '$allocate', [], Struct('s', ('f1', 'f2'), (Int(), SmallFixedBitVector(32))), None, None)
    i3 = block0.emit(Allocate, '$allocate', [], Struct('s2', ('sf1', 'sf2'), (Int(), Struct('s', ('f1', 'f2'), (Int(), SmallFixedBitVector(32))))), None, None)
    i4 = block0.emit(FieldWrite, 'f1', [i2, a1], Unit(), None, None)
    i5 = block0.emit(FieldWrite, 'f2', [i2, a2], Unit(), None, None)
    i6 = block0.emit(FieldWrite, 'sf1', [i3, a2], Unit(), None, None)
    i7 = block0.emit(FieldWrite, 'sf2', [i3, i2], Unit(), None, None)
    i8 = block0.emit(Operation, "escape", [i3], Int())
    block0.next = Return(i8)
    g = Graph('f', [a1, a2], block0)
    partial_allocation_removal(g, fakecodegen)
    compare(g, '''
s = Struct('s', ('f1', 'f2'), (Int(), SmallFixedBitVector(32)))
s2 = Struct('s2', ('sf1', 'sf2'), (Int(), Struct('s', ('f1', 'f2'), (Int(), SmallFixedBitVector(32)))))
a1 = Argument('a1', Int())
a2 = Argument('a2', SmallFixedBitVector(32))
block0 = Block()
i2 = block0.emit(StructConstruction, 's', [a1, a2], s, None, None)
i3 = block0.emit(StructConstruction, 's2', [a2, i2], s2, None, None)
i4 = block0.emit(Operation, 'escape', [i3], Int(), None, None)
block0.next = Return(i4, None)
graph = Graph('f', [a1, a2], block0)
''')

def test_partial_allocation_removal_merge_same_virtual():
    zb = Argument('zb', Bool())
    zi = Argument('zi', MachineInt())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i2 = block0.emit(Allocate, '$allocate', [], Struct('s', ('f1', 'f2'), (MachineInt(), MachineInt())), None, None)
    block0.emit(FieldWrite, 'f1', [i2, MachineIntConstant(12)], Unit(), None, None)
    block0.next = ConditionalGoto(zb, block1, block2, '`1 13:27-16:1')
    block1.emit(FieldWrite, 'f2', [i2, zi], Unit(), None, None)
    block1.next = Goto(block3, None)
    block2.emit(FieldWrite, 'f2', [i2, MachineIntConstant(100)], Unit(), None, None)
    block2.next = Goto(block3, None)
    i5 = block3.emit(FieldAccess, 'f1', [i2], MachineInt(), None, None)
    i6 = block3.emit(FieldAccess, 'f2', [i2], MachineInt(), None, None)
    i7 = block3.emit(Operation, '@add', [i5, i6], MachineInt(), None, None)
    block3.next = Return(i7, None)
    g = Graph('merge', [zb, zi], block0)
    partial_allocation_removal(g, fakecodegen)
    compare(g, '''
s = Struct('s', ('f1', 'f2'), (MachineInt(), MachineInt()))
zb = Argument('zb', Bool())
zi = Argument('zi', MachineInt())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
i2 = block0.emit(StructConstruction, 's', [MachineIntConstant(12), DefaultValue(MachineInt())], s, None, None)
block0.next = ConditionalGoto(zb, block1, block3, '`1 13:27-16:1')
i3 = block1.emit(FieldWrite, 'f2', [i2, zi], Unit(), None, None)
block1.next = Goto(block2, None)
i4 = block2.emit(FieldAccess, 'f1', [i2], MachineInt(), None, None)
i5 = block2.emit(FieldAccess, 'f2', [i2], MachineInt(), None, None)
i6 = block2.emit(Operation, '@add', [i4, i5], MachineInt(), None, None)
block2.next = Return(i6, None)
i7 = block3.emit(FieldWrite, 'f2', [i2, MachineIntConstant(100)], Unit(), None, None)
block3.next = Goto(block2, None)
graph = Graph('merge', [zb, zi], block0)
''')

def test_partial_allocation_removal_starting_from_struct_construction():
    a1 = Argument('a1', MachineInt())
    a2 = Argument('a2', SmallFixedBitVector(32))
    block0 = Block()
    i2 = block0.emit(StructConstruction, 's', [a1, a2], Struct('s', ('f1', 'f2'), (MachineInt(), SmallFixedBitVector(32))), None, None)
    i3 = block0.emit(FieldWrite, 'f1', [i2, MachineIntConstant(12)], Unit(), None, None)
    i3 = block0.emit(FieldAccess, 'f1', [i2], MachineInt(), None, None)
    block0.next = Return(i3)
    g = Graph('f', [a1, a2], block0)
    partial_allocation_removal(g, fakecodegen)
    compare(g, '''
a1 = Argument('a1', MachineInt())
a2 = Argument('a2', SmallFixedBitVector(32))
block0 = Block()
block0.next = Return(MachineIntConstant(12), None)
graph = Graph('f', [a1, a2], block0)
''')

def test_partial_allocation_aliasing():
    a1 = Argument('a1', MachineInt())
    a2 = Argument('a2', SmallFixedBitVector(32))
    s = Struct('s', ('f1', 'f2'), (MachineInt(), SmallFixedBitVector(32)))
    s2 = Struct('s2', ('sf1', 'sf2'), (MachineInt(), Struct('s', ('f1', 'f2'), (MachineInt(), SmallFixedBitVector(32)))))
    block0 = Block()
    i2 = block0.emit(Allocate, '$allocate', [], s, None, None)
    i3 = block0.emit(Allocate, '$allocate', [], s2, None, None)
    i4 = block0.emit(FieldWrite, 'f1', [i2, a1], Unit(), None, None)
    i5 = block0.emit(FieldWrite, 'f2', [i2, a2], Unit(), None, None)
    i6 = block0.emit(FieldWrite, 'sf1', [i3, a2], Unit(), None, None)
    i7 = block0.emit(FieldWrite, 'sf2', [i3, i2], Unit(), None, None)
    i8 = block0.emit(FieldAccess, 'sf2', [i3], s, None, None)
    i9 = block0.emit(FieldWrite, 'f1', [i8, IntConstant(12)], Unit(), None, None)
    block0.next = Return(i3)
    g = Graph('f', [a1, a2], block0)
    partial_allocation_removal(g, fakecodegen)
    compare(g, '''
s = Struct('s', ('f1', 'f2'), (MachineInt(), SmallFixedBitVector(32)))
s2 = Struct('s2', ('sf1', 'sf2'), (MachineInt(), Struct('s', ('f1', 'f2'), (MachineInt(), SmallFixedBitVector(32)))))
a1 = Argument('a1', MachineInt())
a2 = Argument('a2', SmallFixedBitVector(32))
block0 = Block()
i2 = block0.emit(StructConstruction, 's', [IntConstant(12), a2], s, None, None)
i3 = block0.emit(StructConstruction, 's2', [a2, i2], s2, None, None)
block0.next = Return(i3, None)
graph = Graph('f', [a1, a2], block0)
''')

def test_partial_allocation_copy():
    zt = Argument('zt', Bool())
    zc = Argument('zc', SmallFixedBitVector(64))
    block0 = Block()
    i2 = block0.emit(Comment, 'inlined zcapBitsToEncCapability', [], Unit(), None, None)
    i3 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(63), MachineIntConstant(63)], SmallFixedBitVector(1), '`8 110:15-110:24', 'zz434')
    i4 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(62), MachineIntConstant(57)], SmallFixedBitVector(6), '`8 111:15-111:24', 'zz430')
    i5 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(56), MachineIntConstant(54)], SmallFixedBitVector(3), '`8 112:15-112:24', 'zz426')
    i6 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(53), MachineIntConstant(50)], SmallFixedBitVector(4), '`8 113:15-113:24', 'zz422')
    i7 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(49), MachineIntConstant(41)], SmallFixedBitVector(9), '`8 114:15-114:24', 'zz418')
    i8 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(40), MachineIntConstant(32)], SmallFixedBitVector(9), '`8 115:15-115:24', 'zz414')
    i9 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(31), MachineIntConstant(0)], SmallFixedBitVector(32), '`8 116:15-116:23', 'zz410')
    i10 = block0.emit(StructConstruction, 'zEncCapability', [i8, i7, i9, i6, i5, i4, i3], Struct('zEncCapability', ('zB', 'zT', 'zaddress', 'zcE', 'zcotype', 'zcperms', 'zreserved'), (SmallFixedBitVector(9), SmallFixedBitVector(9), SmallFixedBitVector(32), SmallFixedBitVector(4), SmallFixedBitVector(3), SmallFixedBitVector(6), SmallFixedBitVector(1))), None, None)
    i11 = block0.emit(StructCopy, 'zEncCapability', [i10], Struct('zEncCapability', ('zB', 'zT', 'zaddress', 'zcE', 'zcotype', 'zcperms', 'zreserved'), (SmallFixedBitVector(9), SmallFixedBitVector(9), SmallFixedBitVector(32), SmallFixedBitVector(4), SmallFixedBitVector(3), SmallFixedBitVector(6), SmallFixedBitVector(1))), '`8 109:64-117:1', None)
    i12 = block0.emit(Operation, 'zencCapabilityToCapability', [zt, i11], Struct('zCapability', ('zB', 'zE', 'zT', 'zaccess_system_regs', 'zaddress', 'zglobal', 'zotype', 'zperm_user0', 'zpermit_execute', 'zpermit_load', 'zpermit_load_global', 'zpermit_load_mutable', 'zpermit_load_store_cap', 'zpermit_seal', 'zpermit_store', 'zpermit_store_local_cap', 'zpermit_unseal', 'zreserved', 'ztag'), (SmallFixedBitVector(9), SmallFixedBitVector(5), SmallFixedBitVector(9), Bool(), SmallFixedBitVector(32), Bool(), SmallFixedBitVector(4), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), SmallFixedBitVector(1), Bool())), '`8 330:69-330:124', 'return')
    block0.next = Return(i12, None)
    graph = Graph('zcapBitsToCapability', [zt, zc], block0)
    partial_allocation_removal(graph, fakecodegen)
    compare(graph, '''
zEncCapability = Struct('zEncCapability', ('zB', 'zT', 'zaddress', 'zcE', 'zcotype', 'zcperms', 'zreserved'), (SmallFixedBitVector(9), SmallFixedBitVector(9), SmallFixedBitVector(32), SmallFixedBitVector(4), SmallFixedBitVector(3), SmallFixedBitVector(6), SmallFixedBitVector(1)))
zCapability = Struct('zCapability', ('zB', 'zE', 'zT', 'zaccess_system_regs', 'zaddress', 'zglobal', 'zotype', 'zperm_user0', 'zpermit_execute', 'zpermit_load', 'zpermit_load_global', 'zpermit_load_mutable', 'zpermit_load_store_cap', 'zpermit_seal', 'zpermit_store', 'zpermit_store_local_cap', 'zpermit_unseal', 'zreserved', 'ztag'), (SmallFixedBitVector(9), SmallFixedBitVector(5), SmallFixedBitVector(9), Bool(), SmallFixedBitVector(32), Bool(), SmallFixedBitVector(4), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), SmallFixedBitVector(1), Bool()))
zt = Argument('zt', Bool())
zc = Argument('zc', SmallFixedBitVector(64))
block0 = Block()
i2 = block0.emit(Comment, 'inlined zcapBitsToEncCapability', [], Unit(), None, None)
i3 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(63), MachineIntConstant(63)], SmallFixedBitVector(1), '`8 110:15-110:24', 'zz434')
i4 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(62), MachineIntConstant(57)], SmallFixedBitVector(6), '`8 111:15-111:24', 'zz430')
i5 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(56), MachineIntConstant(54)], SmallFixedBitVector(3), '`8 112:15-112:24', 'zz426')
i6 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(53), MachineIntConstant(50)], SmallFixedBitVector(4), '`8 113:15-113:24', 'zz422')
i7 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(49), MachineIntConstant(41)], SmallFixedBitVector(9), '`8 114:15-114:24', 'zz418')
i8 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(40), MachineIntConstant(32)], SmallFixedBitVector(9), '`8 115:15-115:24', 'zz414')
i9 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zc, MachineIntConstant(31), MachineIntConstant(0)], SmallFixedBitVector(32), '`8 116:15-116:23', 'zz410')
i10 = block0.emit(StructConstruction, 'zEncCapability', [i8, i7, i9, i6, i5, i4, i3], zEncCapability, '`8 109:64-117:1', None)
i11 = block0.emit(Operation, 'zencCapabilityToCapability', [zt, i10], zCapability, '`8 330:69-330:124', 'return')
block0.next = Return(i11, None)
graph = Graph('zcapBitsToCapability', [zt, zc], block0)
''')

def test_vector_update_subrange():
    a1 = Argument('a1', MachineInt())
    a2 = Argument('a2', SmallFixedBitVector(8))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i0 = block0.emit(Cast, "$cast", [SmallBitVectorConstant(0, SmallFixedBitVector(32))], GenericBitVector())
    block0.next = Goto(block1)
    i1 = block1.emit_phi([block0, block2], [i0, None], GenericBitVector())
    i2 = block1.emit_phi([block0, block2], [MachineIntConstant(0), None], MachineInt())
    i3 = block1.emit(Operation, "vector_update_subrange_o_i_i_o", [i1, MachineIntConstant(7), MachineIntConstant(0), a2], types.GenericBitVector())
    i4 = block1.emit(Operation, "add_int", [i2, MachineIntConstant(1)], types.MachineInt())
    i5 = block1.emit(Operation, "@eq", [i4, MachineIntConstant(4)], types.Bool())
    block1.next = ConditionalGoto(i5, block3, block2)
    i1.prevvalues[1] = i3
    i2.prevvalues[1] = i4
    block2.next = Goto(block1)
    block3.next = Return(i3)

    g = Graph("g", [a1, a2], block0, True)
    check_optimize(g, '''
a1 = Argument('a1', MachineInt())
a2 = Argument('a2', SmallFixedBitVector(8))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block0.next = Goto(block1, None)
i2 = block1.emit_phi([block0, block3], [SmallBitVectorConstant(0x0, SmallFixedBitVector(32)), None], SmallFixedBitVector(32))
i3 = block1.emit_phi([block0, block3], [MachineIntConstant(0), None], MachineInt())
i4 = block1.emit(Operation, '@vector_update_subrange_fixed_bv_i_i_bv', [i2, MachineIntConstant(7), MachineIntConstant(0), a2], SmallFixedBitVector(32), None, None)
i2.prevvalues[1] = i4
i5 = block1.emit(Cast, '$cast', [i4], GenericBitVector(), None, None)
i6 = block1.emit(Operation, '@add_i_i_wrapped_res', [i3, MachineIntConstant(1)], MachineInt(), None, None)
i3.prevvalues[1] = i6
i7 = block1.emit(Operation, '@eq', [i6, MachineIntConstant(4)], Bool(), None, None)
block1.next = ConditionalGoto(i7, block2, block3, None)
block2.next = Return(i5, None)
block3.next = Goto(block1, None)
graph = Graph('g', [a1, a2], block0, True)
''')

def test_graph_rewriting_in_circles():
    zwalkparams = Argument('zwalkparams', Struct('zS1TTWParams', ('zcmow', 'zdc', 'zdct', 'zds', 'ze0pd', 'zee', 'zepan', 'zha', 'zhd', 'zhpd', 'zirgn', 'zmair', 'znfd', 'zntlsmd', 'znv1', 'zorgn', 'zps', 'zsh', 'zsif', 'zt0szz', 'zt1szz', 'ztbi', 'ztbid', 'ztgx', 'ztxszz', 'zuwxn', 'zwxn'), (SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(2), SmallFixedBitVector(64), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(2), SmallFixedBitVector(3), SmallFixedBitVector(2), SmallFixedBitVector(1), SmallFixedBitVector(3), SmallFixedBitVector(3), SmallFixedBitVector(1), SmallFixedBitVector(1), Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB')), SmallFixedBitVector(6), SmallFixedBitVector(1), SmallFixedBitVector(1))))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    i1 = block0.emit(FieldAccess, 'ztxszz', [zwalkparams], SmallFixedBitVector(6), None, None)
    i2 = block0.emit(Comment, 'inlined zAArch64_IASizze', [], Unit(), None, None)
    i3 = block0.emit(Operation, '@unsigned_bv', [i1, MachineIntConstant(6)], MachineInt(), '`7 9030:16-9030:26', 'zz47')
    i4 = block0.emit(Operation, '@sub_i_i_must_fit', [MachineIntConstant(64), i3], MachineInt(), '`7 9030:11-9030:26', 'zz45')
    i5 = block0.emit(FieldAccess, 'ztgx', [zwalkparams], Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB')), None, None)
    i6 = block0.emit(Comment, 'inlined zTGxGranuleBits', [], Unit(), None, None)
    i7 = block0.emit(Operation, '@eq', [EnumConstant('zTGx_4KB', Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB'))), i5], Bool(), '`7 9061:6-9061:13', None)
    block0.next = ConditionalGoto(i7, block1, block6, '`7 9061:6-9061:13')
    block1.next = Goto(block2, None)
    i11 = block2.emit_phi([block1, block7, block8], [IntConstant(9), IntConstant(11), IntConstant(13)], Int())
    i12 = block2.emit_phi([block1, block7, block8], [MachineIntConstant(12), MachineIntConstant(14), MachineIntConstant(16)], MachineInt())
    i13 = block2.emit(Operation, '@sub_i_i_wrapped_res', [i4, MachineIntConstant(1)], Int(), '`7 9394:29-9394:39', 'zz413')
    i14 = block2.emit(Operation, '@sub_o_i_wrapped_res', [i13, i12], Int(), '`7 9394:29-9394:53', 'zz412')
    i15 = block2.emit(Comment, 'inlined zfdiv_int', [], Unit(), None, None)
    i16 = block2.emit(Operation, 'lt_int', [i14, IntConstant(0)], Bool(), '`1 185:5-185:10', 'zz414')
    block2.next = ConditionalGoto(i16, block3, block5, '`1 185:5-185:18')
    i17 = block3.emit(Operation, '@add_o_i_wrapped_res', [i14, MachineIntConstant(1)], Int(), '`1 186:13-186:18', 'zz43')
    i18 = block3.emit(Operation, 'tdiv_int', [i17, i11], Int(), '`1 186:4-186:22', 'zz41')
    i19 = block3.emit(Operation, '@sub_o_i_wrapped_res', [i18, MachineIntConstant(1)], Int(), '`1 186:4-186:26', 'return')
    block3.next = Goto(block4, None)
    i20 = block4.emit_phi([block5, block3], [None, i19], Int())
    i21 = block4.emit(Operation, '@sub_i_o_wrapped_res', [MachineIntConstant(3), i20], Int(), '`7 9394:11-9394:62', 'zz49')
    block4.next = Return(i21, None)
    i22 = block5.emit(Operation, 'tdiv_int', [i14, i11], Int(), '`1 190:4-190:18', 'return')
    i20.prevvalues[0] = i22
    block5.next = Goto(block4, None)
    i23 = block6.emit(Operation, '@eq', [EnumConstant('zTGx_16KB', Enum('zTGx', ('zTGx_4KB', 'zTGx_16KB', 'zTGx_64KB'))), i5], Bool(), '`7 9064:6-9064:14', None)
    block6.next = ConditionalGoto(i23, block7, block8, '`7 9064:6-9064:14')
    block7.next = Goto(block2, None)
    block8.next = Goto(block2, None)
    graph = Graph('zAArch64_S1StartLevel_specialized_o', [zwalkparams], block0)
    repeat.debug_list = []
    try:
        res = optimize(graph, fakecodegen)
        assert len(repeat.debug_list) < 1000
    finally:
        repeat.debug_list = None


def test_compute_dominators():
    i = Argument('i', MachineInt())
    block1 = Block()
    block2 = Block()
    block4 = Block()
    block5 = Block()
    i34 = block1.emit(Operation, '@eq', [i, MachineIntConstant(32)], Bool(), '`94009', 'zz424')
    block1.next = ConditionalGoto(i34, block2, block4, '`10 150234:22-150234:43')
    i35 = block2.emit(Operation, 'usetheint', [i], Bool(), '`10 150235:4-150235:142', 'zz417')
    block2.next = Return(i35)
    i38 = block4.emit(Operation, '@eq', [i, MachineIntConstant(64)], Bool(), '`94020', 'zz425')
    block4.next = ConditionalGoto(i38, block2, block5, '`10 150217:4-150235:142')
    block5.next = Raise(StringConstant('src/instrs64.sail:150234.44-150234.45'), None)
    g = Graph("g", [i], block1)
    doms = compute_dominators(g)
    assert doms[block5] == {block1, block4, block5}
    assert doms[block2] == {block1, block2}
    assert doms[block4] == {block1, block4}
    assert doms[block1] == {block1}

    invdoms = dominatees(g)
    assert invdoms[block5] == {block5}
    assert invdoms[block2] == {block2}
    assert invdoms[block4] == {block5, block4}
    assert invdoms[block1] == {block1, block2, block4, block5}

def test_use_equality_information():
    i = Argument('i', MachineInt())
    block1 = Block()
    block2 = Block()
    block4 = Block()
    block5 = Block()
    i34 = block1.emit(Operation, '@eq', [i, MachineIntConstant(32)], Bool(), '`94009', 'zz424')
    block1.next = ConditionalGoto(i34, block2, block4, '`10 150234:22-150234:43')
    i35 = block2.emit(Operation, 'usetheint', [i], Bool(), '`10 150235:4-150235:142', 'zz417')
    block2.next = Return(i35)
    i38 = block4.emit(Operation, '@eq', [i, MachineIntConstant(64)], Bool(), '`94020', 'zz425')
    block4.next = ConditionalGoto(i38, block2, block5, '`10 150217:4-150235:142')
    block5.next = Raise(StringConstant('src/instrs64.sail:150234.44-150234.45'), None)
    g = Graph("g", [i], block1)
    res = propagate_equality(g, fakecodegen)
    assert res
    compare(g, """
i = Argument('i', MachineInt())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
i1 = block0.emit(Operation, '@eq', [i, MachineIntConstant(32)], Bool(), '`94009', 'zz424')
block0.next = ConditionalGoto(i1, block1, block2, '`10 150234:22-150234:43')
i2 = block1.emit_phi([block0, block2], [MachineIntConstant(32), MachineIntConstant(64)], MachineInt())
i3 = block1.emit(Operation, 'usetheint', [i2], Bool(), '`10 150235:4-150235:142', 'zz417')
block1.next = Return(i3, None)
i4 = block2.emit(Operation, '@eq', [i, MachineIntConstant(64)], Bool(), '`94020', 'zz425')
block2.next = ConditionalGoto(i4, block1, block3, '`10 150217:4-150235:142')
block3.next = Raise(StringConstant('src/instrs64.sail:150234.44-150234.45'), None)
graph = Graph('g', [i], block0)
""")

def test_use_equality_information_dominatees():
    i = Argument('i', MachineInt())
    block1 = Block()
    block2 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    i34 = block1.emit(Operation, '@eq', [i, MachineIntConstant(32)], Bool(), '`94009', 'zz424')
    block1.next = ConditionalGoto(i34, block2, block4, '`10 150234:22-150234:43')
    i35 = block2.emit(Operation, 'usetheint', [i], Bool(), '`10 150235:4-150235:142', 'zz417')
    block2.next = Goto(block6)
    i38 = block4.emit(Operation, '@eq', [i, MachineIntConstant(64)], Bool(), '`94020', 'zz425')
    block4.next = ConditionalGoto(i38, block2, block5, '`10 150217:4-150235:142')
    block5.next = Raise(StringConstant('src/instrs64.sail:150234.44-150234.45'), None)
    i40 = block6.emit(Operation, 'usetheint_again', [i, i35], Bool(), '`10 150235:4-150235:142', 'zz417')
    block6.next = Return(i40)
    g = Graph("g", [i], block1)
    res = propagate_equality(g, fakecodegen)
    assert res
    compare(g, """
i = Argument('i', MachineInt())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
i1 = block0.emit(Operation, '@eq', [i, MachineIntConstant(32)], Bool(), '`94009', 'zz424')
block0.next = ConditionalGoto(i1, block1, block3, '`10 150234:22-150234:43')
i2 = block1.emit_phi([block0, block3], [MachineIntConstant(32), MachineIntConstant(64)], MachineInt())
i3 = block1.emit(Operation, 'usetheint', [i2], Bool(), '`10 150235:4-150235:142', 'zz417')
block1.next = Goto(block2, None)
i4 = block2.emit(Operation, 'usetheint_again', [i2, i3], Bool(), '`10 150235:4-150235:142', 'zz417')
block2.next = Return(i4, None)
i5 = block3.emit(Operation, '@eq', [i, MachineIntConstant(64)], Bool(), '`94020', 'zz425')
block3.next = ConditionalGoto(i5, block1, block4, '`10 150217:4-150235:142')
block4.next = Raise(StringConstant('src/instrs64.sail:150234.44-150234.45'), None)
graph = Graph('g', [i], block0)
""")

def test_check_finds_wrong_use_of_idoms():
    i = Argument('i', Int())
    j = Argument('j', Int())
    block1 = Block()
    block2 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    i1 = block1.emit(Operation, '@eq', [i, IntConstant(32)], Bool(), '`94009', 'zz424')
    i10 = block1.emit(Operation, '@add', [i, j], Bool(), '`94009', 'zz424')

    block1.next = ConditionalGoto(i1, block2, block4, '`10 150234:22-150234:43')
    i20 = block2.emit_phi([block1, block4], [i10, None], Int())
    i2 = block2.emit(Operation, 'usetheint', [i20], Bool(), '`10 150235:4-150235:142', 'zz417')
    block2.next = Goto(block6)
    i3 = block4.emit(Operation, '@eq', [i, IntConstant(64)], Bool(), '`94020', 'zz425')
    i30 = block4.emit(Operation, '@add', [i, j], Bool(), '`94009', 'zz424')
    i20.prevvalues[1] = i30
    block4.next = ConditionalGoto(i3, block2, block5, '`10 150217:4-150235:142')
    block5.next = Raise(StringConstant('src/instrs64.sail:150234.44-150234.45'), None)
    i4 = block6.emit(Operation, 'usetheint_again', [i10, i30], Bool(), '`10 150235:4-150235:142', 'zz417')
    block6.next = Return(i4)
    g = Graph("g", [i, j], block1)
    with pytest.raises(AssertionError):
        g.check()

def test_rshift_lshift_to_mask():
    bv = Argument('bv', SmallFixedBitVector(64))
    block0 = Block()
    i24 = block0.emit(Operation, '@unsigned_bv64_rshift_int_result', [bv, MachineIntConstant(4)], MachineInt(), None, None)
    i25 = block0.emit(Operation, '@shl_int_i_i_wrapped_res', [i24, MachineIntConstant(4)], Int(), '`7 2885:11-2885:24', 'zz40')
    i27 = block0.emit(Operation, '@get_slice_int_i_o_i_unwrapped_res', [MachineIntConstant(64), i25, MachineIntConstant(0)], SmallFixedBitVector(64), '`5 176:39-176:72', 'return')
    block0.next = Return(i27)
    g = Graph("g", [bv], block0)
    check_optimize(g, '''
bv = Argument('bv', SmallFixedBitVector(64))
block0 = Block()
i1 = block0.emit(Operation, '@and_vec_bv_bv', [bv, SmallBitVectorConstant(0xfffffffffffffff0L, SmallFixedBitVector(64))], SmallFixedBitVector(64), '`5 176:39-176:72', 'return')
block0.next = Return(i1, None)
graph = Graph('g', [bv], block0)
''')

def test_mult_i_i_must_fit_to_shift():
    mi = Argument('mi', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@mult_i_i_must_fit', [mi, MachineIntConstant(16)], MachineInt(), None, None)
    block0.next = Return(i1)
    g = Graph("g", [mi], block0)
    check_optimize(g, '''
mi = Argument('mi', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@shl_int_i_i_must_fit', [mi, MachineIntConstant(4)], MachineInt(), None, None)
block0.next = Return(i1, None)
graph = Graph('g', [mi], block0)
''')

def test_lower_neg_int():
    mi = Argument('mi', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, 'int64_to_int', [mi], Int(), None, None)
    i2 = block0.emit(Operation, 'neg_int', [i1], Int())
    i3 = block0.emit(Operation, 'int_to_int64', [i2], MachineInt(), None, None)
    block0.next = Return(i3)
    g = Graph("g", [mi], block0)
    check_optimize(g, '''
mi = Argument('mi', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@sub_i_i_must_fit', [MachineIntConstant(0), mi], MachineInt(), None, None)
block0.next = Return(i1, None)
graph = Graph('g', [mi], block0)
''')

def test_cse_global_reads():
    zel = Argument('zel', SmallFixedBitVector(2))
    zsecure = Argument('zsecure', Bool())
    block4 = Block()
    block10 = Block()
    block11 = Block()
    block12 = Block()
    block13 = Block()
    block14 = Block()
    block15 = Block()
    block16 = Block()
    block17 = Block()
    block18 = Block()
    block19 = Block()
    block20 = Block()
    block21 = Block()
    block22 = Block()
    block23 = Block()
    block24 = Block()
    block25 = Block()
    block26 = Block()
    block27 = Block()
    i14 = block10.emit(Operation, 'undefined_bool', [UnitConstant.UNIT], Bool(), '`5 336:46-336:55', 'return')
    i16 = block10.emit(GlobalRead, 'zSCR_EL3', [], SmallFixedBitVector(64), None, None)
    i17 = block10.emit(Operation, '@slice_fixed_bv_i_i', [i16, MachineIntConstant(10), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 197:50-197:71', 'zz497')
    i18 = block10.emit(Operation, '@eq_bits_bv_bv', [i17, SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], Bool(), '`7 197:50-197:78', 'zz490')
    block10.next = ConditionalGoto(i18, block11, block18, '`7 197:35-197:164')
    block11.next = ConditionalGoto(zsecure, block12, block13, '`7 197:84-197:131')
    i21 = block12.emit(GlobalRead, 'zSCR_EL3', [], SmallFixedBitVector(64), None, None)
    i22 = block12.emit(Operation, '@slice_fixed_bv_i_i', [i21, MachineIntConstant(18), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 197:135-197:156', 'zz485')
    i23 = block12.emit(Operation, '@eq_bits_bv_bv', [i22, SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], Bool(), '`7 197:135-197:163', 'zz478')
    block12.next = ConditionalGoto(i23, block13, block18, '`7 198:32-198:265')
    block13.next = Goto(block14, None)
    i24 = block14.emit_phi([block13, block25, block24], [BooleanConstant.TRUE, i14, None], Bool())
    i25 = block14.emit_phi([block13, block25, block24], [BooleanConstant.TRUE, BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
    block14.next = ConditionalGoto(i25, block15, block17, '`7 208:4-210:5')
    block15.next = Goto(block16, None)
    i26 = block16.emit_phi([block15, block17], [i24, i14], Bool())
    block16.next = Goto(block4, None)
    block17.next = Goto(block16, None)
    i31 = block18.emit(GlobalRead, 'zSCR_EL3', [], SmallFixedBitVector(64), None, None)
    i32 = block18.emit(Operation, '@slice_fixed_bv_i_i', [i31, MachineIntConstant(18), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 198:90-198:111', 'zz474')
    i33 = block18.emit(Operation, '@eq_bits_bv_bv', [i32, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 198:90-198:118', 'zz467')
    block18.next = ConditionalGoto(i33, block19, block26, '`7 198:69-198:137')
    i34 = block19.emit(GlobalRead, 'zHCR_EL2', [], SmallFixedBitVector(64), None, None)
    i35 = block19.emit(Operation, '@slice_fixed_bv_i_i', [i34, MachineIntConstant(31), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 198:142-198:163', 'zz461')
    i36 = block19.emit(Operation, '@eq_bits_bv_bv', [i35, SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], Bool(), '`7 198:142-198:170', 'zz454')
    block19.next = ConditionalGoto(i36, block20, block23, '`7 198:52-198:265')
    i37 = block20.emit(GlobalRead, 'zHCR_EL2', [], SmallFixedBitVector(64), None, None)
    i38 = block20.emit(Operation, '@slice_fixed_bv_i_i', [i37, MachineIntConstant(34), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 198:184-198:205', 'zz452')
    i39 = block20.emit(Operation, '@eq_bits_bv_bv', [i38, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 198:184-198:212', 'zz437')
    block20.next = ConditionalGoto(i39, block21, block13, '`7 198:184-198:243')
    i40 = block21.emit(GlobalRead, 'zHCR_EL2', [], SmallFixedBitVector(64), None, None)
    i41 = block21.emit(Operation, '@slice_fixed_bv_i_i', [i40, MachineIntConstant(27), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 198:215-198:236', 'zz445')
    i42 = block21.emit(Operation, '@eq_bits_bv_bv', [i41, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 198:215-198:243', 'zz438')
    block21.next = ConditionalGoto(i42, block22, block13, '`7 198:183-198:264')
    block22.next = Goto(block23, None)
    i45 = block23.emit(GlobalRead, 'zPSTATE', [], Struct('zProcState', ('zA', 'zALLINT', 'zBTYPE', 'zC', 'zD', 'zDIT', 'zE', 'zEL', 'zF', 'zGE', 'zI', 'zIL', 'zIT', 'zJ', 'zM', 'zN', 'zPAN', 'zQ', 'zSM', 'zSP', 'zSS', 'zSSBS', 'zT', 'zTCO', 'zUAO', 'zV', 'zZ', 'zZA', 'znRW'), (SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(2), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(2), SmallFixedBitVector(1), SmallFixedBitVector(4), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(8), SmallFixedBitVector(1), SmallFixedBitVector(5), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1))), None, None)
    i46 = block23.emit(FieldAccess, 'zEL', [i45], SmallFixedBitVector(2), None, None)
    i47 = block23.emit(Operation, '@eq_bits_bv_bv', [i46, SmallBitVectorConstant(0b0, SmallFixedBitVector(2))], Bool(), '`7 200:11-200:27', 'zz48')
    block23.next = ConditionalGoto(i47, block24, block25, '`7 200:8-204:9')
    i48 = block24.emit(GlobalRead, 'zPSTATE', [], Struct('zProcState', ('zA', 'zALLINT', 'zBTYPE', 'zC', 'zD', 'zDIT', 'zE', 'zEL', 'zF', 'zGE', 'zI', 'zIL', 'zIT', 'zJ', 'zM', 'zN', 'zPAN', 'zQ', 'zSM', 'zSP', 'zSS', 'zSSBS', 'zT', 'zTCO', 'zUAO', 'zV', 'zZ', 'zZA', 'znRW'), (SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(2), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(2), SmallFixedBitVector(1), SmallFixedBitVector(4), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(8), SmallFixedBitVector(1), SmallFixedBitVector(5), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1))), None, None)
    i49 = block24.emit(FieldAccess, 'znRW', [i48], SmallFixedBitVector(1), None, None)
    i50 = block24.emit(Operation, '@eq_bits_bv_bv', [i49, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 201:22-201:39', 'zz40')
    i24.prevvalues[2] = i50
    block24.next = Goto(block14, None)
    block25.next = Goto(block14, None)
    block26.next = ConditionalGoto(zsecure, block23, block19, '`7 198:53-198:170')
    i7 = block4.emit(StructConstruction, 'ztuplez3z5bool_z5bool', [i25, i26], Struct('ztuplez3z5bool_z5bool', ('ztuplez3z5bool_z5bool0', 'ztuplez3z5bool_z5bool1'), (Bool(), Bool()), True), None, None)
    block4.next = Return(i7, None)
    graph = Graph('zELStateUsingAArch32K', [zel, zsecure], block10)
    cse_global_reads(graph, fakecodegen)
    compare(graph, '''
ztuplez3z5bool_z5bool = Struct('ztuplez3z5bool_z5bool', ('ztuplez3z5bool_z5bool0', 'ztuplez3z5bool_z5bool1'), (Bool(), Bool()), True)
zProcState = Struct('zProcState', ('zA', 'zALLINT', 'zBTYPE', 'zC', 'zD', 'zDIT', 'zE', 'zEL', 'zF', 'zGE', 'zI', 'zIL', 'zIT', 'zJ', 'zM', 'zN', 'zPAN', 'zQ', 'zSM', 'zSP', 'zSS', 'zSSBS', 'zT', 'zTCO', 'zUAO', 'zV', 'zZ', 'zZA', 'znRW'), (SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(2), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(2), SmallFixedBitVector(1), SmallFixedBitVector(4), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(8), SmallFixedBitVector(1), SmallFixedBitVector(5), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1), SmallFixedBitVector(1)))
zel = Argument('zel', SmallFixedBitVector(2))
zsecure = Argument('zsecure', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
block8 = Block()
block9 = Block()
block10 = Block()
block11 = Block()
block12 = Block()
block13 = Block()
block14 = Block()
block15 = Block()
block16 = Block()
block17 = Block()
i2 = block0.emit(Operation, 'undefined_bool', [UnitConstant.UNIT], Bool(), '`5 336:46-336:55', 'return')
i3 = block0.emit(GlobalRead, 'zSCR_EL3', [], SmallFixedBitVector(64), None, None)
i4 = block0.emit(Operation, '@slice_fixed_bv_i_i', [i3, MachineIntConstant(10), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 197:50-197:71', 'zz497')
i5 = block0.emit(Operation, '@eq_bits_bv_bv', [i4, SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], Bool(), '`7 197:50-197:78', 'zz490')
block0.next = ConditionalGoto(i5, block1, block9, '`7 197:35-197:164')
block1.next = ConditionalGoto(zsecure, block2, block3, '`7 197:84-197:131')
i6 = block2.emit(Operation, '@slice_fixed_bv_i_i', [i3, MachineIntConstant(18), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 197:135-197:156', 'zz485')
i7 = block2.emit(Operation, '@eq_bits_bv_bv', [i6, SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], Bool(), '`7 197:135-197:163', 'zz478')
block2.next = ConditionalGoto(i7, block3, block9, '`7 198:32-198:265')
block3.next = Goto(block4, None)
i8 = block4.emit_phi([block3, block16, block15], [BooleanConstant.TRUE, i2, None], Bool())
i9 = block4.emit_phi([block3, block16, block15], [BooleanConstant.TRUE, BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
block4.next = ConditionalGoto(i9, block5, block8, '`7 208:4-210:5')
block5.next = Goto(block6, None)
i10 = block6.emit_phi([block5, block8], [i8, i2], Bool())
block6.next = Goto(block7, None)
i11 = block7.emit(StructConstruction, 'ztuplez3z5bool_z5bool', [i9, i10], ztuplez3z5bool_z5bool, None, None)
block7.next = Return(i11, None)
block8.next = Goto(block6, None)
i12 = block9.emit(Operation, '@slice_fixed_bv_i_i', [i3, MachineIntConstant(18), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 198:90-198:111', 'zz474')
i13 = block9.emit(Operation, '@eq_bits_bv_bv', [i12, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 198:90-198:118', 'zz467')
block9.next = ConditionalGoto(i13, block10, block17, '`7 198:69-198:137')
i14 = block10.emit(GlobalRead, 'zHCR_EL2', [], SmallFixedBitVector(64), None, None)
i15 = block10.emit(Operation, '@slice_fixed_bv_i_i', [i14, MachineIntConstant(31), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 198:142-198:163', 'zz461')
i16 = block10.emit(Operation, '@eq_bits_bv_bv', [i15, SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], Bool(), '`7 198:142-198:170', 'zz454')
block10.next = ConditionalGoto(i16, block11, block14, '`7 198:52-198:265')
i17 = block11.emit(Operation, '@slice_fixed_bv_i_i', [i14, MachineIntConstant(34), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 198:184-198:205', 'zz452')
i18 = block11.emit(Operation, '@eq_bits_bv_bv', [i17, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 198:184-198:212', 'zz437')
block11.next = ConditionalGoto(i18, block12, block3, '`7 198:184-198:243')
i19 = block12.emit(Operation, '@slice_fixed_bv_i_i', [i14, MachineIntConstant(27), MachineIntConstant(1)], SmallFixedBitVector(1), '`7 198:215-198:236', 'zz445')
i20 = block12.emit(Operation, '@eq_bits_bv_bv', [i19, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 198:215-198:243', 'zz438')
block12.next = ConditionalGoto(i20, block13, block3, '`7 198:183-198:264')
block13.next = Goto(block14, None)
i21 = block14.emit(GlobalRead, 'zPSTATE', [], zProcState, None, None)
i22 = block14.emit(FieldAccess, 'zEL', [i21], SmallFixedBitVector(2), None, None)
i23 = block14.emit(Operation, '@eq_bits_bv_bv', [i22, SmallBitVectorConstant(0b0, SmallFixedBitVector(2))], Bool(), '`7 200:11-200:27', 'zz48')
block14.next = ConditionalGoto(i23, block15, block16, '`7 200:8-204:9')
i24 = block15.emit(FieldAccess, 'znRW', [i21], SmallFixedBitVector(1), None, None)
i25 = block15.emit(Operation, '@eq_bits_bv_bv', [i24, SmallBitVectorConstant(0b1, SmallFixedBitVector(1))], Bool(), '`7 201:22-201:39', 'zz40')
i8.prevvalues[2] = i25
block15.next = Goto(block4, None)
block16.next = Goto(block4, None)
block17.next = ConditionalGoto(zsecure, block14, block10, '`7 198:53-198:170')
graph = Graph('zELStateUsingAArch32K', [zel, zsecure], block0)
''')


def test_eq_self():
    template = '''
i = Argument('i', MachineInt())
block0 = Block()
block0.next = Return(BooleanConstant.%s, None)
graph = Graph('g', [i], block0)
'''
    true_res = template % "TRUE"
    false_res = template % "FALSE"

    for op in ("@lteq", "@gteq", "@eq"):
        i = Argument("i", MachineInt())
        block1 = Block()
        i1 = block1.emit(Operation, op, [i, i], Bool())
        block1.next = Return(i1)
        g = Graph('g', [i], block1)
        check_optimize(g, true_res)

    for op in ("@lt", "@gt"):
        i = Argument("i", MachineInt())
        block1 = Block()
        i1 = block1.emit(Operation, op, [i, i], Bool())
        block1.next = Return(i1)
        g = Graph('g', [i], block1)
        check_optimize(g, false_res)

def test_add_sub_consts():
    # constants add up to 0
    i = Argument("i", MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@sub_i_i_must_fit', [i, MachineIntConstant(1)], MachineInt(), '`1 231:32-231:43', 'zz40')
    i2 = block0.emit(Operation, '@add_i_i_must_fit', [i1, MachineIntConstant(1)], MachineInt(), None, None)
    block0.next = Return(i2, None)
    graph = Graph('f', [i], block0)
    check_optimize(graph, """
i = Argument('i', MachineInt())
block0 = Block()
block0.next = Return(i, None)
graph = Graph('f', [i], block0)
""")

    # several constants combined into one
    i = Argument("i", MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@sub_i_i_must_fit', [i, MachineIntConstant(1)], MachineInt(), '`1 231:32-231:43', 'zz40')
    i2 = block0.emit(Operation, '@add_i_i_must_fit', [i1, MachineIntConstant(5)], MachineInt(), None, None)
    block0.next = Return(i2, None)
    graph = Graph('f', [i], block0)
    check_optimize(graph, """
i = Argument('i', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@add_i_i_must_fit', [i, MachineIntConstant(4)], MachineInt(), None, None)
block0.next = Return(i1, None)
graph = Graph('f', [i], block0)
""")

    # same components get added and subtracted
    i = Argument("i", MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@sub_i_i_must_fit', [i, MachineIntConstant(1)], MachineInt(), '`1 231:32-231:43', 'zz40')
    i2 = block0.emit(Operation, '@add_i_i_must_fit', [i1, MachineIntConstant(5)], MachineInt(), None, None)
    i2 = block0.emit(Operation, '@sub_i_i_must_fit', [i2, i], MachineInt(), None, None)
    block0.next = Return(i2, None)
    graph = Graph('f', [i], block0)
    check_optimize(graph, """
i = Argument('i', MachineInt())
block0 = Block()
block0.next = Return(MachineIntConstant(4), None)
graph = Graph('f', [i], block0)
""")

    # result has additions and subtractions
    i = Argument("i", MachineInt())
    j = Argument("j", MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@sub_i_i_must_fit', [i, MachineIntConstant(1)], MachineInt(), '`1 231:32-231:43', 'zz40')
    i2 = block0.emit(Operation, '@add_i_i_must_fit', [i1, MachineIntConstant(5)], MachineInt(), None, None)
    i3 = block0.emit(Operation, '@sub_i_i_must_fit', [i2, i], MachineInt(), None, None)
    i4 = block0.emit(Operation, '@sub_i_i_must_fit', [i3, j], MachineInt(), None, None)
    block0.next = Return(i4, None)
    graph = Graph('f', [i, j], block0)
    check_optimize(graph, """
i = Argument('i', MachineInt())
j = Argument('j', MachineInt())
block0 = Block()
i2 = block0.emit(Operation, '@sub_i_i_must_fit', [MachineIntConstant(4), j], MachineInt(), None, None)
block0.next = Return(i2, None)
graph = Graph('f', [i, j], block0)
""")

def test_add_sub_consts_keep_must_fit():
    # result has additions and subtractions, but we can only simplify at the end
    # make sure we use _must_fit variants!
    i = Argument("i", MachineInt())
    j = Argument("j", MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@add_i_i_must_fit', [i, j], MachineInt(), '`1 231:32-231:43', 'zz40')
    i2 = block0.emit(Operation, '@add_i_i_must_fit', [j, MachineIntConstant(5)], MachineInt(), None, None)
    i3 = block0.emit(Operation, '@add_i_i_must_fit', [i2, MachineIntConstant(0)], MachineInt(), None, None)
    i4 = block0.emit(Operation, '@add_i_i_must_fit', [i3, i1], MachineInt(), None, None)
    block0.next = Return(i4, None)
    graph = Graph('f', [i, j], block0)
    check_optimize(graph, """
i = Argument('i', MachineInt())
j = Argument('j', MachineInt())
block0 = Block()
i2 = block0.emit(Operation, '@add_i_i_must_fit', [i, j], MachineInt(), '`1 231:32-231:43', 'zz40')
i3 = block0.emit(Operation, '@add_i_i_must_fit', [j, MachineIntConstant(5)], MachineInt(), None, None)
i4 = block0.emit(Operation, '@add_i_i_must_fit', [i3, i2], MachineInt(), None, None)
block0.next = Return(i4, None)
graph = Graph('f', [i, j], block0)
""")

    i = Argument("i", MachineInt())
    j = Argument("j", MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@add_i_i_must_fit', [i, j], MachineInt(), '`1 231:32-231:43', 'zz40')
    i2 = block0.emit(Operation, '@add_i_i_must_fit', [j, MachineIntConstant(5)], MachineInt(), None, None)
    i3 = block0.emit(Operation, '@add_i_i_must_fit', [i2, MachineIntConstant(2)], MachineInt(), None, None)
    i4 = block0.emit(Operation, '@add_i_i_must_fit', [i3, i1], MachineInt(), None, None)
    block0.next = Return(i4, None)
    graph = Graph('f', [i, j], block0)
    check_optimize(graph, """
i = Argument('i', MachineInt())
j = Argument('j', MachineInt())
block0 = Block()
i2 = block0.emit(Operation, '@add_i_i_must_fit', [i, j], MachineInt(), '`1 231:32-231:43', 'zz40')
i3 = block0.emit(Operation, '@add_i_i_must_fit', [j, MachineIntConstant(7)], MachineInt(), None, None)
i4 = block0.emit(Operation, '@add_i_i_must_fit', [i3, i2], MachineInt(), None, None)
block0.next = Return(i4, None)
graph = Graph('f', [i, j], block0)
""")

def test_add_sub_lteq():
    i = Argument("i", Int())
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i0 = block1.emit(Operation, 'add_int', [i, IntConstant(1)], Int())
    i1 = block1.emit(Operation, 'lteq', [IntConstant(0), i0], Bool(), '`7 9343:23-9343:35', 'zz435')
    block1.next = ConditionalGoto(i1, block2, block3, '`7 9343:23-9343:51')
    block3.next = Raise(StringConstant('negative!'), None)
    i2 = block2.emit(Operation, "zz5izDzKz5i64", [i], MachineInt())
    i3 = block2.emit(Operation, "@sub_i_i_wrapped_res", [i2, MachineIntConstant(1)], Int())
    i4 = block2.emit(Operation, "@add_o_i_wrapped_res", [i, MachineIntConstant(1)], Int())
    i5 = block2.emit(Operation, "add_int", [i3, i4], Int())
    i6 = block2.emit(Operation, "zz5izDzKz5i64", [i5], MachineInt())
    block2.next = Return(i6)
    g = Graph('g', [i], block1)
    check_optimize(g, '''
i = Argument('i', Int())
block0 = Block()
block1 = Block()
block2 = Block()
i1 = block0.emit(Operation, 'zz5izDzKz5i64', [i], MachineInt(), None, None)
i2 = block0.emit(Operation, '@lteq', [MachineIntConstant(-1), i1], Bool(), '`7 9343:23-9343:35', 'zz435')
block0.next = ConditionalGoto(i2, block1, block2, '`7 9343:23-9343:51')
i3 = block1.emit(Operation, '@add_i_i_must_fit', [i1, i1], MachineInt(), None, None)
block1.next = Return(i3, None)
block2.next = Raise(StringConstant('negative!'), None)
graph = Graph('g', [i], block0)
''')

    i = Argument("i", Int())
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i0 = block1.emit(Operation, 'add_int', [i, IntConstant(1)], Int())
    i1 = block1.emit(Operation, '@gteq', [i0, IntConstant(0)], Bool(), '`7 9343:23-9343:35', 'zz435')
    block1.next = ConditionalGoto(i1, block2, block3, '`7 9343:23-9343:51')
    block3.next = Raise(StringConstant('negative!'), None)
    i2 = block2.emit(Operation, "zz5izDzKz5i64", [i], MachineInt())
    i3 = block2.emit(Operation, "@sub_i_i_wrapped_res", [i2, MachineIntConstant(1)], Int())
    i4 = block2.emit(Operation, "@add_o_i_wrapped_res", [i, MachineIntConstant(1)], Int())
    i5 = block2.emit(Operation, "add_int", [i3, i4], Int())
    i6 = block2.emit(Operation, "zz5izDzKz5i64", [i5], MachineInt())
    block2.next = Return(i6)
    g = Graph('g', [i], block1)
    check_optimize(g, '''
i = Argument('i', Int())
block0 = Block()
block1 = Block()
block2 = Block()
i1 = block0.emit(Operation, 'zz5izDzKz5i64', [i], MachineInt(), None, None)
i2 = block0.emit(Operation, '@gteq', [i1, MachineIntConstant(-1)], Bool(), '`7 9343:23-9343:35', 'zz435')
block0.next = ConditionalGoto(i2, block1, block2, '`7 9343:23-9343:51')
i3 = block1.emit(Operation, '@add_i_i_must_fit', [i1, i1], MachineInt(), None, None)
block1.next = Return(i3, None)
block2.next = Raise(StringConstant('negative!'), None)
graph = Graph('g', [i], block0)
''')

    i = Argument("i", Int())
    block1 = Block()
    block2 = Block()
    block3 = Block()
    i0 = block1.emit(Operation, 'add_int', [i, IntConstant(1)], Int())
    i1 = block1.emit(Operation, '@gteq', [i0, i], Bool(), '`7 9343:23-9343:35', 'zz435')
    block1.next = ConditionalGoto(i1, block2, block3, '`7 9343:23-9343:51')
    block3.next = Raise(StringConstant('negative!'), None)
    i2 = block2.emit(Operation, "zz5izDzKz5i64", [i], MachineInt())
    i3 = block2.emit(Operation, "@sub_i_i_wrapped_res", [i2, MachineIntConstant(1)], Int())
    i4 = block2.emit(Operation, "@add_o_i_wrapped_res", [i, MachineIntConstant(1)], Int())
    i5 = block2.emit(Operation, "add_int", [i3, i4], Int())
    i6 = block2.emit(Operation, "zz5izDzKz5i64", [i5], MachineInt())
    block2.next = Return(i6)
    g = Graph('g', [i], block1)
    check_optimize(g, '''
i = Argument('i', Int())
block0 = Block()
i1 = block0.emit(Operation, 'zz5izDzKz5i64', [i], MachineInt(), None, None)
i2 = block0.emit(Operation, '@add_i_i_must_fit', [i1, i1], MachineInt(), None, None)
block0.next = Return(i2, None)
graph = Graph('g', [i], block0)
''')

def test_vector_subrange_to_slice():
    v = Argument('v', SmallFixedBitVector(64))
    i = Argument('i', MachineInt())
    block0 = Block()
    i1 = block0.emit(Operation, '@add_i_i_wrapped_res', [MachineIntConstant(6), i], Int(), '`36 84:17-84:31', 'zz412137')
    i2 = block0.emit(Operation, 'int64_to_int', [i], Int(), '`36 84:17-84:31', 'zz412138')
    i3 = block0.emit(Cast, '$cast', [v], GenericBitVector(), '`36 84:17-84:31', 'zz412139')
    i4 = block0.emit(Operation, 'vector_subrange', [i3, i1, i2], GenericBitVector(), '`36 84:17-84:31', 'zz412140')
    i5 = block0.emit(Cast, '$cast', [i4], SmallFixedBitVector(7), '`36 84:17-84:31', 'zz412111')
    block0.next = Return(i5)
    graph = Graph("f", [v, i], block0)
    check_optimize(graph, """
v = Argument('v', SmallFixedBitVector(64))
i = Argument('i', MachineInt())
block0 = Block()
i2 = block0.emit(Operation, '@slice_fixed_bv_i_i', [v, i, MachineIntConstant(7)], SmallFixedBitVector(7), '`36 84:17-84:31', 'zz412140')
block0.next = Return(i2, None)
graph = Graph('f', [v, i], block0)
""")

def test_huge_vector_construction():
    block1 = Block()
    i15 = block1.emit(Operation, 'UINT64_C', [MachineIntConstant(0)], GenericBitVector(), None, 'zz434')
    i16 = block1.emit(Operation, 'append_64', [i15, SmallBitVectorConstant(0x0, SmallFixedBitVector(64))], GenericBitVector(), '`6627', 'zz434')
    i17 = block1.emit(Operation, 'append_64', [i16, SmallBitVectorConstant(0x0, SmallFixedBitVector(64))], GenericBitVector(), '`6628', 'zz434')
    i18 = block1.emit(Operation, 'append_64', [i17, SmallBitVectorConstant(0x0, SmallFixedBitVector(64))], GenericBitVector(), '`6629', 'zz434')
    i19 = block1.emit(Operation, 'append_64', [i18, SmallBitVectorConstant(0x0, SmallFixedBitVector(64))], GenericBitVector(), '`6630', 'zz434')
    i20 = block1.emit(Cast, '$cast', [i19], BigFixedBitVector(256), '`7651', 'zz42')
    block1.next = Return(i20)
    g = Graph("f", [], block1)
    check_optimize(g, '''
block0 = Block()
i0 = block0.emit(Cast, '$cast', [GenericBitVectorConstant(bitvector.from_ruint(256, r_uint(0)))], BigFixedBitVector(256), '`7651', 'zz42')
block0.next = Return(i0, None)
graph = Graph('f', [], block0)
''')

def test_union_check_constant():
    zoptionzIbzK = Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))
    block1 = Block()
    a = Argument('a', GenericBitVector())
    i8 = block1.emit(Operation, 'zSomezIbzK', [a], zoptionzIbzK, '`4357', 'zz412118')
    i10 = block1.emit(UnionVariantCheck, 'zSomezIbzK', [i8], Bool(), '`4361', None)
    block1.next = Return(i10)
    g = Graph("f", [a], block1)
    check_optimize(g, '''
a = Argument('a', GenericBitVector())
block0 = Block()
block0.next = Return(BooleanConstant.FALSE, None)
graph = Graph('f', [a], block0)
''')
    block1 = Block()
    a = Argument('a', GenericBitVector())
    i8 = block1.emit(Operation, 'zSomezIbzK', [a], zoptionzIbzK, '`4357', 'zz412118')
    i10 = block1.emit(UnionVariantCheck, 'zNonezIbzK', [i8], Bool(), '`4361', None)
    block1.next = Return(i10)
    g = Graph("f", [a], block1)
    check_optimize(g, '''
a = Argument('a', GenericBitVector())
block0 = Block()
block0.next = Return(BooleanConstant.TRUE, None)
graph = Graph('f', [a], block0)
''')

def test_union_check_phi():
    zoptionzIbzK = Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    a = Argument('a', GenericBitVector())
    b = Argument('b', Bool())
    block0.next = ConditionalGoto(b, block1, block6)
    i8 = block1.emit(Operation, 'zSomezIbzK', [a], zoptionzIbzK, '`4357', 'zz412118')
    block1.next = Goto(block2, None)
    i9 = block2.emit_phi([block1, block6], [i8, None], zoptionzIbzK)
    i10 = block2.emit(UnionVariantCheck, 'zSomezIbzK', [i9], Bool(), '`4361', None)
    block2.next = ConditionalGoto(i10, block3, block5, '`4361')
    i11 = block3.emit(UnionVariantCheck, 'zNonezIbzK', [i9], Bool(), '`4365', None)
    block3.next = ConditionalGoto(i11, block4, block4, '`4365')
    block4.next = Raise(StringConstant('match'), '`14234')
    i3024 = block6.emit(Operation, 'zNonezIbzK', [UnitConstant.UNIT], zoptionzIbzK, '`4358', 'zz412109')
    i9.prevvalues[1] = i3024
    block6.next = Goto(block2, None)
    block5.next = Return(i9)
    g = Graph("f", [a, b], block0)
    check_optimize(g, '''
zoptionzIbzK = Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))
a = Argument('a', GenericBitVector())
b = Argument('b', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block0.next = ConditionalGoto(b, block1, block2, None)
i2 = block1.emit(Operation, 'zSomezIbzK', [a], zoptionzIbzK, '`4357', 'zz412118')
block1.next = Return(i2, None)
block2.next = Raise(StringConstant('match'), '`14234')
graph = Graph('f', [a, b], block0)
''')

def test_union_check_removal():
    zoptionzIbzK = Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    a = Argument('a', GenericBitVector())
    b = Argument('b', Bool())
    block0.next = ConditionalGoto(b, block1, block6)
    i8 = block1.emit(Operation, 'zSomezIbzK', [a], zoptionzIbzK, '`4357', 'zz412118')
    block1.next = Goto(block2, None)
    i9 = block2.emit_phi([block1, block6], [i8, None], zoptionzIbzK)
    i10 = block2.emit(UnionVariantCheck, 'zSomezIbzK', [i9], Bool(), '`4361', None)
    block2.next = ConditionalGoto(i10, block3, block5, '`4361')
    i11 = block3.emit(UnionVariantCheck, 'zNonezIbzK', [i9], Bool(), '`4365', None)
    block3.next = ConditionalGoto(i11, block4, block4, '`4365')
    block4.next = Raise(StringConstant('match'), '`14234')
    i3024 = block6.emit(Operation, 'zNonezIbzK', [UnitConstant.UNIT], zoptionzIbzK, '`4358', 'zz412109')
    i9.prevvalues[1] = i3024
    block6.next = Goto(block2, None)
    block5.next = Return(i9)
    g = Graph("f", [a, b], block0)
    remove_superfluous_union_checks(g, fakecodegen)
    compare(g, '''
zoptionzIbzK = Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))
a = Argument('a', GenericBitVector())
b = Argument('b', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block0.next = ConditionalGoto(b, block1, block6, None)
i2 = block1.emit(Operation, 'zSomezIbzK', [a], zoptionzIbzK, '`4357', 'zz412118')
block1.next = Goto(block2, None)
i3 = block2.emit_phi([block1, block6], [i2, None], zoptionzIbzK)
i4 = block2.emit(UnionVariantCheck, 'zSomezIbzK', [i3], Bool(), '`4361', None)
block2.next = ConditionalGoto(i4, block3, block5, '`4361')
block3.next = Goto(block4, None)
block4.next = Raise(StringConstant('match'), '`14234')
block5.next = Return(i3, None)
i5 = block6.emit(Operation, 'zNonezIbzK', [UnitConstant.UNIT], zoptionzIbzK, '`4358', 'zz412109')
i3.prevvalues[1] = i5
block6.next = Goto(block2, None)
graph = Graph('f', [a, b], block0)
''')

def test_union_bug():
    zoptionzIESATPModez5zK = Union('zoptionzIESATPModez5zK', ('zNonezIESATPModez5zK', 'zSomezIESATPModez5zK'), (Unit(), Enum('zSATPMode', ('zSbare', 'zSv32', 'zSv39', 'zSv48'))))
    za = Argument('za', Enum('zArchitecture', ('zRV32', 'zRV64', 'zRV128')))
    zo = Argument('zo', SmallFixedBitVector(64))
    zv = Argument('zv', SmallFixedBitVector(64))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    i3 = block0.emit(Comment, 'inlined zMk_Satp64', [], Unit(), None, None)
    i4 = block0.emit(Comment, 'inlined z_get_Satp64_Mode', [], Unit(), None, None)
    i5 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zv, MachineIntConstant(63), MachineIntConstant(60)], SmallFixedBitVector(4), '`2509', 'zz44')
    i6 = block0.emit(Operation, 'zsatp64Mode_of_bits', [za, i5], zoptionzIESATPModez5zK, '`12 760:8-760:39', 'zz41')
    i7 = block0.emit(UnionVariantCheck, 'zNonezIESATPModez5zK', [i6], Bool(), '`12 761:4-761:10', None)
    i8 = block0.emit(StructConstruction, 'zSatp64', [zv], Struct('zSatp64', ('zbits',), (SmallFixedBitVector(64),)), None, None)
    block0.next = ConditionalGoto(i7, block1, block7, '`12 761:4-761:10')
    i9 = block1.emit(UnionCast, 'zSomezIESATPModez5zK', [i6], Enum('zSATPMode', ('zSbare', 'zSv32', 'zSv39', 'zSv48')), None, None)
    i10 = block1.emit(Operation, '@eq', [EnumConstant('zSv32', Enum('zSATPMode', ('zSbare', 'zSv32', 'zSv39', 'zSv48'))), i9], Bool(), '`12 762:9-762:13', None)
    block1.next = ConditionalGoto(i10, block2, block4, '`12 762:9-762:13')
    block2.next = Goto(block3, None)
    i11 = block3.emit_phi([block7, block2, block6], [zo, zo, None], SmallFixedBitVector(64))
    block3.next = Return(i11, None)
    i12 = block4.emit(UnionVariantCheck, 'zSomezIESATPModez5zK', [i6], Bool(), '`12 763:4-763:11', None)
    block4.next = ConditionalGoto(i12, block5, block6, '`12 763:4-763:11')
    block5.next = Raise(StringConstant('match'), '`12 760:2-764:3')
    i13 = block6.emit(Comment, 'inlined z_get_Satp64_bits', [], Unit(), None, None)
    i14 = block6.emit(FieldAccess, 'zbits', [i8], SmallFixedBitVector(64), None, None)
    i15 = block6.emit(Operation, '@vector_subrange_fixed_bv_i_i', [i14, MachineIntConstant(63), MachineIntConstant(0)], SmallFixedBitVector(64), '`2487', 'zz44')
    i11.prevvalues[2] = i15
    block6.next = Goto(block3, None)
    block7.next = Goto(block3, None)
    graph = Graph('zlegalizze_satp64', [za, zo, zv], block0)
    remove_superfluous_union_checks(graph, fakecodegen)
    compare(graph, '''
zArchitecture = Enum('zArchitecture', ('zRV32', 'zRV64', 'zRV128'))
zoptionzIESATPModez5zK = Union('zoptionzIESATPModez5zK', ('zNonezIESATPModez5zK', 'zSomezIESATPModez5zK'), (Unit(), Enum('zSATPMode', ('zSbare', 'zSv32', 'zSv39', 'zSv48'))))
zSatp64 = Struct('zSatp64', ('zbits',), (SmallFixedBitVector(64),))
zSATPMode = Enum('zSATPMode', ('zSbare', 'zSv32', 'zSv39', 'zSv48'))
za = Argument('za', zArchitecture)
zo = Argument('zo', SmallFixedBitVector(64))
zv = Argument('zv', SmallFixedBitVector(64))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
i3 = block0.emit(Comment, 'inlined zMk_Satp64', [], Unit(), None, None)
i4 = block0.emit(Comment, 'inlined z_get_Satp64_Mode', [], Unit(), None, None)
i5 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zv, MachineIntConstant(63), MachineIntConstant(60)], SmallFixedBitVector(4), '`2509', 'zz44')
i6 = block0.emit(Operation, 'zsatp64Mode_of_bits', [za, i5], zoptionzIESATPModez5zK, '`12 760:8-760:39', 'zz41')
i7 = block0.emit(UnionVariantCheck, 'zNonezIESATPModez5zK', [i6], Bool(), '`12 761:4-761:10', None)
i8 = block0.emit(StructConstruction, 'zSatp64', [zv], zSatp64, None, None)
block0.next = ConditionalGoto(i7, block1, block6, '`12 761:4-761:10')
i9 = block1.emit(UnionCast, 'zSomezIESATPModez5zK', [i6], zSATPMode, None, None)
i10 = block1.emit(Operation, '@eq', [EnumConstant('zSv32', Enum('zSATPMode', ('zSbare', 'zSv32', 'zSv39', 'zSv48'))), i9], Bool(), '`12 762:9-762:13', None)
block1.next = ConditionalGoto(i10, block2, block4, '`12 762:9-762:13')
block2.next = Goto(block3, None)
i11 = block3.emit_phi([block6, block2, block5], [zo, zo, None], SmallFixedBitVector(64))
block3.next = Return(i11, None)
block4.next = Goto(block5, None)
i12 = block5.emit(Comment, 'inlined z_get_Satp64_bits', [], Unit(), None, None)
i13 = block5.emit(FieldAccess, 'zbits', [i8], SmallFixedBitVector(64), None, None)
i14 = block5.emit(Operation, '@vector_subrange_fixed_bv_i_i', [i13, MachineIntConstant(63), MachineIntConstant(0)], SmallFixedBitVector(64), '`2487', 'zz44')
i11.prevvalues[2] = i14
block5.next = Goto(block3, None)
block6.next = Goto(block3, None)
graph = Graph('zlegalizze_satp64', [za, zo, zv], block0)
''')


def test_union_cast():
    zoptionzIbzK = Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))
    block1 = Block()
    block2 = Block()
    block3 = Block()
    a = Argument('a', GenericBitVector())
    i8 = block1.emit(Operation, 'zSomezIbzK', [a], zoptionzIbzK, '`4357', 'zz412118')
    i10 = block1.emit(UnionVariantCheck, 'zSomezIbzK', [i8], Bool(), '`4361', None)
    block1.next = ConditionalGoto(i10, block2, block3)
    block2.next = Raise('match', None)
    i11 = block3.emit(UnionCast, 'zSomezIbzK', [i8], GenericBitVector())
    block3.next = Return(i11)
    g = Graph("f", [a], block1)
    check_optimize(g, '''
a = Argument('a', GenericBitVector())
block0 = Block()
block0.next = Return(a, None)
graph = Graph('f', [a], block0)
''')

def test_truncate_unwrapped_res():
    x = Argument('x', GenericBitVector())
    block0 = Block()
    i40 = block0.emit(Operation, '@sail_truncate_o_i', [x, MachineIntConstant(33)], GenericBitVector(), '`8 419:26-419:81', 'zz412')
    i41 = block0.emit(Cast, '$cast', [i40], SmallFixedBitVector(33), '`8 419:26-419:81', 'zz49')
    block0.next = Return(i41, None)
    graph = Graph('g', [x], block0)
    check_optimize(graph, """\
x = Argument('x', GenericBitVector())
block0 = Block()
i1 = block0.emit(Operation, '@truncate_unwrapped_res', [x, MachineIntConstant(33)], SmallFixedBitVector(33), '`8 419:26-419:81', 'zz412')
block0.next = Return(i1, None)
graph = Graph('g', [x], block0)
""")

def test_getcapboundsbits():
    i2 = Argument('a2', MachineInt())
    i20 = Argument('a20', MachineInt())
    i21 = Argument('a21', MachineInt())
    i23 = Argument('a23', SmallFixedBitVector(32))
    i25 = Argument('a25', SmallFixedBitVector(9))
    i33 = Argument('a33', SmallFixedBitVector(32))
    i35 = Argument('a35', SmallFixedBitVector(9))
    block4 = Block()
    i24 = block4.emit(Cast, '$cast', [i23], GenericBitVector(), None, None)
    i26 = block4.emit(Comment, 'inlined zzzeros_implicit', [], Unit(), None, None)
    i27 = block4.emit(Operation, '@zeros_i', [i2], GenericBitVector(), '`4 99:30-99:43', 'return')
    i28 = block4.emit(Cast, '$cast', [i25], GenericBitVector(), '`8 418:52-418:66', 'zz431')
    i29 = block4.emit(Operation, 'append', [i28, i27], GenericBitVector(), '`8 418:52-418:66', 'zz427')
    i30 = block4.emit(Operation, 'append', [i24, i29], GenericBitVector(), '`8 418:36-418:66', 'zz423')
    i31 = block4.emit(Operation, '@sail_truncate_o_i', [i30, MachineIntConstant(32)], GenericBitVector(), '`8 418:27-418:83', 'zz425')
    i32 = block4.emit(Cast, '$cast', [i31], SmallFixedBitVector(32), '`8 418:27-418:83', 'zz48')
    i34 = block4.emit(Cast, '$cast', [i33], GenericBitVector(), None, None)
    i36 = block4.emit(Comment, 'inlined zzzeros_implicit', [], Unit(), None, None)
    i37 = block4.emit(Cast, '$cast', [i35], GenericBitVector(), '`8 419:51-419:65', 'zz418')
    i38 = block4.emit(Operation, 'append', [i37, i27], GenericBitVector(), '`8 419:51-419:65', 'zz414')
    i39 = block4.emit(Operation, 'append', [i34, i38], GenericBitVector(), '`8 419:35-419:65', 'zz410')
    i40 = block4.emit(Operation, '@sail_truncate_o_i', [i39, MachineIntConstant(33)], GenericBitVector(), '`8 419:26-419:81', 'zz412')
    i41 = block4.emit(Cast, '$cast', [i40], SmallFixedBitVector(33), '`8 419:26-419:81', 'zz49')
    i42 = block4.emit(StructConstruction, 'ztuplez3z5bv32_z5bv33', [i32, i41], Struct('ztuplez3z5bv32_z5bv33', ('ztuplez3z5bv32_z5bv330', 'ztuplez3z5bv32_z5bv331'), (SmallFixedBitVector(32), SmallFixedBitVector(33)), True), None, None)
    block4.next = Return(i42, None)
    graph = Graph('zgetCapBoundsBits', [i2, i20, i21, i23, i25, i33, i35], block4)
    check_optimize(graph, """\
ztuplez3z5bv32_z5bv33 = Struct('ztuplez3z5bv32_z5bv33', ('ztuplez3z5bv32_z5bv330', 'ztuplez3z5bv32_z5bv331'), (SmallFixedBitVector(32), SmallFixedBitVector(33)), True)
a2 = Argument('a2', MachineInt())
a20 = Argument('a20', MachineInt())
a21 = Argument('a21', MachineInt())
a23 = Argument('a23', SmallFixedBitVector(32))
a25 = Argument('a25', SmallFixedBitVector(9))
a33 = Argument('a33', SmallFixedBitVector(32))
a35 = Argument('a35', SmallFixedBitVector(9))
block0 = Block()
i7 = block0.emit(Comment, 'inlined zzzeros_implicit', [], Unit(), None, None)
i8 = block0.emit(Operation, '@bitvector_concat_bv_bv_n_zeros_truncate', [a23, MachineIntConstant(32), a25, MachineIntConstant(9), a2, MachineIntConstant(32)], SmallFixedBitVector(32), '`8 418:36-418:66', 'zz423')
i9 = block0.emit(Comment, 'inlined zzzeros_implicit', [], Unit(), None, None)
i10 = block0.emit(Operation, '@bitvector_concat_bv_bv_n_zeros_truncate', [a33, MachineIntConstant(32), a35, MachineIntConstant(9), a2, MachineIntConstant(33)], SmallFixedBitVector(33), '`8 419:35-419:65', 'zz410')
i11 = block0.emit(StructConstruction, 'ztuplez3z5bv32_z5bv33', [i8, i10], ztuplez3z5bv32_z5bv33, None, None)
block0.next = Return(i11, None)
graph = Graph('zgetCapBoundsBits', [a2, a20, a21, a23, a25, a33, a35], block0)
""")

def test_partial_allocation_make_copy_virtual():
    capstruct = Struct('zCapability', ('zB', 'zE', 'ztag'), (SmallFixedBitVector(9), SmallFixedBitVector(5), Bool()))
    i7 = Argument('i7', capstruct)
    i49 = Argument('i49', Bool())
    block1 = Block()
    i50 = block1.emit(StructCopy, 'zCapability', [i7], capstruct, '`8 646:4-646:40', None)
    i51 = block1.emit(FieldWrite, 'ztag', [i50, i49], Unit(), '`8 646:4-646:40', None)
    i52 = block1.emit(StructCopy, 'zCapability', [i50], capstruct, '`8 646:4-646:40', None)
    block1.next = Return(i52)
    graph = Graph('zf', [i7, i49], block1)
    check_optimize(graph, """
zCapability = Struct('zCapability', ('zB', 'zE', 'ztag'), (SmallFixedBitVector(9), SmallFixedBitVector(5), Bool()))
i7 = Argument('i7', zCapability)
i49 = Argument('i49', Bool())
block0 = Block()
i2 = block0.emit(FieldAccess, 'zB', [i7], SmallFixedBitVector(9), None, None)
i3 = block0.emit(FieldAccess, 'zE', [i7], SmallFixedBitVector(5), None, None)
i4 = block0.emit(StructConstruction, 'zCapability', [i2, i3, i49], zCapability, '`8 646:4-646:40', None)
block0.next = Return(i4, None)
graph = Graph('zf', [i7, i49], block0)
""")

def test_partial_allocation_global_write():
    zCapability = Struct('zCapability', ('zB', 'zE', 'zT', 'zaccess_system_regs', 'zaddress', 'zglobal', 'zotype', 'zperm_user0', 'zpermit_execute', 'zpermit_load', 'zpermit_load_global', 'zpermit_load_mutable', 'zpermit_load_store_cap', 'zpermit_seal', 'zpermit_store', 'zpermit_store_local_cap', 'zpermit_unseal', 'zreserved', 'ztag'), (SmallFixedBitVector(9), SmallFixedBitVector(5), SmallFixedBitVector(9), Bool(), SmallFixedBitVector(32), Bool(), SmallFixedBitVector(4), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), SmallFixedBitVector(1), Bool()))
    zexception = Union('zexception', ('zError_internal_error', 'zError_not_implemented', 'zError_not_rv32e_register'), (Unit(), String(), Unit()))
    zr = Argument('zr', MachineInt())
    zin_v = Argument('zin_v', SmallFixedBitVector(32))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    i2 = block0.emit(Comment, 'inlined zregval_into_reg', [], Unit(), None, None)
    i3 = block0.emit(Operation, 'int64_to_int', [zr], Int(), '`701', 'zz478')
    i4 = block0.emit(Operation, '@eq', [zr, MachineIntConstant(0)], Bool(), '`702', 'zz477')
    i5 = block0.emit(StructConstruction, 'zCapability', [SmallBitVectorConstant(0b0, SmallFixedBitVector(9)), SmallBitVectorConstant(0b0, SmallFixedBitVector(5)), SmallBitVectorConstant(0b0, SmallFixedBitVector(9)), BooleanConstant.FALSE, zin_v, BooleanConstant.FALSE, SmallBitVectorConstant(0x0, SmallFixedBitVector(4)), BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.FALSE, SmallBitVectorConstant(0b0, SmallFixedBitVector(1)), BooleanConstant.FALSE], zCapability, '`13 82:30-82:57', None)
    block0.next = ConditionalGoto(i4, block1, block5, '`16 75:2-93:3')
    i6 = block1.emit(Comment, 'inlined zneq_int', [], Unit(), None, None)
    block1.next = ConditionalGoto(i4, block2, block3, '`16 94:2-98:3')
    block2.next = Return(UnitConstant.UNIT, None)
    i7 = block3.emit(Comment, 'inlined zrvfi_wX', [], Unit(), None, None)
    i8 = block3.emit(Operation, 'get_config_print_reg', [UnitConstant.UNIT], Bool(), '`16 96:10-96:32', 'zz42')
    block3.next = ConditionalGoto(i8, block4, block2, '`16 96:5-97:58')
    i9 = block4.emit(Operation, 'dec_str', [i3], String(), '`16 97:26-97:36', 'zz45')
    i10 = block4.emit(Comment, 'inlined zRegStr', [], Unit(), None, None)
    i11 = block4.emit(Operation, 'zcapToString', [i5], String(), '`13 74:21-74:35', 'return')
    i12 = block4.emit(Operation, 'concat_str', [StringConstant(' <- '), i11], String(), '`16 97:39-97:57', 'zz46')
    i13 = block4.emit(Operation, 'concat_str', [i9, i12], String(), '`16 97:26-97:57', 'zz44')
    i14 = block4.emit(Operation, 'concat_str', [StringConstant('x'), i13], String(), '`16 97:20-97:57', 'zz43')
    i15 = block4.emit(Operation, 'print_reg', [i14], Unit(), '`16 97:10-97:58', 'return')
    block4.next = Goto(block2, None)
    i16 = block5.emit(Operation, '@eq', [zr, MachineIntConstant(1)], Bool(), '`707', 'zz473')
    block5.next = Goto(block6)
    i17 = block6.emit(FieldAccess, 'zB', [i5], SmallFixedBitVector(9), None, None)
    i18 = block6.emit(FieldAccess, 'zE', [i5], SmallFixedBitVector(5), None, None)
    i19 = block6.emit(FieldAccess, 'zT', [i5], SmallFixedBitVector(9), None, None)
    i20 = block6.emit(FieldAccess, 'zaccess_system_regs', [i5], Bool(), None, None)
    i21 = block6.emit(FieldAccess, 'zaddress', [i5], SmallFixedBitVector(32), None, None)
    i22 = block6.emit(FieldAccess, 'zglobal', [i5], Bool(), None, None)
    i23 = block6.emit(FieldAccess, 'zotype', [i5], SmallFixedBitVector(4), None, None)
    i24 = block6.emit(FieldAccess, 'zperm_user0', [i5], Bool(), None, None)
    i25 = block6.emit(FieldAccess, 'zpermit_execute', [i5], Bool(), None, None)
    i26 = block6.emit(FieldAccess, 'zpermit_load', [i5], Bool(), None, None)
    i27 = block6.emit(FieldAccess, 'zpermit_load_global', [i5], Bool(), None, None)
    i28 = block6.emit(FieldAccess, 'zpermit_load_mutable', [i5], Bool(), None, None)
    i29 = block6.emit(FieldAccess, 'zpermit_load_store_cap', [i5], Bool(), None, None)
    i30 = block6.emit(FieldAccess, 'zpermit_seal', [i5], Bool(), None, None)
    i31 = block6.emit(FieldAccess, 'zpermit_store', [i5], Bool(), None, None)
    i32 = block6.emit(FieldAccess, 'zpermit_store_local_cap', [i5], Bool(), None, None)
    i33 = block6.emit(FieldAccess, 'zpermit_unseal', [i5], Bool(), None, None)
    i34 = block6.emit(FieldAccess, 'zreserved', [i5], SmallFixedBitVector(1), None, None)
    i35 = block6.emit(FieldAccess, 'ztag', [i5], Bool(), None, None)
    i36 = block6.emit(StructConstruction, 'zCapability', [i17, i18, i19, i20, i21, i22, i23, i24, i25, i26, i27, i28, i29, i30, i31, i32, i33, i34, i35], zCapability, '`16 77:15-77:16', None)
    i37 = block6.emit(GlobalWrite, 'zx1', [i36], zCapability, None, None)
    block6.next = Return(UnitConstant.UNIT, None)
    graph = Graph('zwX', [zr, zin_v], block0)
    fakecodegen = FakeCodeGen()
    fakecodegen.all_registers = {'zx1': 1}
    check_optimize(graph, """
zCapability = Struct('zCapability', ('zB', 'zE', 'zT', 'zaccess_system_regs', 'zaddress', 'zglobal', 'zotype', 'zperm_user0', 'zpermit_execute', 'zpermit_load', 'zpermit_load_global', 'zpermit_load_mutable', 'zpermit_load_store_cap', 'zpermit_seal', 'zpermit_store', 'zpermit_store_local_cap', 'zpermit_unseal', 'zreserved', 'ztag'), (SmallFixedBitVector(9), SmallFixedBitVector(5), SmallFixedBitVector(9), Bool(), SmallFixedBitVector(32), Bool(), SmallFixedBitVector(4), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), Bool(), SmallFixedBitVector(1), Bool()))
zr = Argument('zr', MachineInt())
zin_v = Argument('zin_v', SmallFixedBitVector(32))
block0 = Block()
block1 = Block()
block2 = Block()
i2 = block0.emit(Comment, 'inlined zregval_into_reg', [], Unit(), None, None)
i3 = block0.emit(Operation, '@eq', [zr, MachineIntConstant(0)], Bool(), '`702', 'zz477')
block0.next = ConditionalGoto(i3, block1, block2, '`16 75:2-93:3')
i4 = block1.emit(Comment, 'inlined zneq_int', [], Unit(), None, None)
block1.next = Return(UnitConstant.UNIT, None)
i5 = block2.emit(GlobalRead, 'zx1', [], zCapability, None, None)
i6 = block2.emit(FieldWrite, 'zB', [i5, SmallBitVectorConstant(0b0, SmallFixedBitVector(9))], Unit(), None, None)
i7 = block2.emit(FieldWrite, 'zE', [i5, SmallBitVectorConstant(0b0, SmallFixedBitVector(5))], Unit(), None, None)
i8 = block2.emit(FieldWrite, 'zT', [i5, SmallBitVectorConstant(0b0, SmallFixedBitVector(9))], Unit(), None, None)
i9 = block2.emit(FieldWrite, 'zaccess_system_regs', [i5, BooleanConstant.FALSE], Unit(), None, None)
i10 = block2.emit(FieldWrite, 'zaddress', [i5, zin_v], Unit(), None, None)
i11 = block2.emit(FieldWrite, 'zglobal', [i5, BooleanConstant.FALSE], Unit(), None, None)
i12 = block2.emit(FieldWrite, 'zotype', [i5, SmallBitVectorConstant(0x0, SmallFixedBitVector(4))], Unit(), None, None)
i13 = block2.emit(FieldWrite, 'zperm_user0', [i5, BooleanConstant.FALSE], Unit(), None, None)
i14 = block2.emit(FieldWrite, 'zpermit_execute', [i5, BooleanConstant.FALSE], Unit(), None, None)
i15 = block2.emit(FieldWrite, 'zpermit_load', [i5, BooleanConstant.FALSE], Unit(), None, None)
i16 = block2.emit(FieldWrite, 'zpermit_load_global', [i5, BooleanConstant.FALSE], Unit(), None, None)
i17 = block2.emit(FieldWrite, 'zpermit_load_mutable', [i5, BooleanConstant.FALSE], Unit(), None, None)
i18 = block2.emit(FieldWrite, 'zpermit_load_store_cap', [i5, BooleanConstant.FALSE], Unit(), None, None)
i19 = block2.emit(FieldWrite, 'zpermit_seal', [i5, BooleanConstant.FALSE], Unit(), None, None)
i20 = block2.emit(FieldWrite, 'zpermit_store', [i5, BooleanConstant.FALSE], Unit(), None, None)
i21 = block2.emit(FieldWrite, 'zpermit_store_local_cap', [i5, BooleanConstant.FALSE], Unit(), None, None)
i22 = block2.emit(FieldWrite, 'zpermit_unseal', [i5, BooleanConstant.FALSE], Unit(), None, None)
i23 = block2.emit(FieldWrite, 'zreserved', [i5, SmallBitVectorConstant(0b0, SmallFixedBitVector(1))], Unit(), None, None)
i24 = block2.emit(FieldWrite, 'ztag', [i5, BooleanConstant.FALSE], Unit(), None, None)
block2.next = Return(UnitConstant.UNIT, None)
graph = Graph('zwX', [zr, zin_v], block0)
""", fakecodegen=fakecodegen)

def test_unsigned_comparison():
    block17 = Block()
    i8 = Argument('i8', SmallFixedBitVector(64))
    i11 = Argument('i11', SmallFixedBitVector(64))
    i65 = block17.emit(Operation, '@unsigned_bv_wrapped_res', [i8, MachineIntConstant(64)], Int(), '`5 143:32-143:43', 'zz40')
    i66 = block17.emit(Operation, '@unsigned_bv_wrapped_res', [i11, MachineIntConstant(64)], Int(), '`5 143:46-143:57', 'zz41')
    i67 = block17.emit(Operation, 'lt', [i65, i66], Bool(), '`5 143:32-143:57', 'return')
    block17.next = Return(i67)
    graph = Graph('zexecute_zBTYPE', [i8, i11], block17)
    check_optimize(graph, '''
i8 = Argument('i8', SmallFixedBitVector(64))
i11 = Argument('i11', SmallFixedBitVector(64))
block0 = Block()
i2 = block0.emit(Operation, '@lt_unsigned64', [i8, i11], Bool(), '`5 143:32-143:57', 'return')
block0.next = Return(i2, None)
graph = Graph('zexecute_zBTYPE', [i8, i11], block0)
''')

def test_monomorphize():
    zpa = Argument('zpa', GenericBitVector())
    block0 = Block()
    i0 = block0.emit(Operation, 'monomorphize', [zpa], GenericBitVector(), '`10 243:47-243:65', 'zz442')
    i1 = block0.emit(Operation, 'branch_announce', [MachineIntConstant(64), zpa], Unit(), '`18 25:2-25:32', 'zz40')
    block0.next = Return(i0)
    graph = Graph('mono', [zpa], block0)
    check_optimize(graph, '''
zpa = Argument('zpa', GenericBitVector())
block0 = Block()
block0.next = Return(zpa, None)
graph = Graph('mono', [zpa], block0)
''')

def test_unpack_better():
    zread_kind = Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))
    zExplicit_access_kind = Struct('zExplicit_access_kind', ('zstrength', 'zvariety'), (Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc')), Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw'))))
    zAccess_kindzIRRISCV_strong_accesszK = Union('zAccess_kindzIRRISCV_strong_accesszK', ('zAK_archzIRRISCV_strong_accesszK', 'zAK_explicitzIRRISCV_strong_accesszK', 'zAK_ifetchzIRRISCV_strong_accesszK', 'zAK_ttwzIRRISCV_strong_accesszK'), (Struct('zRISCV_strong_access', ('zvariety',), (Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')),)), Struct('zExplicit_access_kind', ('zstrength', 'zvariety'), (Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc')), Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))), Unit(), Unit()))
    zoptionzIbzK = Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))
    zoptionzIozK = Union('zoptionzIozK', ('zNonezIozK', 'zSomezIozK'), (Unit(), Bool()))
    zMem_read_requestzIRRISCV_strong_accesszCbzCuzK = Struct('zMem_read_requestzIRRISCV_strong_accesszCbzCuzK', ('zaccess_kind', 'zpa', 'zsizze', 'ztag', 'ztranslation', 'zva'), (Union('zAccess_kindzIRRISCV_strong_accesszK', ('zAK_archzIRRISCV_strong_accesszK', 'zAK_explicitzIRRISCV_strong_accesszK', 'zAK_ifetchzIRRISCV_strong_accesszK', 'zAK_ttwzIRRISCV_strong_accesszK'), (Struct('zRISCV_strong_access', ('zvariety',), (Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')),)), Struct('zExplicit_access_kind', ('zstrength', 'zvariety'), (Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc')), Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))), Unit(), Unit())), GenericBitVector(), Int(), Bool(), Unit(), Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))))
    ztuplez3z5bv_z5unionz0zzoptionzzIozzK = Struct('ztuplez3z5bv_z5unionz0zzoptionzzIozzK', ('ztuplez3z5bv_z5unionz0zzoptionzzIozzK0', 'ztuplez3z5bv_z5unionz0zzoptionzzIozzK1'), (GenericBitVector(), Union('zoptionzIozK', ('zNonezIozK', 'zSomezIozK'), (Unit(), Bool()))), True)
    zresultzIz8bzCUoptionzIozKzIzKz9zCuzK = Union('zresultzIz8bzCUoptionzIozKzIzKz9zCuzK', ('zErrzIz8bzCUoptionzIozKzIzKz9zCuzK', 'zOkzIz8bzCUoptionzIozKzIzKz9zCuzK'), (Unit(), Struct('ztuplez3z5bv_z5unionz0zzoptionzzIozzK', ('ztuplez3z5bv_z5unionz0zzoptionzzIozzK0', 'ztuplez3z5bv_z5unionz0zzoptionzzIozzK1'), (GenericBitVector(), Union('zoptionzIozK', ('zNonezIozK', 'zSomezIozK'), (Unit(), Bool()))), True)))
    ztuplez3z5bv_z5unit = Struct('ztuplez3z5bv_z5unit', ('ztuplez3z5bv_z5unit0', 'ztuplez3z5bv_z5unit1'), (GenericBitVector(), Unit()), True)
    zAccess_variety = Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw'))
    zRISCV_strong_access = Struct('zRISCV_strong_access', ('zvariety',), (Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')),))
    zrk = Argument('zrk', zread_kind)
    zaddr = Argument('zaddr', SmallFixedBitVector(64))
    zwidth = Argument('zwidth', MachineInt())
    zread_meta = Argument('zread_meta', Bool())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    block9 = Block()
    block10 = Block()
    block11 = Block()
    block12 = Block()
    block13 = Block()
    block14 = Block()
    block15 = Block()
    block16 = Block()
    block17 = Block()
    block18 = Block()
    block19 = Block()
    block20 = Block()
    block21 = Block()
    block22 = Block()
    block23 = Block()
    i4 = block0.emit(Operation, '@eq', [EnumConstant('zRead_plain', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 139:6-139:16', None)
    block0.next = ConditionalGoto(i4, block1, block13, '`11 139:6-139:16')
    i5 = block1.emit(StructConstruction, 'zExplicit_access_kind', [EnumConstant('zAS_normal', Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc'))), EnumConstant('zAV_plain', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zExplicit_access_kind, None, None)
    i6 = block1.emit(Operation, 'zAK_explicitzIRRISCV_strong_accesszK', [i5], zAccess_kindzIRRISCV_strong_accesszK, '`11 139:20-139:84', 'zz47')
    block1.next = Goto(block2, None)
    i7 = block2.emit_phi([block1, block14, block16, block18, block20, block22, block23], [BooleanConstant.TRUE, BooleanConstant.FALSE, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE], Bool())
    i8 = block2.emit_phi([block1, block14, block16, block18, block20, block22, block23], [BooleanConstant.FALSE, BooleanConstant.TRUE, BooleanConstant.FALSE, BooleanConstant.TRUE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
    i9 = block2.emit_phi([block1, block14, block16, block18, block20, block22, block23], [i6, None, None, None, None, None, None], zAccess_kindzIRRISCV_strong_accesszK)
    i10 = block2.emit(Operation, 'zNonezIbzK', [UnitConstant.UNIT], zoptionzIbzK, '`11 147:9-147:15', 'zz46')
    i11 = block2.emit(Operation, '@pack_smallfixedbitvector', [MachineIntConstant(64), zaddr], Packed(GenericBitVector()), None, None)
    i12 = block2.emit(Operation, '@pack_machineint', [MachineIntConstant(2)], Packed(Int()), None, None)
    i13 = block2.emit(Comment, 'inlined zsail_mem_read', [], Unit(), None, None)
    i14 = block2.emit(Comment, 'inlined zxlenbits_identity', [], Unit(), None, None)
    i15 = block2.emit(Comment, 'inlined zmem_read_request_is_ifetchzIRRISCV_strong_accesszCbzCuzK', [], Unit(), None, None)
    i16 = block2.emit(Operation, 'zNonezIozK', [UnitConstant.UNIT], zoptionzIozK, '`10 179:12-179:18', 'zz42')
    i17 = block2.emit(Comment, 'inlined zmem_read_request_is_exclusivezIRRISCV_strong_accesszCbzCuzK', [], Unit(), None, None)
    i18 = block2.emit(StructConstruction, 'zMem_read_requestzIRRISCV_strong_accesszCbzCuzK', [i9, i11, i12, BooleanConstant.FALSE, UnitConstant.UNIT, i10], zMem_read_requestzIRRISCV_strong_accesszCbzCuzK, '`11 137:80-152:3', None)
    block2.next = ConditionalGoto(i8, block3, block11, '`10 127:8-127:24')
    i19 = block3.emit(Comment, 'inlined zmem_read_request_is_ifetchzIRRISCV_strong_accesszCbzCuzK', [], Unit(), None, None)
    block3.next = ConditionalGoto(i7, block4, block10, '`10 140:8-140:19')
    i20 = block4.emit(Operation, '@fast_read_mem_i_bv_i_isfetch', [MachineIntConstant(64), zaddr, MachineIntConstant(2), BooleanConstant.FALSE], SmallFixedBitVector(16), '`10 197:20-197:60', 'zz431')
    i21 = block4.emit(Operation, '@pack_smallfixedbitvector', [MachineIntConstant(16), i20], Packed(GenericBitVector()), None, None)
    i22 = block4.emit(StructConstruction, 'ztuplez3z5bv_z5unionz0zzoptionzzIozzK', [i21, i16], ztuplez3z5bv_z5unionz0zzoptionzzIozzK, None, None)
    i23 = block4.emit(Operation, 'zOkzIz8bzCUoptionzIozKzIzKz9zCuzK', [i22], zresultzIz8bzCUoptionzIozKzIzKz9zCuzK, '`10 197:16-197:67', 'return')
    block4.next = Goto(block5, None)
    i24 = block5.emit_phi([block4, block10], [i23, None], zresultzIz8bzCUoptionzIozKzIzKz9zCuzK)
    block5.next = Goto(block6, None)
    i25 = block6.emit_phi([block5, block12], [i24, None], zresultzIz8bzCUoptionzIozKzIzKz9zCuzK)
    i26 = block6.emit(UnionVariantCheck, 'zOkzIz8bzCUoptionzIozKzIzKz9zCuzK', [i25], Bool(), '`11 154:4-154:18', None)
    i27 = block6.emit(Allocate, '$allocate', [], ztuplez3z5bv_z5unit, '`11 153:2-156:3', None)
    block6.next = ConditionalGoto(i26, block7, block9, '`11 154:4-154:18')
    block7.next = Goto(block8, None)
    i28 = block8.emit_phi([block9, block7], [None, i27], ztuplez3z5bv_z5unit)
    block8.next = Return(i28, None)
    i29 = block9.emit(UnionCast, 'zOkzIz8bzCUoptionzIozKzIzKz9zCuzK', [i25], ztuplez3z5bv_z5unionz0zzoptionzzIozzK, None, None)
    i30 = block9.emit(FieldAccess, 'ztuplez3z5bv_z5unionz0zzoptionzzIozzK0', [i29], Packed(GenericBitVector()), None, None)
    i31 = block9.emit(StructConstruction, 'ztuplez3z5bv_z5unit', [i30, UnitConstant.UNIT], ztuplez3z5bv_z5unit, None, None)
    i28.prevvalues[0] = i31
    block9.next = Goto(block8, None)
    i32 = block10.emit(Operation, '@fast_read_mem_i_bv_i_isfetch', [MachineIntConstant(64), zaddr, MachineIntConstant(2), BooleanConstant.TRUE], SmallFixedBitVector(16), '`10 191:20-191:67', 'zz419')
    i33 = block10.emit(Operation, '@pack_smallfixedbitvector', [MachineIntConstant(16), i32], Packed(GenericBitVector()), None, None)
    i34 = block10.emit(StructConstruction, 'ztuplez3z5bv_z5unionz0zzoptionzzIozzK', [i33, i16], ztuplez3z5bv_z5unionz0zzoptionzzIozzK, None, None)
    i35 = block10.emit(Operation, 'zOkzIz8bzCUoptionzIozKzIzKz9zCuzK', [i34], zresultzIz8bzCUoptionzIozKzIzKz9zCuzK, '`10 191:16-191:74', 'return')
    i24.prevvalues[1] = i35
    block10.next = Goto(block5, None)
    i36 = block11.emit(UnionCast, 'zAK_explicitzIRRISCV_strong_accesszK', [i9], zExplicit_access_kind, None, None)
    i37 = block11.emit(FieldAccess, 'zvariety', [i36], zAccess_variety, None, None)
    i38 = block11.emit(Operation, '@eq', [EnumConstant('zAV_exclusive', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw'))), i37], Bool(), '`10 128:12-128:24', None)
    block11.next = ConditionalGoto(i38, block12, block3, '`10 128:12-128:24')
    i39 = block12.emit(Cast, '$cast', [zaddr], GenericBitVector(), '`10 185:20-185:70', 'zz410')
    i40 = block12.emit(Operation, '@read_mem_exclusive_o_o_o_i', [i18, MachineIntConstant(64), i39, MachineIntConstant(2)], GenericBitVector(), '`10 185:20-185:70', 'zz46')
    i41 = block12.emit(PackPackedField, '$pack', [i40], Packed(GenericBitVector()), None, None)
    i42 = block12.emit(StructConstruction, 'ztuplez3z5bv_z5unionz0zzoptionzzIozzK', [i41, i16], ztuplez3z5bv_z5unionz0zzoptionzzIozzK, None, None)
    i43 = block12.emit(Operation, 'zOkzIz8bzCUoptionzIozKzIzKz9zCuzK', [i42], zresultzIz8bzCUoptionzIozKzIzKz9zCuzK, '`10 185:16-185:77', 'return')
    i25.prevvalues[1] = i43
    block12.next = Goto(block6, None)
    i44 = block13.emit(Operation, '@eq', [EnumConstant('zRead_ifetch', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 140:6-140:17', None)
    block13.next = ConditionalGoto(i44, block14, block15, '`11 140:6-140:17')
    i45 = block14.emit(Operation, 'zAK_ifetchzIRRISCV_strong_accesszK', [UnitConstant.UNIT], zAccess_kindzIRRISCV_strong_accesszK, '`11 140:21-140:32', 'zz47')
    i9.prevvalues[1] = i45
    block14.next = Goto(block2, None)
    i46 = block15.emit(Operation, '@eq', [EnumConstant('zRead_RISCV_acquire', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 141:6-141:24', None)
    block15.next = ConditionalGoto(i46, block16, block17, '`11 141:6-141:24')
    i47 = block16.emit(StructConstruction, 'zExplicit_access_kind', [EnumConstant('zAS_rel_or_acq', Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc'))), EnumConstant('zAV_plain', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zExplicit_access_kind, None, None)
    i48 = block16.emit(Operation, 'zAK_explicitzIRRISCV_strong_accesszK', [i47], zAccess_kindzIRRISCV_strong_accesszK, '`11 141:28-141:96', 'zz47')
    i9.prevvalues[2] = i48
    block16.next = Goto(block2, None)
    i49 = block17.emit(Operation, '@eq', [EnumConstant('zRead_RISCV_strong_acquire', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 142:6-142:31', None)
    block17.next = ConditionalGoto(i49, block18, block19, '`11 142:6-142:31')
    i50 = block18.emit(StructConstruction, 'zRISCV_strong_access', [EnumConstant('zAV_plain', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zRISCV_strong_access, None, None)
    i51 = block18.emit(Operation, 'zAK_archzIRRISCV_strong_accesszK', [i50], zAccess_kindzIRRISCV_strong_accesszK, '`11 142:35-142:73', 'zz47')
    i9.prevvalues[3] = i51
    block18.next = Goto(block2, None)
    i52 = block19.emit(Operation, '@eq', [EnumConstant('zRead_RISCV_reserved', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 143:6-143:25', None)
    block19.next = ConditionalGoto(i52, block20, block21, '`11 143:6-143:25')
    i53 = block20.emit(StructConstruction, 'zExplicit_access_kind', [EnumConstant('zAS_normal', Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc'))), EnumConstant('zAV_exclusive', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zExplicit_access_kind, None, None)
    i54 = block20.emit(Operation, 'zAK_explicitzIRRISCV_strong_accesszK', [i53], zAccess_kindzIRRISCV_strong_accesszK, '`11 143:29-143:97', 'zz47')
    i9.prevvalues[4] = i54
    block20.next = Goto(block2, None)
    i55 = block21.emit(Operation, '@eq', [EnumConstant('zRead_RISCV_reserved_acquire', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 144:6-144:33', None)
    block21.next = ConditionalGoto(i55, block22, block23, '`11 144:6-144:33')
    i56 = block22.emit(StructConstruction, 'zExplicit_access_kind', [EnumConstant('zAS_rel_or_acq', Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc'))), EnumConstant('zAV_exclusive', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zExplicit_access_kind, None, None)
    i57 = block22.emit(Operation, 'zAK_explicitzIRRISCV_strong_accesszK', [i56], zAccess_kindzIRRISCV_strong_accesszK, '`11 144:37-144:109', 'zz47')
    i9.prevvalues[5] = i57
    block22.next = Goto(block2, None)
    i58 = block23.emit(StructConstruction, 'zRISCV_strong_access', [EnumConstant('zAV_exclusive', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zRISCV_strong_access, None, None)
    i59 = block23.emit(Operation, 'zAK_archzIRRISCV_strong_accesszK', [i58], zAccess_kindzIRRISCV_strong_accesszK, '`11 145:44-145:86', 'zz47')
    i9.prevvalues[6] = i59
    block23.next = Goto(block2, None)
    graph = Graph('zread_ram_specialized_o_o_2_False', [zrk, zaddr, zwidth, zread_meta], block0)
    graph.check()
    check_optimize(graph, """
zread_kind = Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))
zExplicit_access_kind = Struct('zExplicit_access_kind', ('zstrength', 'zvariety'), (Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc')), Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw'))))
zAccess_kindzIRRISCV_strong_accesszK = Union('zAccess_kindzIRRISCV_strong_accesszK', ('zAK_archzIRRISCV_strong_accesszK', 'zAK_explicitzIRRISCV_strong_accesszK', 'zAK_ifetchzIRRISCV_strong_accesszK', 'zAK_ttwzIRRISCV_strong_accesszK'), (Struct('zRISCV_strong_access', ('zvariety',), (Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')),)), Struct('zExplicit_access_kind', ('zstrength', 'zvariety'), (Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc')), Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))), Unit(), Unit()))
zoptionzIbzK = Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))
zMem_read_requestzIRRISCV_strong_accesszCbzCuzK = Struct('zMem_read_requestzIRRISCV_strong_accesszCbzCuzK', ('zaccess_kind', 'zpa', 'zsizze', 'ztag', 'ztranslation', 'zva'), (Union('zAccess_kindzIRRISCV_strong_accesszK', ('zAK_archzIRRISCV_strong_accesszK', 'zAK_explicitzIRRISCV_strong_accesszK', 'zAK_ifetchzIRRISCV_strong_accesszK', 'zAK_ttwzIRRISCV_strong_accesszK'), (Struct('zRISCV_strong_access', ('zvariety',), (Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')),)), Struct('zExplicit_access_kind', ('zstrength', 'zvariety'), (Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc')), Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))), Unit(), Unit())), GenericBitVector(), Int(), Bool(), Unit(), Union('zoptionzIbzK', ('zNonezIbzK', 'zSomezIbzK'), (Unit(), GenericBitVector()))))
ztuplez3z5bv_z5unit = Struct('ztuplez3z5bv_z5unit', ('ztuplez3z5bv_z5unit0', 'ztuplez3z5bv_z5unit1'), (GenericBitVector(), Unit()), True)
zAccess_variety = Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw'))
zRISCV_strong_access = Struct('zRISCV_strong_access', ('zvariety',), (Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')),))
zrk = Argument('zrk', zread_kind)
zaddr = Argument('zaddr', SmallFixedBitVector(64))
zwidth = Argument('zwidth', MachineInt())
zread_meta = Argument('zread_meta', Bool())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
block8 = Block()
block9 = Block()
block10 = Block()
block11 = Block()
block12 = Block()
block13 = Block()
block14 = Block()
block15 = Block()
block16 = Block()
block17 = Block()
block18 = Block()
block19 = Block()
i4 = block0.emit(Operation, '@eq', [EnumConstant('zRead_plain', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 139:6-139:16', None)
block0.next = ConditionalGoto(i4, block1, block9, '`11 139:6-139:16')
i5 = block1.emit(StructConstruction, 'zExplicit_access_kind', [EnumConstant('zAS_normal', Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc'))), EnumConstant('zAV_plain', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zExplicit_access_kind, None, None)
i6 = block1.emit(Operation, 'zAK_explicitzIRRISCV_strong_accesszK', [i5], zAccess_kindzIRRISCV_strong_accesszK, '`11 139:20-139:84', 'zz47')
block1.next = Goto(block2, None)
i7 = block2.emit_phi([block1, block10, block12, block14, block16, block18, block19], [BooleanConstant.TRUE, BooleanConstant.FALSE, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE, BooleanConstant.TRUE], Bool())
i8 = block2.emit_phi([block1, block10, block12, block14, block16, block18, block19], [BooleanConstant.FALSE, BooleanConstant.TRUE, BooleanConstant.FALSE, BooleanConstant.TRUE, BooleanConstant.FALSE, BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
i9 = block2.emit_phi([block1, block10, block12, block14, block16, block18, block19], [i6, None, None, None, None, None, None], zAccess_kindzIRRISCV_strong_accesszK)
i10 = block2.emit(Operation, 'zNonezIbzK', [UnitConstant.UNIT], zoptionzIbzK, '`11 147:9-147:15', 'zz46')
i11 = block2.emit(Operation, '@pack_smallfixedbitvector', [MachineIntConstant(64), zaddr], Packed(GenericBitVector()), None, None)
i12 = block2.emit(Operation, '@pack_machineint', [MachineIntConstant(2)], Packed(Int()), None, None)
i13 = block2.emit(Comment, 'inlined zsail_mem_read', [], Unit(), None, None)
i14 = block2.emit(Comment, 'inlined zxlenbits_identity', [], Unit(), None, None)
i15 = block2.emit(Comment, 'inlined zmem_read_request_is_ifetchzIRRISCV_strong_accesszCbzCuzK', [], Unit(), None, None)
i16 = block2.emit(Comment, 'inlined zmem_read_request_is_exclusivezIRRISCV_strong_accesszCbzCuzK', [], Unit(), None, None)
i17 = block2.emit(StructConstruction, 'zMem_read_requestzIRRISCV_strong_accesszCbzCuzK', [i9, i11, i12, BooleanConstant.FALSE, UnitConstant.UNIT, i10], zMem_read_requestzIRRISCV_strong_accesszCbzCuzK, '`11 137:80-152:3', None)
block2.next = ConditionalGoto(i8, block3, block7, '`10 127:8-127:24')
i18 = block3.emit(Comment, 'inlined zmem_read_request_is_ifetchzIRRISCV_strong_accesszCbzCuzK', [], Unit(), None, None)
block3.next = ConditionalGoto(i7, block4, block6, '`10 140:8-140:19')
i19 = block4.emit(Operation, '@fast_read_mem_i_bv_i_isfetch', [MachineIntConstant(64), zaddr, MachineIntConstant(2), BooleanConstant.FALSE], SmallFixedBitVector(16), '`10 197:20-197:60', 'zz431')
i20 = block4.emit(Operation, '@pack_smallfixedbitvector', [MachineIntConstant(16), i19], Packed(GenericBitVector()), None, None)
block4.next = Goto(block5, None)
i21 = block5.emit_phi([block4, block6, block8], [i20, None, None], Packed(GenericBitVector()))
i22 = block5.emit(StructConstruction, 'ztuplez3z5bv_z5unit', [i21, UnitConstant.UNIT], ztuplez3z5bv_z5unit, None, None)
block5.next = Return(i22, None)
i23 = block6.emit(Operation, '@fast_read_mem_i_bv_i_isfetch', [MachineIntConstant(64), zaddr, MachineIntConstant(2), BooleanConstant.TRUE], SmallFixedBitVector(16), '`10 191:20-191:67', 'zz419')
i24 = block6.emit(Operation, '@pack_smallfixedbitvector', [MachineIntConstant(16), i23], Packed(GenericBitVector()), None, None)
i21.prevvalues[1] = i24
block6.next = Goto(block5, None)
i25 = block7.emit(UnionCast, 'zAK_explicitzIRRISCV_strong_accesszK', [i9], zExplicit_access_kind, None, None)
i26 = block7.emit(FieldAccess, 'zvariety', [i25], zAccess_variety, None, None)
i27 = block7.emit(Operation, '@eq', [EnumConstant('zAV_exclusive', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw'))), i26], Bool(), '`10 128:12-128:24', None)
block7.next = ConditionalGoto(i27, block8, block3, '`10 128:12-128:24')
i28 = block8.emit(Cast, '$cast', [zaddr], GenericBitVector(), '`10 185:20-185:70', 'zz410')
i29 = block8.emit(Operation, '@read_mem_exclusive_o_o_o_i', [i17, MachineIntConstant(64), i28, MachineIntConstant(2)], GenericBitVector(), '`10 185:20-185:70', 'zz46')
i30 = block8.emit(PackPackedField, '$pack', [i29], Packed(GenericBitVector()), None, None)
i21.prevvalues[2] = i30
block8.next = Goto(block5, None)
i31 = block9.emit(Operation, '@eq', [EnumConstant('zRead_ifetch', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 140:6-140:17', None)
block9.next = ConditionalGoto(i31, block10, block11, '`11 140:6-140:17')
i32 = block10.emit(Operation, 'zAK_ifetchzIRRISCV_strong_accesszK', [UnitConstant.UNIT], zAccess_kindzIRRISCV_strong_accesszK, '`11 140:21-140:32', 'zz47')
i9.prevvalues[1] = i32
block10.next = Goto(block2, None)
i33 = block11.emit(Operation, '@eq', [EnumConstant('zRead_RISCV_acquire', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 141:6-141:24', None)
block11.next = ConditionalGoto(i33, block12, block13, '`11 141:6-141:24')
i34 = block12.emit(StructConstruction, 'zExplicit_access_kind', [EnumConstant('zAS_rel_or_acq', Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc'))), EnumConstant('zAV_plain', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zExplicit_access_kind, None, None)
i35 = block12.emit(Operation, 'zAK_explicitzIRRISCV_strong_accesszK', [i34], zAccess_kindzIRRISCV_strong_accesszK, '`11 141:28-141:96', 'zz47')
i9.prevvalues[2] = i35
block12.next = Goto(block2, None)
i36 = block13.emit(Operation, '@eq', [EnumConstant('zRead_RISCV_strong_acquire', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 142:6-142:31', None)
block13.next = ConditionalGoto(i36, block14, block15, '`11 142:6-142:31')
i37 = block14.emit(StructConstruction, 'zRISCV_strong_access', [EnumConstant('zAV_plain', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zRISCV_strong_access, None, None)
i38 = block14.emit(Operation, 'zAK_archzIRRISCV_strong_accesszK', [i37], zAccess_kindzIRRISCV_strong_accesszK, '`11 142:35-142:73', 'zz47')
i9.prevvalues[3] = i38
block14.next = Goto(block2, None)
i39 = block15.emit(Operation, '@eq', [EnumConstant('zRead_RISCV_reserved', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 143:6-143:25', None)
block15.next = ConditionalGoto(i39, block16, block17, '`11 143:6-143:25')
i40 = block16.emit(StructConstruction, 'zExplicit_access_kind', [EnumConstant('zAS_normal', Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc'))), EnumConstant('zAV_exclusive', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zExplicit_access_kind, None, None)
i41 = block16.emit(Operation, 'zAK_explicitzIRRISCV_strong_accesszK', [i40], zAccess_kindzIRRISCV_strong_accesszK, '`11 143:29-143:97', 'zz47')
i9.prevvalues[4] = i41
block16.next = Goto(block2, None)
i42 = block17.emit(Operation, '@eq', [EnumConstant('zRead_RISCV_reserved_acquire', Enum('zread_kind', ('zRead_plain', 'zRead_ifetch', 'zRead_RISCV_acquire', 'zRead_RISCV_strong_acquire', 'zRead_RISCV_reserved', 'zRead_RISCV_reserved_acquire', 'zRead_RISCV_reserved_strong_acquire'))), zrk], Bool(), '`11 144:6-144:33', None)
block17.next = ConditionalGoto(i42, block18, block19, '`11 144:6-144:33')
i43 = block18.emit(StructConstruction, 'zExplicit_access_kind', [EnumConstant('zAS_rel_or_acq', Enum('zAccess_strength', ('zAS_normal', 'zAS_rel_or_acq', 'zAS_acq_rcpc'))), EnumConstant('zAV_exclusive', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zExplicit_access_kind, None, None)
i44 = block18.emit(Operation, 'zAK_explicitzIRRISCV_strong_accesszK', [i43], zAccess_kindzIRRISCV_strong_accesszK, '`11 144:37-144:109', 'zz47')
i9.prevvalues[5] = i44
block18.next = Goto(block2, None)
i45 = block19.emit(StructConstruction, 'zRISCV_strong_access', [EnumConstant('zAV_exclusive', Enum('zAccess_variety', ('zAV_plain', 'zAV_exclusive', 'zAV_atomic_rmw')))], zRISCV_strong_access, None, None)
i46 = block19.emit(Operation, 'zAK_archzIRRISCV_strong_accesszK', [i45], zAccess_kindzIRRISCV_strong_accesszK, '`11 145:44-145:86', 'zz47')
i9.prevvalues[6] = i46
block19.next = Goto(block2, None)
graph = Graph('zread_ram_specialized_o_o_2_False', [zrk, zaddr, zwidth, zread_meta], block0)
""")


def test_unpack_through_phi():
    ztuplez3z5i64_z5string = Struct('ztuplez3z5i64_z5string', ('ztuplez3z5i64_z5string0', 'ztuplez3z5i64_z5string1'), (MachineInt(), String()), True)
    zoptionzIszK = Union('zoptionzIszK', ('zNonezIszK', 'zSomezIszK'), (Unit(), String()))
    zargz3 = Argument('zargz3', SmallFixedBitVector(8))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    i1 = block0.emit(Comment, 'inlined zhex_bits_signed_forwards_matches', [], Unit(), None, None)
    i2 = block0.emit(Comment, 'inlined zhex_bits_signed_forwards', [], Unit(), None, None)
    i3 = block0.emit(Operation, '@signed_bv', [zargz3, MachineIntConstant(8)], MachineInt(), '`4 80:5-80:15', 'zz411')
    i4 = block0.emit(Operation, '@lt', [i3, MachineIntConstant(0)], Bool(), '`4 80:5-80:19', 'zz40')
    i5 = block0.emit(Allocate, '$allocate', [], ztuplez3z5i64_z5string, '`4 112:51-112:72', None)
    block0.next = ConditionalGoto(i4, block1, block8, '`4 80:2-82:42')
    i6 = block1.emit(Operation, '@not_vec_bv', [zargz3, MachineIntConstant(8)], SmallFixedBitVector(8), '`4 81:53-81:64', None)
    i7 = block1.emit(Operation, '@add_bits_int_bv_i', [i6, MachineIntConstant(8), MachineIntConstant(1)], SmallFixedBitVector(8), '`4 81:53-81:68', 'zz45')
    i8 = block1.emit(Operation, '@unsigned_bv', [i7, MachineIntConstant(8)], MachineInt(), '`4 81:44-81:69', 'zz44')
    i9 = block1.emit(Operation, 'int64_to_int', [i8], Int(), '`4 81:44-81:69', None)
    i10 = block1.emit(Operation, 'hex_str', [i9], String(), '`4 81:36-81:70', 'zz43')
    i11 = block1.emit(Operation, 'concat_str', [StringConstant('-'), i10], String(), '`4 81:20-81:71', 'zz42')
    i12 = block1.emit(Operation, '@pack_machineint', [MachineIntConstant(8)], Packed(Int()), None, None)
    block1.next = Goto(block2, None)
    i13 = block2.emit_phi([block8, block1], [None, i12], Packed(Int()))
    i14 = block2.emit_phi([block8, block1], [None, i11], String())
    i15 = block2.emit(UnpackPackedField, '$unpack', [i13], Int(), None, None)
    i16 = block2.emit(Operation, 'int_to_int64', [i15], MachineInt(), '`355', None)
    i17 = block2.emit(FieldWrite, 'ztuplez3z5i64_z5string0', [i5, i16], Unit(), '`355', None)
    i18 = block2.emit(FieldWrite, 'ztuplez3z5i64_z5string1', [i5, i14], Unit(), '`356', None)
    i19 = block2.emit(Operation, '@eq', [i16, MachineIntConstant(8)], Bool(), '`361', 'zz412')
    block2.next = ConditionalGoto(i19, block3, block7, '`4 112:51-112:72')
    i20 = block3.emit(Operation, 'zSomezIszK', [i14], zoptionzIszK, '`362', 'zz48')
    block3.next = Goto(block4, None)
    i21 = block4.emit_phi([block3, block7], [BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
    i22 = block4.emit_phi([block3, block7], [i20, None], zoptionzIszK)
    block4.next = ConditionalGoto(i21, block5, block6, '`367')
    block5.next = Raise(StringConstant('match'), '`371')
    i23 = block6.emit(UnionCast, 'zSomezIszK', [i22], String(), None, None)
    block6.next = Return(i23, None)
    i24 = block7.emit(Operation, 'zNonezIszK', [UnitConstant.UNIT], zoptionzIszK, '`363', 'zz48')
    i22.prevvalues[1] = i24
    block7.next = Goto(block4, None)
    i25 = block8.emit(Operation, '@unsigned_bv', [zargz3, MachineIntConstant(8)], MachineInt(), '`4 82:28-82:40', 'zz410')
    i26 = block8.emit(Operation, 'int64_to_int', [i25], Int(), '`4 82:28-82:40', None)
    i27 = block8.emit(Operation, 'hex_str', [i26], String(), '`4 82:20-82:41', 'zz49')
    i14.prevvalues[0] = i27
    i28 = block8.emit(Operation, '@pack_machineint', [MachineIntConstant(8)], Packed(Int()), None, None)
    i13.prevvalues[0] = i28
    block8.next = Goto(block2, None)
    graph = Graph('zhex_bits_signed_8_forwards', [zargz3], block0)
    check_optimize(graph, '''
ztuplez3z5i64_z5string = Struct('ztuplez3z5i64_z5string', ('ztuplez3z5i64_z5string0', 'ztuplez3z5i64_z5string1'), (MachineInt(), String()), True)
zargz3 = Argument('zargz3', SmallFixedBitVector(8))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
i1 = block0.emit(Comment, 'inlined zhex_bits_signed_forwards_matches', [], Unit(), None, None)
i2 = block0.emit(Comment, 'inlined zhex_bits_signed_forwards', [], Unit(), None, None)
i3 = block0.emit(Operation, '@signed_bv', [zargz3, MachineIntConstant(8)], MachineInt(), '`4 80:5-80:15', 'zz411')
i4 = block0.emit(Operation, '@lt', [i3, MachineIntConstant(0)], Bool(), '`4 80:5-80:19', 'zz40')
i5 = block0.emit(Allocate, '$allocate', [], ztuplez3z5i64_z5string, '`4 112:51-112:72', None)
block0.next = ConditionalGoto(i4, block1, block3, '`4 80:2-82:42')
i6 = block1.emit(Operation, '@not_vec_bv', [zargz3, MachineIntConstant(8)], SmallFixedBitVector(8), '`4 81:53-81:64', None)
i7 = block1.emit(Operation, '@add_bits_int_bv_i', [i6, MachineIntConstant(8), MachineIntConstant(1)], SmallFixedBitVector(8), '`4 81:53-81:68', 'zz45')
i8 = block1.emit(Operation, '@unsigned_bv', [i7, MachineIntConstant(8)], MachineInt(), '`4 81:44-81:69', 'zz44')
i9 = block1.emit(Operation, 'int64_to_int', [i8], Int(), '`4 81:44-81:69', None)
i10 = block1.emit(Operation, 'hex_str', [i9], String(), '`4 81:36-81:70', 'zz43')
i11 = block1.emit(Operation, 'concat_str', [StringConstant('-'), i10], String(), '`4 81:20-81:71', 'zz42')
block1.next = Goto(block2, None)
i12 = block2.emit_phi([block3, block1], [None, i11], String())
i13 = block2.emit(FieldWrite, 'ztuplez3z5i64_z5string0', [i5, MachineIntConstant(8)], Unit(), '`355', None)
i14 = block2.emit(FieldWrite, 'ztuplez3z5i64_z5string1', [i5, i12], Unit(), '`356', None)
block2.next = Return(i12, None)
i15 = block3.emit(Operation, '@unsigned_bv', [zargz3, MachineIntConstant(8)], MachineInt(), '`4 82:28-82:40', 'zz410')
i16 = block3.emit(Operation, 'int64_to_int', [i15], Int(), '`4 82:28-82:40', None)
i17 = block3.emit(Operation, 'hex_str', [i16], String(), '`4 82:20-82:41', 'zz49')
i12.prevvalues[0] = i17
block3.next = Goto(block2, None)
graph = Graph('zhex_bits_signed_8_forwards', [zargz3], block0)
''')

def test_unpack_pack_smallfixedbitvector_bug():
    zpaddr = Argument('zpaddr', SmallFixedBitVector(32))
    block0 = Block()
    i10 = block0.emit(Operation, '@pack_smallfixedbitvector', [MachineIntConstant(32), zpaddr], Packed(GenericBitVector()), None, None)
    i13 = block0.emit(UnpackPackedField, '$unpack', [i10], GenericBitVector(), None, None)
    block0.next = Return(i13)
    graph = Graph('zf', [zpaddr], block0)
    check_optimize(graph, '''
zpaddr = Argument('zpaddr', SmallFixedBitVector(32))
block0 = Block()
i1 = block0.emit(Cast, '$cast', [zpaddr], GenericBitVector(), None, None)
block0.next = Return(i1, None)
graph = Graph('zf', [zpaddr], block0)
''')

def test_ones():
    zwidth = Argument('zwidth', MachineInt())
    block0 = Block()
    i16 = block0.emit(Operation, '@zeros_i', [zwidth], GenericBitVector(), '`1 326:32-326:45', 'zz40')
    i17 = block0.emit(Operation, 'not_bits', [i16], GenericBitVector(), '`1 326:24-326:46', 'return')
    i19 = block0.emit(Operation, '@zero_extend_o_i_unwrapped_res', [i17, MachineIntConstant(64)], SmallFixedBitVector(64), '`5 87:29-87:51', 'return')
    block0.next = Return(i19)
    graph = Graph('zf', [zwidth], block0)
    check_optimize(graph, '''
zwidth = Argument('zwidth', MachineInt())
block0 = Block()
i1 = block0.emit(Operation, '@ones_zero_extended_unwrapped_res', [zwidth, MachineIntConstant(64)], SmallFixedBitVector(64), '`5 87:29-87:51', 'return')
block0.next = Return(i1, None)
graph = Graph('zf', [zwidth], block0)
''')

def test_lteq_unsigned_add():
    zaddr = Argument('zaddr', SmallFixedBitVector(64))
    zwidth = Argument('zwidth', MachineInt())
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    i2 = block0.emit(Cast, '$cast', [zaddr], GenericBitVector(), '`31 79:21-79:35', 'zz450')
    i3 = block0.emit(Operation, '@unsigned_bv_wrapped_res', [zaddr, MachineIntConstant(64)], Int(), '`31 79:21-79:35', 'zz40')
    i4 = block0.emit(Operation, 'plat_ram_base', [UnitConstant.UNIT], SmallFixedBitVector(64), '`31 80:30-80:46', 'zz448')
    i5 = block0.emit(Operation, '@unsigned_bv_wrapped_res', [i4, MachineIntConstant(64)], Int(), '`31 80:21-80:47', 'zz41')
    i6 = block0.emit(Operation, 'plat_rom_base', [UnitConstant.UNIT], SmallFixedBitVector(64), '`31 81:30-81:46', 'zz446')
    i7 = block0.emit(Operation, '@unsigned_bv_wrapped_res', [i6, MachineIntConstant(64)], Int(), '`31 81:21-81:47', 'zz42')
    i8 = block0.emit(Operation, 'plat_ram_size', [UnitConstant.UNIT], SmallFixedBitVector(64), '`31 82:30-82:46', 'zz444')
    i9 = block0.emit(Operation, '@unsigned_bv_wrapped_res', [i8, MachineIntConstant(64)], Int(), '`31 82:21-82:47', 'zz43')
    i10 = block0.emit(Operation, 'plat_rom_size', [UnitConstant.UNIT], SmallFixedBitVector(64), '`31 83:30-83:46', 'zz442')
    i11 = block0.emit(Operation, '@unsigned_bv_wrapped_res', [i10, MachineIntConstant(64)], Int(), '`31 83:21-83:47', 'zz44')
    i12 = block0.emit(Operation, '@lteq_unsigned64', [i4, zaddr], Bool(), '`31 86:13-86:37', 'zz437')
    block0.next = ConditionalGoto(i12, block1, block4, '`31 86:13-87:69')
    i13 = block1.emit(Comment, 'inlined z__id', [], Unit(), None, None)
    i14 = block1.emit(Operation, '@add_o_i_wrapped_res', [i3, MachineIntConstant(2)], Int(), '`31 87:14-87:35', 'zz439')
    i15 = block1.emit(Operation, 'add_int', [i5, i9], Int(), '`31 87:41-87:68', 'zz440')
    i16 = block1.emit(Operation, 'lteq', [i14, i15], Bool(), '`31 87:13-87:69', 'zz438')
    block1.next = ConditionalGoto(i16, block2, block4, '`31 86:2-99:3')
    block2.next = Goto(block3, None)
    i17 = block3.emit_phi([block7, block2], [None, BooleanConstant.TRUE], Bool())
    block3.next = Return(i17, None)
    i18 = block4.emit(Operation, '@lteq_unsigned64', [i6, zaddr], Bool(), '`31 89:13-89:37', 'zz432')
    block4.next = ConditionalGoto(i18, block5, block8, '`31 89:13-90:69')
    i19 = block5.emit(Comment, 'inlined z__id', [], Unit(), None, None)
    i20 = block5.emit(Operation, '@add_o_i_wrapped_res', [i3, MachineIntConstant(2)], Int(), '`31 90:14-90:35', 'zz434')
    i21 = block5.emit(Operation, 'add_int', [i7, i11], Int(), '`31 90:41-90:68', 'zz435')
    i22 = block5.emit(Operation, 'lteq', [i20, i21], Bool(), '`31 90:13-90:69', 'zz433')
    block5.next = ConditionalGoto(i22, block6, block8, '`31 89:7-99:3')
    block6.next = Goto(block7, None)
    i23 = block7.emit_phi([block8, block6], [BooleanConstant.FALSE, BooleanConstant.TRUE], Bool())
    i17.prevvalues[0] = i23
    block7.next = Goto(block3, None)
    i24 = block8.emit(Operation, 'string_of_bits', [i2], String(), '`31 93:41-93:53', 'zz430')
    i27 = block8.emit(Operation, 'print_platform', [i24], Unit(), '`31 93:4-93:80', 'zz428')
    block8.next = Goto(block7, None)
    graph = Graph('zwithin_phys_mem_specialized_o_2', [zaddr, zwidth], block0)
    check_optimize(graph, '''
zaddr = Argument('zaddr', SmallFixedBitVector(64))
zwidth = Argument('zwidth', MachineInt())
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
i2 = block0.emit(Cast, '$cast', [zaddr], GenericBitVector(), '`31 79:21-79:35', 'zz450')
i3 = block0.emit(Operation, 'plat_ram_base', [UnitConstant.UNIT], SmallFixedBitVector(64), '`31 80:30-80:46', 'zz448')
i4 = block0.emit(Operation, 'plat_rom_base', [UnitConstant.UNIT], SmallFixedBitVector(64), '`31 81:30-81:46', 'zz446')
i5 = block0.emit(Operation, 'plat_ram_size', [UnitConstant.UNIT], SmallFixedBitVector(64), '`31 82:30-82:46', 'zz444')
i6 = block0.emit(Operation, 'plat_rom_size', [UnitConstant.UNIT], SmallFixedBitVector(64), '`31 83:30-83:46', 'zz442')
i7 = block0.emit(Operation, '@lteq_unsigned64', [i3, zaddr], Bool(), '`31 86:13-86:37', 'zz437')
block0.next = ConditionalGoto(i7, block1, block4, '`31 86:13-87:69')
i8 = block1.emit(Comment, 'inlined z__id', [], Unit(), None, None)
i9 = block1.emit(Operation, '@lteq_add4_unsigned_bv64', [zaddr, SmallBitVectorConstant(0x2, SmallFixedBitVector(64)), i3, i5], Bool(), '`31 87:13-87:69', 'zz438')
block1.next = ConditionalGoto(i9, block2, block4, '`31 86:2-99:3')
block2.next = Goto(block3, None)
i10 = block3.emit_phi([block7, block6, block2], [BooleanConstant.FALSE, BooleanConstant.TRUE, BooleanConstant.TRUE], Bool())
block3.next = Return(i10, None)
i11 = block4.emit(Operation, '@lteq_unsigned64', [i4, zaddr], Bool(), '`31 89:13-89:37', 'zz432')
block4.next = ConditionalGoto(i11, block5, block7, '`31 89:13-90:69')
i12 = block5.emit(Comment, 'inlined z__id', [], Unit(), None, None)
i13 = block5.emit(Operation, '@lteq_add4_unsigned_bv64', [zaddr, SmallBitVectorConstant(0x2, SmallFixedBitVector(64)), i4, i6], Bool(), '`31 90:13-90:69', 'zz433')
block5.next = ConditionalGoto(i13, block6, block7, '`31 89:7-99:3')
block6.next = Goto(block3, None)
i14 = block7.emit(Operation, 'string_of_bits', [i2], String(), '`31 93:41-93:53', 'zz430')
i15 = block7.emit(Operation, 'print_platform', [i14], Unit(), '`31 93:4-93:80', 'zz428')
block7.next = Goto(block3, None)
graph = Graph('zwithin_phys_mem_specialized_o_2', [zaddr, zwidth], block0)
''')

def test_lookup_tlb():
    zoptionzIRTLB_EntryzK = Union('zoptionzIRTLB_EntryzK', ('zNonezIRTLB_EntryzK', 'zSomezIRTLB_EntryzK'), (Unit(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))))
    zTLB_Entry = Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))
    ztuplez3z5i_z5structz0zzTLB_Entry = Struct('ztuplez3z5i_z5structz0zzTLB_Entry', ('ztuplez3z5i_z5structz0zzTLB_Entry0', 'ztuplez3z5i_z5structz0zzTLB_Entry1'), (Int(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))), True)
    zoptionzIz8izCRTLB_Entryz9zK = Union('zoptionzIz8izCRTLB_Entryz9zK', ('zNonezIz8izCRTLB_Entryz9zK', 'zSomezIz8izCRTLB_Entryz9zK'), (Unit(), Struct('ztuplez3z5i_z5structz0zzTLB_Entry', ('ztuplez3z5i_z5structz0zzTLB_Entry0', 'ztuplez3z5i_z5structz0zzTLB_Entry1'), (Int(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))), True)))
    zasid = Argument('zasid', SmallFixedBitVector(16))
    zvaddr = Argument('zvaddr', SmallFixedBitVector(64))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    i2 = block0.emit(Comment, 'inlined ztlb_hash', [], Unit(), None, None)
    i3 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zvaddr, MachineIntConstant(17), MachineIntConstant(12)], SmallFixedBitVector(6), '`36 49:11-49:26', 'zz46')
    i4 = block0.emit(Operation, '@unsigned_bv', [i3, MachineIntConstant(6)], MachineInt(), '`36 49:2-49:27', 'zz42')
    i5 = block0.emit(GlobalRead, 'ztlb', [], FVec(64, Union('zoptionzIRTLB_EntryzK', ('zNonezIRTLB_EntryzK', 'zSomezIRTLB_EntryzK'), (Unit(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))))), None, None)
    i6 = block0.emit(Cast, '$cast', [i5], Vec(Union('zoptionzIRTLB_EntryzK', ('zNonezIRTLB_EntryzK', 'zSomezIRTLB_EntryzK'), (Unit(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))))), '`36 85:8-85:18', 'zz46')
    i7 = block0.emit(Operation, '@vector_access_o_i', [i6, i4], zoptionzIRTLB_EntryzK, '`36 85:8-85:18', 'zz41')
    i8 = block0.emit(UnionVariantCheck, 'zNonezIRTLB_EntryzK', [i7], Bool(), '`36 86:4-86:10', None)
    block0.next = ConditionalGoto(i8, block1, block8, '`36 86:4-86:10')
    i9 = block1.emit(UnionCast, 'zSomezIRTLB_EntryzK', [i7], zTLB_Entry, None, None)
    i10 = block1.emit(StructCopy, 'zTLB_Entry', [i9], zTLB_Entry, '`36 87:9-87:14', None)
    i11 = block1.emit(Comment, 'inlined zmatch_TLB_Entry', [], Unit(), None, None)
    i12 = block1.emit(FieldAccess, 'zglobal', [i10], Bool(), None, None)
    block1.next = ConditionalGoto(i12, block2, block7, '`36 66:3-66:34')
    i13 = block2.emit(FieldAccess, 'zvAddr', [i10], SmallFixedBitVector(64), None, None)
    i14 = block2.emit(FieldAccess, 'zvMatchMask', [i10], SmallFixedBitVector(64), None, None)
    i15 = block2.emit(Operation, '@and_vec_bv_bv', [i14, zvaddr], SmallFixedBitVector(64), '`36 67:19-67:41', 'zz49')
    i16 = block2.emit(Operation, '@eq_bits_bv_bv', [i13, i15], Bool(), '`36 67:5-67:42', 'zz41')
    block2.next = ConditionalGoto(i16, block3, block6, '`36 87:19-87:95')
    i17 = block3.emit(Operation, '@pack_machineint', [i4], Packed(Int()), None, None)
    i18 = block3.emit(Allocate, '$allocate', [], ztuplez3z5i_z5structz0zzTLB_Entry, '`36 87:63-87:83', None)
    i19 = block3.emit(FieldWrite, 'ztuplez3z5i_z5structz0zzTLB_Entry0', [i18, i17], Unit(), None, None)
    i20 = block3.emit(FieldWrite, 'ztuplez3z5i_z5structz0zzTLB_Entry1', [i18, i10], Unit(), None, None)
    i21 = block3.emit(Operation, 'zSomezIz8izCRTLB_Entryz9zK', [i18], zoptionzIz8izCRTLB_Entryz9zK, '`36 87:63-87:83', 'zz42')
    block3.next = Goto(block4, None)
    i22 = block4.emit_phi([block6, block3], [None, i21], zoptionzIz8izCRTLB_Entryz9zK)
    block4.next = Goto(block5, None)
    i23 = block5.emit_phi([block8, block4], [None, i22], zoptionzIz8izCRTLB_Entryz9zK)
    block5.next = Return(i23, None)
    i24 = block6.emit(Operation, 'zNonezIz8izCRTLB_Entryz9zK', [UnitConstant.UNIT], zoptionzIz8izCRTLB_Entryz9zK, '`36 87:89-87:95', 'zz42')
    i22.prevvalues[0] = i24
    block6.next = Goto(block4, None)
    i25 = block7.emit(FieldAccess, 'zasid', [i10], SmallFixedBitVector(16), None, None)
    i26 = block7.emit(Operation, '@eq_bits_bv_bv', [i25, zasid], Bool(), '`36 66:17-66:33', 'zz411')
    block7.next = ConditionalGoto(i26, block2, block6, '`36 66:2-67:43')
    i27 = block8.emit(Operation, 'zNonezIz8izCRTLB_Entryz9zK', [UnitConstant.UNIT], zoptionzIz8izCRTLB_Entryz9zK, '`36 86:14-86:20', 'zz42')
    i23.prevvalues[0] = i27
    block8.next = Goto(block5, None)
    graph = Graph('zlookup_TLB', [zasid, zvaddr], block0)
    check_optimize(graph, '''
zoptionzIRTLB_EntryzK = Union('zoptionzIRTLB_EntryzK', ('zNonezIRTLB_EntryzK', 'zSomezIRTLB_EntryzK'), (Unit(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))))
zTLB_Entry = Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))
ztuplez3z5i_z5structz0zzTLB_Entry = Struct('ztuplez3z5i_z5structz0zzTLB_Entry', ('ztuplez3z5i_z5structz0zzTLB_Entry0', 'ztuplez3z5i_z5structz0zzTLB_Entry1'), (Int(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))), True)
zoptionzIz8izCRTLB_Entryz9zK = Union('zoptionzIz8izCRTLB_Entryz9zK', ('zNonezIz8izCRTLB_Entryz9zK', 'zSomezIz8izCRTLB_Entryz9zK'), (Unit(), Struct('ztuplez3z5i_z5structz0zzTLB_Entry', ('ztuplez3z5i_z5structz0zzTLB_Entry0', 'ztuplez3z5i_z5structz0zzTLB_Entry1'), (Int(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))), True)))
zasid = Argument('zasid', SmallFixedBitVector(16))
zvaddr = Argument('zvaddr', SmallFixedBitVector(64))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
i2 = block0.emit(Comment, 'inlined ztlb_hash', [], Unit(), None, None)
i3 = block0.emit(Operation, '@vector_subrange_fixed_bv_i_i', [zvaddr, MachineIntConstant(17), MachineIntConstant(12)], SmallFixedBitVector(6), '`36 49:11-49:26', 'zz46')
i4 = block0.emit(Operation, '@unsigned_bv', [i3, MachineIntConstant(6)], MachineInt(), '`36 49:2-49:27', 'zz42')
i5 = block0.emit(GlobalRead, 'ztlb', [], FVec(64, Union('zoptionzIRTLB_EntryzK', ('zNonezIRTLB_EntryzK', 'zSomezIRTLB_EntryzK'), (Unit(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))))), None, None)
i6 = block0.emit(Cast, '$cast', [i5], Vec(Union('zoptionzIRTLB_EntryzK', ('zNonezIRTLB_EntryzK', 'zSomezIRTLB_EntryzK'), (Unit(), Struct('zTLB_Entry', ('zage', 'zasid', 'zglobal', 'zpAddr', 'zpte', 'zpteAddr', 'zvAddr', 'zvAddrMask', 'zvMatchMask'), (SmallFixedBitVector(64), SmallFixedBitVector(16), Bool(), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64), SmallFixedBitVector(64)))))), '`36 85:8-85:18', 'zz46')
i7 = block0.emit(Operation, '@vector_access_o_i', [i6, i4], zoptionzIRTLB_EntryzK, '`36 85:8-85:18', 'zz41')
i8 = block0.emit(UnionVariantCheck, 'zNonezIRTLB_EntryzK', [i7], Bool(), '`36 86:4-86:10', None)
block0.next = ConditionalGoto(i8, block1, block7, '`36 86:4-86:10')
i9 = block1.emit(UnionCast, 'zSomezIRTLB_EntryzK', [i7], zTLB_Entry, None, None)
i10 = block1.emit(Comment, 'inlined zmatch_TLB_Entry', [], Unit(), None, None)
i11 = block1.emit(FieldAccess, 'zglobal', [i9], Bool(), None, None)
block1.next = ConditionalGoto(i11, block2, block6, '`36 66:3-66:34')
i12 = block2.emit(FieldAccess, 'zvAddr', [i9], SmallFixedBitVector(64), None, None)
i13 = block2.emit(FieldAccess, 'zvMatchMask', [i9], SmallFixedBitVector(64), None, None)
i14 = block2.emit(Operation, '@and_vec_bv_bv', [i13, zvaddr], SmallFixedBitVector(64), '`36 67:19-67:41', 'zz49')
i15 = block2.emit(Operation, '@eq_bits_bv_bv', [i12, i14], Bool(), '`36 67:5-67:42', 'zz41')
block2.next = ConditionalGoto(i15, block3, block5, '`36 87:19-87:95')
i16 = block3.emit(Operation, '@pack_machineint', [i4], Packed(Int()), None, None)
i17 = block3.emit(Allocate, '$allocate', [], ztuplez3z5i_z5structz0zzTLB_Entry, '`36 87:63-87:83', None)
i18 = block3.emit(FieldWrite, 'ztuplez3z5i_z5structz0zzTLB_Entry0', [i17, i16], Unit(), None, None)
i19 = block3.emit(FieldWrite, 'ztuplez3z5i_z5structz0zzTLB_Entry1', [i17, i9], Unit(), None, None)
i20 = block3.emit(Operation, 'zSomezIz8izCRTLB_Entryz9zK', [i17], zoptionzIz8izCRTLB_Entryz9zK, '`36 87:63-87:83', 'zz42')
block3.next = Goto(block4, None)
i21 = block4.emit_phi([block7, block5, block3], [None, None, i20], zoptionzIz8izCRTLB_Entryz9zK)
block4.next = Return(i21, None)
i22 = block5.emit(Operation, 'zNonezIz8izCRTLB_Entryz9zK', [UnitConstant.UNIT], zoptionzIz8izCRTLB_Entryz9zK, '`36 87:89-87:95', 'zz42')
i21.prevvalues[1] = i22
block5.next = Goto(block4, None)
i23 = block6.emit(FieldAccess, 'zasid', [i9], SmallFixedBitVector(16), None, None)
i24 = block6.emit(Operation, '@eq_bits_bv_bv', [i23, zasid], Bool(), '`36 66:17-66:33', 'zz411')
block6.next = ConditionalGoto(i24, block2, block5, '`36 66:2-67:43')
i25 = block7.emit(Operation, 'zNonezIz8izCRTLB_Entryz9zK', [UnitConstant.UNIT], zoptionzIz8izCRTLB_Entryz9zK, '`36 86:14-86:20', 'zz42')
i21.prevvalues[0] = i25
block7.next = Goto(block4, None)
graph = Graph('zlookup_TLB', [zasid, zvaddr], block0)
''')

def test_redundant_struct_construction():
    ztuplez3z5bv5_z5bv5 = Struct('ztuplez3z5bv5_z5bv5', ('ztuplez3z5bv5_z5bv50', 'ztuplez3z5bv5_z5bv51'), (SmallFixedBitVector(5), SmallFixedBitVector(5)), True)
    struct = Argument('struct', ztuplez3z5bv5_z5bv5)
    block0 = Block()
    i2 = block0.emit(FieldAccess, 'ztuplez3z5bv5_z5bv50', [struct], SmallFixedBitVector(5), None, None)
    i3 = block0.emit(FieldAccess, 'ztuplez3z5bv5_z5bv51', [struct], SmallFixedBitVector(5), None, None)
    i4 = block0.emit(StructConstruction, 'ztuplez3z5bv5_z5bv5', [i2, i3], ztuplez3z5bv5_z5bv5, None, None)
    block0.next = Return(i4, None)
    graph = Graph('zexecute_zSINVAL_VMA', [struct], block0)
    check_optimize(graph, """\
ztuplez3z5bv5_z5bv5 = Struct('ztuplez3z5bv5_z5bv5', ('ztuplez3z5bv5_z5bv50', 'ztuplez3z5bv5_z5bv51'), (SmallFixedBitVector(5), SmallFixedBitVector(5)), True)
struct = Argument('struct', ztuplez3z5bv5_z5bv5)
block0 = Block()
block0.next = Return(struct, None)
graph = Graph('zexecute_zSINVAL_VMA', [struct], block0)
""")

def test_structcopy_of_phi():
    zMstatus = Struct('zMstatus', ('zbits',), (SmallFixedBitVector(64),))
    zPrivilege = Enum('zPrivilege', ('zUser', 'zSupervisor', 'zMachine'))
    zSATPMode = Enum('zSATPMode', ('zSbare', 'zSv32', 'zSv39', 'zSv48'))
    ztuplez3z5bv_z5unit = Struct('ztuplez3z5bv_z5unit', ('ztuplez3z5bv_z5unit0', 'ztuplez3z5bv_z5unit1'), (GenericBitVector(), Unit()), True)
    zTR_ResultzIUExceptionTypezIzKzCbzK = Union('zTR_ResultzIUExceptionTypezIzKzCbzK', ('zTR_AddresszIUExceptionTypezIzKzCbzK', 'zTR_FailurezIUExceptionTypezIzKzCbzK'), (Struct('ztuplez3z5bv_z5unit', ('ztuplez3z5bv_z5unit0', 'ztuplez3z5bv_z5unit1'), (GenericBitVector(), Unit()), True), Struct('ztuplez3z5unionz0zzExceptionType_z5unit', ('ztuplez3z5unionz0zzExceptionType_z5unit0', 'ztuplez3z5unionz0zzExceptionType_z5unit1'), (Union('zExceptionType', ('zE_Breakpoint', 'zE_Extension', 'zE_Fetch_Access_Fault', 'zE_Fetch_Addr_Align', 'zE_Fetch_Page_Fault', 'zE_Illegal_Instr', 'zE_Load_Access_Fault', 'zE_Load_Addr_Align', 'zE_Load_Page_Fault', 'zE_M_EnvCall', 'zE_Reserved_10', 'zE_Reserved_14', 'zE_SAMO_Access_Fault', 'zE_SAMO_Addr_Align', 'zE_SAMO_Page_Fault', 'zE_S_EnvCall', 'zE_U_EnvCall'), (Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit())), Unit()), True)))
    zSV_Params = Struct('zSV_Params', ('zlevels', 'zlog_pte_sizze_bytes', 'zpte_PPN_j_sizze_bits', 'zpte_PPNs_lsb_index', 'zpte_PPNs_sizze_bits', 'zpte_msbs_lsb_index', 'zpte_msbs_sizze_bits', 'zva_sizze_bits', 'zvpn_sizze_bits'), (MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt()))
    zTR_ResultzIUPTW_ErrorzIzKzCbzK = Union('zTR_ResultzIUPTW_ErrorzIzKzCbzK', ('zTR_AddresszIUPTW_ErrorzIzKzCbzK', 'zTR_FailurezIUPTW_ErrorzIzKzCbzK'), (Struct('ztuplez3z5bv_z5unit', ('ztuplez3z5bv_z5unit0', 'ztuplez3z5bv_z5unit1'), (GenericBitVector(), Unit()), True), Struct('ztuplez3z5unionz0zzPTW_Error_z5unit', ('ztuplez3z5unionz0zzPTW_Error_z5unit0', 'ztuplez3z5unionz0zzPTW_Error_z5unit1'), (Union('zPTW_Error', ('zPTW_Access', 'zPTW_Ext_Error', 'zPTW_Invalid_Addr', 'zPTW_Invalid_PTE', 'zPTW_Misaligned', 'zPTW_No_Permission', 'zPTW_PTE_Update'), (Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit())), Unit()), True)))
    ztuplez3z5unionz0zzPTW_Error_z5unit = Struct('ztuplez3z5unionz0zzPTW_Error_z5unit', ('ztuplez3z5unionz0zzPTW_Error_z5unit0', 'ztuplez3z5unionz0zzPTW_Error_z5unit1'), (Union('zPTW_Error', ('zPTW_Access', 'zPTW_Ext_Error', 'zPTW_Invalid_Addr', 'zPTW_Invalid_PTE', 'zPTW_Misaligned', 'zPTW_No_Permission', 'zPTW_PTE_Update'), (Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit())), Unit()), True)
    zPTW_Error = Union('zPTW_Error', ('zPTW_Access', 'zPTW_Ext_Error', 'zPTW_Invalid_Addr', 'zPTW_Invalid_PTE', 'zPTW_Misaligned', 'zPTW_No_Permission', 'zPTW_PTE_Update'), (Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit()))
    zExceptionType = Union('zExceptionType', ('zE_Breakpoint', 'zE_Extension', 'zE_Fetch_Access_Fault', 'zE_Fetch_Addr_Align', 'zE_Fetch_Page_Fault', 'zE_Illegal_Instr', 'zE_Load_Access_Fault', 'zE_Load_Addr_Align', 'zE_Load_Page_Fault', 'zE_M_EnvCall', 'zE_Reserved_10', 'zE_Reserved_14', 'zE_SAMO_Access_Fault', 'zE_SAMO_Addr_Align', 'zE_SAMO_Page_Fault', 'zE_S_EnvCall', 'zE_U_EnvCall'), (Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit()))
    ztuplez3z5unionz0zzExceptionType_z5unit = Struct('ztuplez3z5unionz0zzExceptionType_z5unit', ('ztuplez3z5unionz0zzExceptionType_z5unit0', 'ztuplez3z5unionz0zzExceptionType_z5unit1'), (Union('zExceptionType', ('zE_Breakpoint', 'zE_Extension', 'zE_Fetch_Access_Fault', 'zE_Fetch_Addr_Align', 'zE_Fetch_Page_Fault', 'zE_Illegal_Instr', 'zE_Load_Access_Fault', 'zE_Load_Addr_Align', 'zE_Load_Page_Fault', 'zE_M_EnvCall', 'zE_Reserved_10', 'zE_Reserved_14', 'zE_SAMO_Access_Fault', 'zE_SAMO_Addr_Align', 'zE_SAMO_Page_Fault', 'zE_S_EnvCall', 'zE_U_EnvCall'), (Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit(), Unit())), Unit()), True)
    zvAddr = Argument('zvAddr', SmallFixedBitVector(64))
    b1 = Argument('b1', Bool)
    b2 = Argument('b2', Bool)
    block0 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block9 = Block()
    block10 = Block()
    block12 = Block()
    block14 = Block()
    block15 = Block()
    block16 = Block()
    block0.next = ConditionalGoto(b1, block4, block14, '`37 418:4-418:8')
    i15 = block4.emit(StructConstruction, 'zSV_Params', [MachineIntConstant(2), MachineIntConstant(2), MachineIntConstant(10), MachineIntConstant(10), MachineIntConstant(22), MachineIntConstant(32), MachineIntConstant(0), MachineIntConstant(32), MachineIntConstant(10)], zSV_Params, '`33 39:4-39:15', None)
    block4.next = Goto(block5, None)
    i17 = block5.emit_phi([block4, block15, block16], [i15, None, None], zSV_Params)
    i18 = block5.emit(StructCopy, 'zSV_Params', [i17], zSV_Params, '`37 416:17-416:26', None)
    block5.next = Return(i18)
    block14.next = ConditionalGoto(b2, block15, block16, '`37 419:4-419:8')
    i70 = block15.emit(StructConstruction, 'zSV_Params', [MachineIntConstant(3), MachineIntConstant(3), MachineIntConstant(9), MachineIntConstant(10), MachineIntConstant(44), MachineIntConstant(54), MachineIntConstant(10), MachineIntConstant(39), MachineIntConstant(9)], zSV_Params, '`33 55:4-55:15', None)
    i17.prevvalues[1] = i70
    block15.next = Goto(block5, None)
    i76 = block16.emit(StructConstruction, 'zSV_Params', [MachineIntConstant(4), MachineIntConstant(3), MachineIntConstant(9), MachineIntConstant(10), MachineIntConstant(44), MachineIntConstant(54), MachineIntConstant(10), MachineIntConstant(48), MachineIntConstant(9)], zSV_Params, '`33 71:4-71:15', None)
    i17.prevvalues[2] = i76
    block16.next = Goto(block5, None)
    graph = Graph('ztranslateAddr', [zvAddr, b1, b2], block0)
    check_optimize(graph, '''
zSV_Params = Struct('zSV_Params', ('zlevels', 'zlog_pte_sizze_bytes', 'zpte_PPN_j_sizze_bits', 'zpte_PPNs_lsb_index', 'zpte_PPNs_sizze_bits', 'zpte_msbs_lsb_index', 'zpte_msbs_sizze_bits', 'zva_sizze_bits', 'zvpn_sizze_bits'), (MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt(), MachineInt()))
zvAddr = Argument('zvAddr', SmallFixedBitVector(64))
b1 = Argument('b1', <class 'pydrofoil.types.Bool'>)
b2 = Argument('b2', <class 'pydrofoil.types.Bool'>)
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block0.next = ConditionalGoto(b1, block1, block3, '`37 418:4-418:8')
i3 = block1.emit(StructConstruction, 'zSV_Params', [MachineIntConstant(2), MachineIntConstant(2), MachineIntConstant(10), MachineIntConstant(10), MachineIntConstant(22), MachineIntConstant(32), MachineIntConstant(0), MachineIntConstant(32), MachineIntConstant(10)], zSV_Params, '`33 39:4-39:15', None)
block1.next = Goto(block2, None)
i4 = block2.emit_phi([block1, block4, block5], [i3, None, None], zSV_Params)
block2.next = Return(i4, None)
block3.next = ConditionalGoto(b2, block4, block5, '`37 419:4-419:8')
i5 = block4.emit(StructConstruction, 'zSV_Params', [MachineIntConstant(3), MachineIntConstant(3), MachineIntConstant(9), MachineIntConstant(10), MachineIntConstant(44), MachineIntConstant(54), MachineIntConstant(10), MachineIntConstant(39), MachineIntConstant(9)], zSV_Params, '`33 55:4-55:15', None)
i4.prevvalues[1] = i5
block4.next = Goto(block2, None)
i6 = block5.emit(StructConstruction, 'zSV_Params', [MachineIntConstant(4), MachineIntConstant(3), MachineIntConstant(9), MachineIntConstant(10), MachineIntConstant(44), MachineIntConstant(54), MachineIntConstant(10), MachineIntConstant(48), MachineIntConstant(9)], zSV_Params, '`33 71:4-71:15', None)
i4.prevvalues[2] = i6
block5.next = Goto(block2, None)
graph = Graph('ztranslateAddr', [zvAddr, b1, b2], block0)
''')

def test_int_to_int64_of_packed():
    structtyp = Struct('structtyp', ('f', ), (Int(), ), True)
    struct = Argument('struct', structtyp)
    block0 = Block()
    i0 = block0.emit(FieldAccess, 'f', [struct], Packed(Int()), None, None)
    i1 = block0.emit(UnpackPackedField, '$unpack', [i0], Int(), None, None)
    i2 = block0.emit(Operation, 'int_to_int64', [i1], MachineInt(), '`37 397:9-397:14', 'zz42')
    block0.next = Return(i2)

    graph = Graph('f', [struct], block0)
    check_optimize(graph, '''
structtyp = Struct('structtyp', ('f',), (Int(),), True)
struct = Argument('struct', structtyp)
block0 = Block()
i1 = block0.emit(FieldAccess, 'f', [struct], Packed(Int()), None, None)
i2 = block0.emit(Operation, '@packed_field_int_to_int64', [i1], MachineInt(), '`37 397:9-397:14', 'zz42')
block0.next = Return(i2, None)
graph = Graph('f', [struct], block0)
''')

def test_shift_bits():
    for before, after in [("shift_bits_left", "shiftl_bv_i"), ("shift_bits_right", "shiftr_bv_i")]:
        a = Argument('a', SmallFixedBitVector(32))
        b = Argument('b', SmallFixedBitVector(5))
        block0 = Block()
        i10 = block0.emit(Cast, '$cast', [a], GenericBitVector(), None, None)
        i27 = block0.emit(Cast, '$cast', [b], GenericBitVector(), None, None)
        i28 = block0.emit(Operation, before, [i10, i27], GenericBitVector(), '`39 465:18-465:44', 'zz414858')
        i29 = block0.emit(Cast, '$cast', [i28], SmallFixedBitVector(32), '`39 465:18-465:44', 'zz414841')
        block0.next = Return(i29)
        graph = Graph('f', [a, b], block0)
        check_optimize(graph, '''
a = Argument('a', SmallFixedBitVector(32))
b = Argument('b', SmallFixedBitVector(5))
block0 = Block()
i2 = block0.emit(Operation, '@unsigned_bv', [b, MachineIntConstant(5)], MachineInt(), None, None)
i3 = block0.emit(Operation, '@%s', [a, MachineIntConstant(32), i2], SmallFixedBitVector(32), '`39 465:18-465:44', 'zz414858')
block0.next = Return(i3, None)
graph = Graph('f', [a, b], block0)
''' % after)


def test_packed_int_to_int64_of_pack_machineint():
    block0 = Block()
    i6 = block0.emit(Operation, '@pack_machineint', [MachineIntConstant(2)], Packed(Int()), None, None)
    i7 = block0.emit(Operation, '@packed_field_int_to_int64', [i6], MachineInt(), '`14', None)
    block0.next = Return(i7)
    graph = Graph('f', [], block0)
    check_optimize(graph, '''
block0 = Block()
block0.next = Return(MachineIntConstant(2), None)
graph = Graph('f', [], block0)
''')


def test_union_check_switch():
    zoptionzIszK = Union('zoptionzIszK', ('zNonezIszK', 'zSomezIszK'), (Unit(), String()))
    ztuplez3z5i_z5string = Struct('ztuplez3z5i_z5string', ('ztuplez3z5i_z5string0', 'ztuplez3z5i_z5string1'), (Int(), String()), True)
    ztuplez3z5i64_z5string = Struct('ztuplez3z5i64_z5string', ('ztuplez3z5i64_z5string0', 'ztuplez3z5i64_z5string1'), (MachineInt(), String()), True)
    zargz3 = Argument('zargz3', SmallFixedBitVector(6))
    block0 = Block()
    block1 = Block()
    block2 = Block()
    block3 = Block()
    block4 = Block()
    block5 = Block()
    block6 = Block()
    block7 = Block()
    block8 = Block()
    block9 = Block()
    block10 = Block()
    i1 = block0.emit(Cast, '$cast', [zargz3], GenericBitVector(), '`317', 'zz416')
    i2 = block0.emit(Comment, 'inlined zhex_bits_signed_forwards_matches', [], Unit(), None, None)
    i3 = block0.emit(Operation, '@not', [BooleanConstant.TRUE], Bool(), '`319', None)
    block0.next = ConditionalGoto(i3, block1, block5, '`319')
    i4 = block1.emit(Operation, 'zNonezIszK', [UnitConstant.UNIT], zoptionzIszK, '`333', 'zz44')
    block1.next = Goto(block2, None)
    i5 = block2.emit_phi([block9, block8, block1], [None, None, i4], zoptionzIszK)
    i6 = block2.emit(UnionVariantCheck, 'zSomezIszK', [i5], Bool(), '`336', None)
    block2.next = ConditionalGoto(i6, block3, block4, '`336')
    block3.next = Raise(StringConstant('match'), '`340')
    i7 = block4.emit(UnionCast, 'zSomezIszK', [i5], String(), None, None)
    block4.next = Return(i7, None)
    i8 = block5.emit(Cast, '$cast', [zargz3], GenericBitVector(), '`321', 'zz414')
    i9 = block5.emit(Comment, 'inlined zhex_bits_signed_forwards', [], Unit(), None, None)
    i10 = block5.emit(Operation, 'zsigned', [i8], Int(), '`4 80:5-80:15', 'zz411')
    i11 = block5.emit(Operation, 'zlt_int', [i10, IntConstant(0)], Bool(), '`4 80:5-80:19', 'zz40')
    block5.next = ConditionalGoto(i11, block6, block10, '`4 80:2-82:42')
    i12 = block6.emit(Operation, '@length_unwrapped_res', [i8], MachineInt(), '`4 81:8-81:18', 'zz41')
    i13 = block6.emit(Operation, 'znot_vec', [i8], GenericBitVector(), '`4 81:53-81:64', 'zz46')
    i14 = block6.emit(Operation, 'zadd_bits_int', [i13, IntConstant(1)], GenericBitVector(), '`4 81:53-81:68', 'zz45')
    i15 = block6.emit(Operation, 'zunsigned', [i14], Int(), '`4 81:44-81:69', 'zz44')
    i16 = block6.emit(Operation, 'zhex_str', [i15], String(), '`4 81:36-81:70', 'zz43')
    i17 = block6.emit(Operation, 'zconcat_str', [StringConstant('-'), i16], String(), '`4 81:20-81:71', 'zz42')
    i18 = block6.emit(Operation, '@pack_machineint', [i12], Packed(Int()), None, None)
    block6.next = Goto(block7, None)
    i19 = block7.emit_phi([block10, block6], [None, i18], Packed(Int()))
    i20 = block7.emit_phi([block10, block6], [None, i17], String())
    i21 = block7.emit(StructConstruction, 'ztuplez3z5i_z5string', [i19, i20], ztuplez3z5i_z5string, None, None)
    i22 = block7.emit(FieldAccess, 'ztuplez3z5i_z5string0', [i21], Packed(Int()), None, None)
    i23 = block7.emit(UnpackPackedField, '$unpack', [i22], Int(), None, None)
    i24 = block7.emit(Operation, 'zz5izDzKz5i64', [i23], MachineInt(), '`324', None)
    i25 = block7.emit(Allocate, '$allocate', [], ztuplez3z5i64_z5string, '`4 110:51-110:72', None)
    i26 = block7.emit(FieldWrite, 'ztuplez3z5i64_z5string0', [i25, i24], Unit(), '`324', None)
    i27 = block7.emit(FieldAccess, 'ztuplez3z5i_z5string1', [i21], String(), None, None)
    i28 = block7.emit(FieldWrite, 'ztuplez3z5i64_z5string1', [i25, i27], Unit(), '`325', None)
    i29 = block7.emit(FieldAccess, 'ztuplez3z5i64_z5string0', [i25], MachineInt(), None, None)
    i30 = block7.emit(FieldAccess, 'ztuplez3z5i64_z5string1', [i25], String(), None, None)
    i31 = block7.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(6)], Int(), '`327', 'zz411')
    i32 = block7.emit(Operation, 'zz5i64zDzKz5i', [i29], Int(), '`329', 'zz413')
    i33 = block7.emit(Operation, 'zeq_int', [i32, i31], Bool(), '`330', 'zz412')
    i34 = block7.emit(Operation, '@not', [i33], Bool(), '`4 110:51-110:72', None)
    block7.next = ConditionalGoto(i34, block8, block9, '`4 110:51-110:72')
    i35 = block8.emit(Operation, 'zNonezIszK', [UnitConstant.UNIT], zoptionzIszK, '`332', 'zz48')
    i5.prevvalues[1] = i35
    block8.next = Goto(block2, None)
    i36 = block9.emit(Operation, 'zSomezIszK', [i30], zoptionzIszK, '`331', 'zz48')
    i5.prevvalues[0] = i36
    block9.next = Goto(block2, None)
    i37 = block10.emit(Operation, '@length_unwrapped_res', [i8], MachineInt(), '`4 82:8-82:18', 'zz48')
    i38 = block10.emit(Operation, 'zunsigned', [i8], Int(), '`4 82:28-82:40', 'zz410')
    i39 = block10.emit(Operation, 'zhex_str', [i38], String(), '`4 82:20-82:41', 'zz49')
    i20.prevvalues[0] = i39
    i40 = block10.emit(Operation, '@pack_machineint', [i37], Packed(Int()), None, None)
    i19.prevvalues[0] = i40
    block10.next = Goto(block7, None)
    graph = Graph('zhex_bits_signed_6_forwards', [zargz3], block0)
    from pydrofoil.optimize import merge_phi_blocks, fix_union_check_switch
    merge_phi_blocks(graph, None)
    fix_union_check_switch(graph, None)
    compare(graph, '''
zoptionzIszK = Union('zoptionzIszK', ('zNonezIszK', 'zSomezIszK'), (Unit(), String()))
ztuplez3z5i_z5string = Struct('ztuplez3z5i_z5string', ('ztuplez3z5i_z5string0', 'ztuplez3z5i_z5string1'), (Int(), String()), True)
ztuplez3z5i64_z5string = Struct('ztuplez3z5i64_z5string', ('ztuplez3z5i64_z5string0', 'ztuplez3z5i64_z5string1'), (MachineInt(), String()), True)
zargz3 = Argument('zargz3', SmallFixedBitVector(6))
block0 = Block()
block1 = Block()
block2 = Block()
block3 = Block()
block4 = Block()
block5 = Block()
block6 = Block()
block7 = Block()
block8 = Block()
block9 = Block()
block10 = Block()
block11 = Block()
i1 = block0.emit(Cast, '$cast', [zargz3], GenericBitVector(), '`317', 'zz416')
i2 = block0.emit(Comment, 'inlined zhex_bits_signed_forwards_matches', [], Unit(), None, None)
i3 = block0.emit(Operation, '@not', [BooleanConstant.TRUE], Bool(), '`319', None)
block0.next = ConditionalGoto(i3, block1, block4, '`319')
i4 = block1.emit(Operation, 'zNonezIszK', [UnitConstant.UNIT], zoptionzIszK, '`333', 'zz44')
block1.next = Goto(block2, None)
i5 = block2.emit_phi([block7, block1], [None, i4], zoptionzIszK)
block2.next = Goto(block3, None)
block3.next = Raise(StringConstant('match'), '`340')
i6 = block4.emit(Cast, '$cast', [zargz3], GenericBitVector(), '`321', 'zz414')
i7 = block4.emit(Comment, 'inlined zhex_bits_signed_forwards', [], Unit(), None, None)
i8 = block4.emit(Operation, 'zsigned', [i6], Int(), '`4 80:5-80:15', 'zz411')
i9 = block4.emit(Operation, 'zlt_int', [i8, IntConstant(0)], Bool(), '`4 80:5-80:19', 'zz40')
block4.next = ConditionalGoto(i9, block5, block11, '`4 80:2-82:42')
i10 = block5.emit(Operation, '@length_unwrapped_res', [i6], MachineInt(), '`4 81:8-81:18', 'zz41')
i11 = block5.emit(Operation, 'znot_vec', [i6], GenericBitVector(), '`4 81:53-81:64', 'zz46')
i12 = block5.emit(Operation, 'zadd_bits_int', [i11, IntConstant(1)], GenericBitVector(), '`4 81:53-81:68', 'zz45')
i13 = block5.emit(Operation, 'zunsigned', [i12], Int(), '`4 81:44-81:69', 'zz44')
i14 = block5.emit(Operation, 'zhex_str', [i13], String(), '`4 81:36-81:70', 'zz43')
i15 = block5.emit(Operation, 'zconcat_str', [StringConstant('-'), i14], String(), '`4 81:20-81:71', 'zz42')
i16 = block5.emit(Operation, '@pack_machineint', [i10], Packed(Int()), None, None)
block5.next = Goto(block6, None)
i17 = block6.emit_phi([block11, block5], [None, i16], Packed(Int()))
i18 = block6.emit_phi([block11, block5], [None, i15], String())
i19 = block6.emit(StructConstruction, 'ztuplez3z5i_z5string', [i17, i18], ztuplez3z5i_z5string, None, None)
i20 = block6.emit(FieldAccess, 'ztuplez3z5i_z5string0', [i19], Packed(Int()), None, None)
i21 = block6.emit(UnpackPackedField, '$unpack', [i20], Int(), None, None)
i22 = block6.emit(Operation, 'zz5izDzKz5i64', [i21], MachineInt(), '`324', None)
i23 = block6.emit(Allocate, '$allocate', [], ztuplez3z5i64_z5string, '`4 110:51-110:72', None)
i24 = block6.emit(FieldWrite, 'ztuplez3z5i64_z5string0', [i23, i22], Unit(), '`324', None)
i25 = block6.emit(FieldAccess, 'ztuplez3z5i_z5string1', [i19], String(), None, None)
i26 = block6.emit(FieldWrite, 'ztuplez3z5i64_z5string1', [i23, i25], Unit(), '`325', None)
i27 = block6.emit(FieldAccess, 'ztuplez3z5i64_z5string0', [i23], MachineInt(), None, None)
i28 = block6.emit(FieldAccess, 'ztuplez3z5i64_z5string1', [i23], String(), None, None)
i29 = block6.emit(Operation, 'zz5i64zDzKz5i', [MachineIntConstant(6)], Int(), '`327', 'zz411')
i30 = block6.emit(Operation, 'zz5i64zDzKz5i', [i27], Int(), '`329', 'zz413')
i31 = block6.emit(Operation, 'zeq_int', [i30, i29], Bool(), '`330', 'zz412')
i32 = block6.emit(Operation, '@not', [i31], Bool(), '`4 110:51-110:72', None)
block6.next = ConditionalGoto(i32, block7, block8, '`4 110:51-110:72')
i33 = block7.emit(Operation, 'zNonezIszK', [UnitConstant.UNIT], zoptionzIszK, '`332', 'zz48')
i5.prevvalues[0] = i33
block7.next = Goto(block2, None)
i34 = block8.emit(Operation, 'zSomezIszK', [i28], zoptionzIszK, '`331', 'zz48')
block8.next = Goto(block9, None)
i35 = block9.emit(UnionVariantCheck, 'zSomezIszK', [i34], Bool(), '`336', None)
block9.next = Goto(block10, None)
i36 = block10.emit(UnionCast, 'zSomezIszK', [i34], String(), None, None)
block10.next = Return(i36, None)
i37 = block11.emit(Operation, '@length_unwrapped_res', [i6], MachineInt(), '`4 82:8-82:18', 'zz48')
i38 = block11.emit(Operation, 'zunsigned', [i6], Int(), '`4 82:28-82:40', 'zz410')
i39 = block11.emit(Operation, 'zhex_str', [i38], String(), '`4 82:20-82:41', 'zz49')
i18.prevvalues[0] = i39
i40 = block11.emit(Operation, '@pack_machineint', [i37], Packed(Int()), None, None)
i17.prevvalues[0] = i40
block11.next = Goto(block6, None)
graph = Graph('zhex_bits_signed_6_forwards', [zargz3], block0)
''')
